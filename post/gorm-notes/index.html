<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta content="yes" name="apple-mobile-web-app-capable" />
<meta content="black" name="apple-mobile-web-app-status-bar-style" />
<meta name="referrer" content="never">
<meta name="keywords" content="">
<meta name="description" content="æ¬¢è¿è®¿é—®[Jinvic&#39;s Blog]çš„ä¸ªäººåšå®¢">
<meta name="author" content="kveln">
<title>GORMé€ŸæŸ¥ç¬”è®° | Jinvic&#39;s Blog</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css">
<link href="https://cdn.bootcss.com/font-awesome/5.11.2/css/all.min.css" rel="stylesheet">
<link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
<link
  href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800'
  rel='stylesheet' type='text/css'>
<link rel="alternate" type="application/rss+xml" title="GORMé€ŸæŸ¥ç¬”è®° | Jinvic&#39;s Blog Â» Feed"
  href="https://jinvic.github.io/atom.xml">
<link rel="stylesheet"
  href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.15.10/build/styles/androidstudio.min.css">
<link href="https://jinvic.github.io/styles/main.css" rel="stylesheet">
<script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets/highlight.min.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/850552586/ericamcdn@0.1/css/live2d.css">

<script>hljs.initHighlightingOnLoad();</script>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-YCF6X0GKYH"></script>
<script>window.dataLayer = window.dataLayer || [];
    function gtag() {
      dataLayer.push(arguments)
    }
    gtag('js', new Date());
    gtag('config', 'G-YCF6X0GKYH');</script>

  <meta property="og:description" content="GORMé€ŸæŸ¥ç¬”è®°" />
  <meta property="og:url" content="https://jinvic.github.io/post/gorm-notes/" />
  <meta property="og:locale" content="zh-CN" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="Jinvic&#39;s Blog" />
  <!-- <script src="../assets/styles/scripts/tocScript.js"></script> -->
</head>

<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
  <div class="container">
    <a class="navbar-brand" href="https://jinvic.github.io">Jinvic&#39;s Blog</a>
    <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse"
      data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false"
      aria-label="Toggle navigation">
      Menu
      <i class="fas fa-bars"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarResponsive">
      <ul class="navbar-nav ml-auto">
        
        <li class="nav-item">
          
          <a class="nav-link" href="/">é¦–é¡µ</a>
          
        </li>
        
        <li class="nav-item">
          
          <a class="nav-link" href="/archives">å½’æ¡£</a>
          
        </li>
        
        <li class="nav-item">
          
          <a class="nav-link" href="/tags">æ ‡ç­¾</a>
          
        </li>
        
        <li class="nav-item">
          
          <a class="nav-link" href="/post/about">å…³äº</a>
          
        </li>
        
        <li class="nav-item">
          <div class="gridea-search-container">
            <form id="gridea-search-form" style="position: relative" data-update="1750747815360"
              action="/search/index.html">
              <input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="æœç´¢æ–‡ç« " />
              <i class="fas fa-search gt-c-content-color-first" style="position: absolute; top: 9px; left: 10px;"></i>
            </form>
          </div>
        </li>
      </ul>
    </div>
  </div>
</nav>
  <!-- Page Header -->
  <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
  <div class="container">
    <a class="navbar-brand" href="https://jinvic.github.io">Jinvic&#39;s Blog</a>
    <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse"
      data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false"
      aria-label="Toggle navigation">
      Menu
      <i class="fas fa-bars"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarResponsive">
      <ul class="navbar-nav ml-auto">
        
        <li class="nav-item">
          
          <a class="nav-link" href="/">é¦–é¡µ</a>
          
        </li>
        
        <li class="nav-item">
          
          <a class="nav-link" href="/archives">å½’æ¡£</a>
          
        </li>
        
        <li class="nav-item">
          
          <a class="nav-link" href="/tags">æ ‡ç­¾</a>
          
        </li>
        
        <li class="nav-item">
          
          <a class="nav-link" href="/post/about">å…³äº</a>
          
        </li>
        
        <li class="nav-item">
          <div class="gridea-search-container">
            <form id="gridea-search-form" style="position: relative" data-update="1750747815360"
              action="/search/index.html">
              <input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="æœç´¢æ–‡ç« " />
              <i class="fas fa-search gt-c-content-color-first" style="position: absolute; top: 9px; left: 10px;"></i>
            </form>
          </div>
        </li>
      </ul>
    </div>
  </div>
</nav>
<header class="masthead" style="background-image: url('https://jinvic.github.io/media/images/home-bg.jpg')">
  <div class="overlay"></div>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-md-10 mx-auto">
        
          <!-- æ²¡Titleä¸ºå…¶ä»–é¡µé¢Header -->
          
            <!-- æ²¡Titleå¹¶ä¸”æœ‰headerTypeä¸ºPostï¼šæ–‡ç« Header -->
            <div class="post-heading">
              <span class="tags">
                
                <a href="https://jinvic.github.io/tag/2vaencnsMM/" class="tag">Go</a>
                
                <a href="https://jinvic.github.io/tag/KbkCyWeWckl/" class="tag">ç¬”è®°</a>
                
              </span>
              <h1>GORMé€ŸæŸ¥ç¬”è®°</h1>
              <span class="meta">
                Posted on
                2024-08-19ï¼Œ135 min read
              </span>
            </div>
          
        
      </div>
    </div>
  </div>
</header>
  <!-- Post Content -->
  <article id="post-content-article">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto post-content-container">
          
          <h1 id="gormç¬”è®°">GORMç¬”è®°</h1>
<p><ul class="markdownIt-TOC">
<li><a href="#gorm%E7%AC%94%E8%AE%B0">GORMç¬”è®°</a>
<ul>
<li><a href="#%E5%85%A5%E9%97%A8">å…¥é—¨</a>
<ul>
<li><a href="#gorm%E5%AE%89%E8%A3%851">GORMå®‰è£…ã€1ã€‘</a></li>
<li><a href="#%E8%BF%9E%E6%8E%A5%E6%95%B0%E6%8D%AE%E5%BA%931">è¿æ¥æ•°æ®åº“ã€1ã€‘</a></li>
<li><a href="#%E8%87%AA%E5%8A%A8%E8%BF%81%E7%A7%BB1">è‡ªåŠ¨è¿ç§»ã€1ã€‘</a></li>
<li><a href="#%E5%A3%B0%E6%98%8E%E6%A8%A1%E5%9E%8B">å£°æ˜æ¨¡å‹</a>
<ul>
<li><a href="#%E6%A8%A1%E5%9E%8B%E5%AE%9A%E4%B9%891">æ¨¡å‹å®šä¹‰ã€1ã€‘</a></li>
<li><a href="#%E9%AB%98%E7%BA%A7%E9%80%89%E9%A1%B9%E5%B5%8C%E5%85%A5%E7%BB%93%E6%9E%84%E4%BD%931-%E5%AD%97%E6%AE%B5%E6%A0%87%E7%AD%BE3">é«˜çº§é€‰é¡¹ã€åµŒå…¥ç»“æ„ä½“:1 å­—æ®µæ ‡ç­¾ï¼š3ã€‘</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#crud-%E6%8E%A5%E5%8F%A33">CRUD æ¥å£ã€3ã€‘</a>
<ul>
<li><a href="#%E5%88%9B%E5%BB%BA">åˆ›å»º</a>
<ul>
<li><a href="#%E5%88%9B%E5%BB%BA%E8%AE%B0%E5%BD%95">åˆ›å»ºè®°å½•</a></li>
<li><a href="#%E6%A0%B9%E6%8D%AE-map-%E5%88%9B%E5%BB%BA">æ ¹æ® Map åˆ›å»º</a></li>
<li><a href="#%E6%8C%87%E5%AE%9A%E5%AD%97%E6%AE%B5%E5%88%9B%E5%BB%BA%E8%AE%B0%E5%BD%95">æŒ‡å®šå­—æ®µåˆ›å»ºè®°å½•</a></li>
<li><a href="#%E5%88%9B%E5%BB%BA%E8%B7%B3%E8%BF%87%E9%92%A9%E5%AD%90">åˆ›å»º&amp;è·³è¿‡é’©å­</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8-sql-%E8%A1%A8%E8%BE%BE%E5%BC%8F-context-valuer-%E5%88%9B%E5%BB%BA%E8%AE%B0%E5%BD%95">ä½¿ç”¨ SQL è¡¨è¾¾å¼ã€Context Valuer åˆ›å»ºè®°å½•</a></li>
<li><a href="#upsert">Upsert</a></li>
<li><a href="#%E5%88%9B%E5%BB%BA%E9%AB%98%E7%BA%A7%E9%80%89%E9%A1%B9">åˆ›å»ºé«˜çº§é€‰é¡¹</a></li>
</ul>
</li>
<li><a href="#%E6%9F%A5%E8%AF%A2">æŸ¥è¯¢</a>
<ul>
<li><a href="#%E6%A3%80%E7%B4%A2%E5%8D%95%E4%B8%AA%E5%AF%B9%E8%B1%A1">æ£€ç´¢å•ä¸ªå¯¹è±¡</a></li>
<li><a href="#%E6%9F%A5%E6%89%BE%E5%A4%B1%E8%B4%A5%E6%A3%80%E6%9F%A5">æŸ¥æ‰¾å¤±è´¥æ£€æŸ¥</a></li>
<li><a href="#%E6%A0%B9%E6%8D%AE%E4%B8%BB%E9%94%AE%E6%9F%A5%E8%AF%A2">æ ¹æ®ä¸»é”®æŸ¥è¯¢</a></li>
<li><a href="#%E6%A0%B9%E6%8D%AE%E6%9D%A1%E4%BB%B6%E6%9F%A5%E8%AF%A2">æ ¹æ®æ¡ä»¶æŸ¥è¯¢</a></li>
<li><a href="#%E9%80%89%E6%8B%A9%E7%89%B9%E5%AE%9A%E5%AD%97%E6%AE%B5">é€‰æ‹©ç‰¹å®šå­—æ®µ</a></li>
<li><a href="#%E6%8E%92%E5%BA%8F">æ’åº</a></li>
<li><a href="#limit-offset">Limit &amp; Offset</a></li>
<li><a href="#group-by-having">Group By &amp; Having</a></li>
<li><a href="#distinct">Distinct</a></li>
<li><a href="#joins">Joins</a></li>
<li><a href="#scan">Scan</a></li>
</ul>
</li>
<li><a href="#%E9%AB%98%E7%BA%A7%E6%9F%A5%E8%AF%A2">é«˜çº§æŸ¥è¯¢</a>
<ul>
<li><a href="#%E6%99%BA%E8%83%BD%E9%80%89%E6%8B%A9%E5%AD%97%E6%AE%B5">æ™ºèƒ½é€‰æ‹©å­—æ®µ</a></li>
<li><a href="#%E9%94%81-2">é” ã€2ã€‘</a></li>
<li><a href="#%E5%AD%90%E6%9F%A5%E8%AF%A2">å­æŸ¥è¯¢</a></li>
<li><a href="#group-%E6%9D%A1%E4%BB%B6">Group æ¡ä»¶</a></li>
<li><a href="#%E5%B8%A6%E5%A4%9A%E4%B8%AA%E5%88%97%E7%9A%84in">å¸¦å¤šä¸ªåˆ—çš„In</a></li>
<li><a href="#%E5%91%BD%E5%90%8D%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3">å‘½åå‚æ•°è¯¦è§£</a></li>
<li><a href="#find-%E8%87%B3-map">Find è‡³ map</a></li>
<li><a href="#firstorinit">FirstOrInit</a></li>
<li><a href="#firstorcreate">FirstOrCreate</a></li>
<li><a href="#%E4%BC%98%E5%8C%96%E5%99%A8-%E7%B4%A2%E5%BC%95%E6%8F%90%E7%A4%BA4">ä¼˜åŒ–å™¨ã€ç´¢å¼•æç¤ºã€4ã€‘</a></li>
<li><a href="#%E8%BF%AD%E4%BB%A3">è¿­ä»£</a></li>
<li><a href="#findinbatches">FindInBatches</a></li>
<li><a href="#%E6%9F%A5%E8%AF%A2%E9%92%A9%E5%AD%90">æŸ¥è¯¢é’©å­</a></li>
<li><a href="#pluck%E6%96%B9%E6%B3%953">Pluckæ–¹æ³•ã€3ã€‘</a></li>
<li><a href="#scope%E6%96%B9%E6%B3%95">Scopeæ–¹æ³•</a></li>
<li><a href="#count">Count</a></li>
</ul>
</li>
<li><a href="#%E6%9B%B4%E6%96%B0">æ›´æ–°</a>
<ul>
<li><a href="#%E4%BF%9D%E5%AD%98%E6%89%80%E6%9C%89%E5%AD%97%E6%AE%B5">ä¿å­˜æ‰€æœ‰å­—æ®µ</a></li>
<li><a href="#%E6%9B%B4%E6%96%B0%E5%8D%95%E4%B8%AA%E5%88%97">æ›´æ–°å•ä¸ªåˆ—</a></li>
<li><a href="#%E6%9B%B4%E6%96%B0%E5%A4%9A%E5%88%97">æ›´æ–°å¤šåˆ—</a></li>
<li><a href="#%E6%9B%B4%E6%96%B0%E9%80%89%E5%AE%9A%E5%AD%97%E6%AE%B5">æ›´æ–°é€‰å®šå­—æ®µ</a></li>
<li><a href="#%E6%9B%B4%E6%96%B0hook">æ›´æ–°Hook</a></li>
<li><a href="#%E6%89%B9%E9%87%8F%E6%9B%B4%E6%96%B0">æ‰¹é‡æ›´æ–°</a></li>
<li><a href="#%E6%9B%B4%E6%96%B0%E9%AB%98%E7%BA%A7%E9%80%89%E9%A1%B9">æ›´æ–°é«˜çº§é€‰é¡¹</a></li>
</ul>
</li>
<li><a href="#%E5%88%A0%E9%99%A4">åˆ é™¤</a>
<ul>
<li><a href="#%E9%92%A9%E5%AD%90%E5%87%BD%E6%95%B0">é’©å­å‡½æ•°</a></li>
<li><a href="#%E6%89%B9%E9%87%8F%E5%88%A0%E9%99%A4">æ‰¹é‡åˆ é™¤</a></li>
<li><a href="#%E8%BD%AF%E5%88%A0%E9%99%A4">è½¯åˆ é™¤</a></li>
</ul>
</li>
<li><a href="#%E5%8E%9F%E7%94%9Fsql%E5%92%8Csql%E7%94%9F%E6%88%90%E5%99%A8">åŸç”ŸSQLå’ŒSQLç”Ÿæˆå™¨</a>
<ul>
<li><a href="#%E5%8E%9F%E7%94%9F-sql">åŸç”Ÿ SQL</a></li>
<li><a href="#%E5%91%BD%E5%90%8D%E5%8F%82%E6%95%B0%E7%AE%80%E4%BB%8B">å‘½åå‚æ•°ç®€ä»‹</a></li>
<li><a href="#dryrun-%E6%A8%A1%E5%BC%8F">DryRun æ¨¡å¼</a></li>
<li><a href="#tosql">ToSQL</a></li>
<li><a href="#row-rows">Row &amp; Rows</a></li>
<li><a href="#%E5%B0%86-sqlrows-%E6%89%AB%E6%8F%8F%E8%87%B3-model">å°† sql.Rows æ‰«æè‡³ model</a></li>
<li><a href="#%E8%BF%9E%E6%8E%A5">è¿æ¥</a></li>
<li><a href="#%E9%AB%98%E7%BA%A7">é«˜çº§</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E5%85%B3%E8%81%94">å…³è”</a>
<ul>
<li><a href="#belongs-to">Belongs To</a></li>
<li><a href="#has-one">Has One</a>
<ul>
<li><a href="#%E5%A3%B0%E6%98%8E%E6%A3%80%E7%B4%A2-has-one">å£°æ˜&amp;æ£€ç´¢ Has One</a></li>
<li><a href="#%E8%87%AA%E5%BC%95%E7%94%A8-has-one">è‡ªå¼•ç”¨ Has One</a></li>
</ul>
</li>
<li><a href="#has-many">Has Many</a>
<ul>
<li><a href="#%E5%A3%B0%E6%98%8E%E6%A3%80%E7%B4%A2-has-many">å£°æ˜&amp;æ£€ç´¢ Has Many</a></li>
<li><a href="#%E8%87%AA%E5%BC%95%E7%94%A8-has-many">è‡ªå¼•ç”¨ Has Many</a></li>
</ul>
</li>
<li><a href="#many-to-many">Many To Many</a>
<ul>
<li><a href="#%E5%8F%8D%E5%90%91%E5%BC%95%E7%94%A8-many-to-many">åå‘å¼•ç”¨-Many To Many</a></li>
<li><a href="#%E8%87%AA%E5%BC%95%E7%94%A8-many2many">è‡ªå¼•ç”¨ Many2Many</a></li>
<li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%BF%9E%E6%8E%A5%E8%A1%A8">è‡ªå®šä¹‰è¿æ¥è¡¨</a></li>
<li><a href="#%E5%A4%8D%E5%90%88%E5%A4%96%E9%94%AE">å¤åˆå¤–é”®</a></li>
</ul>
</li>
<li><a href="#polymorphism">Polymorphism</a></li>
<li><a href="#%E5%A4%96%E9%94%AE%E7%BA%A6%E6%9D%9F">å¤–é”®çº¦æŸ</a></li>
<li><a href="#%E5%85%B3%E8%81%94%E6%A8%A1%E5%BC%8F">å…³è”æ¨¡å¼</a>
<ul>
<li><a href="#%E8%87%AA%E5%8A%A8%E5%88%9B%E5%BB%BA-%E6%9B%B4%E6%96%B0">è‡ªåŠ¨åˆ›å»ºã€æ›´æ–°</a></li>
<li><a href="#%E8%B7%B3%E8%BF%87%E8%87%AA%E5%8A%A8%E5%88%9B%E5%BB%BA-%E6%9B%B4%E6%96%B0">è·³è¿‡è‡ªåŠ¨åˆ›å»ºã€æ›´æ–°</a></li>
<li><a href="#selectomit-%E5%85%B3%E8%81%94%E5%AD%97%E6%AE%B5">Select/Omit å…³è”å­—æ®µ</a></li>
<li><a href="#%E5%88%A0%E9%99%A4%E5%85%B3%E8%81%94">åˆ é™¤å…³è”</a></li>
<li><a href="#%E5%85%B3%E8%81%94%E6%A8%A1%E5%BC%8F%E7%9B%B8%E5%85%B3">å…³è”æ¨¡å¼ç›¸å…³</a></li>
<li><a href="#%E5%88%A0%E9%99%A4%E5%85%B3%E8%81%94%E8%AE%B0%E5%BD%95">åˆ é™¤å…³è”è®°å½•</a></li>
<li><a href="#%E5%85%B3%E8%81%94%E6%A0%87%E7%AD%BEassociation-tags">å…³è”æ ‡ç­¾ï¼ˆAssociation Tagsï¼‰</a></li>
</ul>
</li>
<li><a href="#%E9%A2%84%E5%8A%A0%E8%BD%BD3">é¢„åŠ è½½ã€3ã€‘</a>
<ul>
<li><a href="#%E9%A2%84%E5%8A%A0%E8%BD%BD%E7%A4%BA%E4%BE%8B">é¢„åŠ è½½ç¤ºä¾‹</a></li>
<li><a href="#joins-%E9%A2%84%E5%8A%A0%E8%BD%BD">Joins é¢„åŠ è½½</a></li>
<li><a href="#%E9%A2%84%E5%8A%A0%E8%BD%BD%E5%85%A8%E9%83%A8">é¢„åŠ è½½å…¨éƒ¨</a></li>
<li><a href="#%E6%9D%A1%E4%BB%B6%E9%A2%84%E5%8A%A0%E8%BD%BD">æ¡ä»¶é¢„åŠ è½½</a></li>
<li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E9%A2%84%E5%8A%A0%E8%BD%BD-sql">è‡ªå®šä¹‰é¢„åŠ è½½ SQL</a></li>
<li><a href="#%E5%B5%8C%E5%A5%97%E9%A2%84%E5%8A%A0%E8%BD%BD">åµŒå¥—é¢„åŠ è½½</a></li>
<li><a href="#%E5%B5%8C%E5%85%A5%E5%BC%8F%E9%A2%84%E5%8A%A0%E8%BD%BD">åµŒå…¥å¼é¢„åŠ è½½</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E6%95%99%E7%A8%8B">æ•™ç¨‹</a>
<ul>
<li><a href="#%E4%B8%8A%E4%B8%8B%E6%96%872">ä¸Šä¸‹æ–‡ã€2ã€‘</a>
<ul>
<li><a href="#%E5%8D%95%E4%BC%9A%E8%AF%9D%E6%A8%A1%E5%BC%8F">å•ä¼šè¯æ¨¡å¼</a></li>
<li><a href="#%E8%BF%9E%E7%BB%AD%E4%BC%9A%E8%AF%9D%E6%A8%A1%E5%BC%8F">è¿ç»­ä¼šè¯æ¨¡å¼</a></li>
<li><a href="#%E4%B8%8A%E4%B8%8B%E6%96%87%E8%B6%85%E6%97%B6">ä¸Šä¸‹æ–‡è¶…æ—¶</a></li>
<li><a href="#hookscallbacks-%E4%B8%AD%E7%9A%84-context">Hooks/Callbacks ä¸­çš„ Context</a></li>
<li><a href="#%E4%B8%8Echi%E4%B8%AD%E9%97%B4%E4%BB%B6%E9%9B%86%E6%88%90">ä¸Chiä¸­é—´ä»¶é›†æˆ</a></li>
<li><a href="#logger%E9%9B%86%E6%88%90">Loggeré›†æˆ</a></li>
</ul>
</li>
<li><a href="#%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%862">é”™è¯¯å¤„ç†ã€2ã€‘</a>
<ul>
<li><a href="#%E5%9F%BA%E6%9C%AC%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">åŸºæœ¬é”™è¯¯å¤„ç†</a></li>
<li><a href="#errrecordnotfound">ErrRecordNotFound</a></li>
<li><a href="#%E5%A4%84%E7%90%86%E9%94%99%E8%AF%AF%E4%BB%A3%E7%A0%81">å¤„ç†é”™è¯¯ä»£ç </a></li>
<li><a href="#%E6%96%B9%E8%A8%80%E8%BD%AC%E6%8D%A2%E9%94%99%E8%AF%AF">æ–¹è¨€è½¬æ¢é”™è¯¯</a></li>
<li><a href="#errors">Errors</a></li>
</ul>
</li>
<li><a href="#%E9%93%BE%E5%BC%8F%E6%93%8D%E4%BD%9C1">é“¾å¼æ“ä½œã€1ã€‘</a>
<ul>
<li><a href="#%E6%96%B9%E6%B3%95%E7%B1%BB%E5%88%AB">æ–¹æ³•ç±»åˆ«</a></li>
<li><a href="#%E5%8F%AF%E9%87%8D%E7%94%A8%E6%80%A7%E5%92%8C%E5%AE%89%E5%85%A8%E6%80%A7">å¯é‡ç”¨æ€§å’Œå®‰å…¨æ€§</a></li>
<li><a href="#examples-for-clarity">Examples for Clarity</a></li>
</ul>
</li>
<li><a href="#session2">Sessionã€2ã€‘</a>
<ul>
<li><a href="#dryrun">DryRun</a></li>
<li><a href="#%E9%A2%84%E7%BC%96%E8%AF%91">é¢„ç¼–è¯‘</a></li>
<li><a href="#newdb">NewDB</a></li>
<li><a href="#%E5%88%9D%E5%A7%8B%E5%8C%96">åˆå§‹åŒ–</a></li>
<li><a href="#%E8%B7%B3%E8%BF%87%E9%92%A9%E5%AD%90">è·³è¿‡é’©å­</a></li>
<li><a href="#%E7%A6%81%E7%94%A8%E5%B5%8C%E5%A5%97%E4%BA%8B%E5%8A%A1">ç¦ç”¨åµŒå¥—äº‹åŠ¡</a></li>
<li><a href="#allowglobalupdate">AllowGlobalUpdate</a></li>
<li><a href="#fullsaveassociations">FullSaveAssociations</a></li>
<li><a href="#context">Context</a></li>
<li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89-logger">è‡ªå®šä¹‰ Logger</a></li>
<li><a href="#nowfunc">NowFunc</a></li>
<li><a href="#%E8%B0%83%E8%AF%95">è°ƒè¯•</a></li>
<li><a href="#%E6%9F%A5%E8%AF%A2%E5%AD%97%E6%AE%B5">æŸ¥è¯¢å­—æ®µ</a></li>
<li><a href="#createbatchsize">CreateBatchSize</a></li>
</ul>
</li>
<li><a href="#%E9%92%A9%E5%AD%902">é’©å­ã€2ã€‘</a>
<ul>
<li><a href="#%E5%AF%B9%E8%B1%A1%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F">å¯¹è±¡ç”Ÿå‘½å‘¨æœŸ</a></li>
<li><a href="#hook">Hook</a></li>
<li><a href="#%E4%BF%AE%E6%94%B9%E5%BD%93%E5%89%8D%E6%93%8D%E4%BD%9C">ä¿®æ”¹å½“å‰æ“ä½œ</a></li>
</ul>
</li>
<li><a href="#%E4%BA%8B%E5%8A%A13">äº‹åŠ¡ã€3ã€‘</a>
<ul>
<li><a href="#%E7%A6%81%E7%94%A8%E9%BB%98%E8%AE%A4%E4%BA%8B%E5%8A%A1">ç¦ç”¨é»˜è®¤äº‹åŠ¡</a></li>
<li><a href="#%E4%BA%8B%E5%8A%A1%E7%A4%BA%E4%BE%8B">äº‹åŠ¡ç¤ºä¾‹</a></li>
<li><a href="#%E6%89%8B%E5%8A%A8%E4%BA%8B%E5%8A%A1">æ‰‹åŠ¨äº‹åŠ¡</a></li>
</ul>
</li>
<li><a href="#%E8%BF%81%E7%A7%BB2">è¿ç§»ã€2ã€‘</a>
<ul>
<li><a href="#automigrate">AutoMigrate</a></li>
<li><a href="#migrator-%E6%8E%A5%E5%8F%A3">Migrator æ¥å£</a></li>
<li><a href="#%E7%BA%A6%E6%9D%9F">çº¦æŸ</a></li>
<li><a href="#atlas-integration">Atlas Integration</a></li>
<li><a href="#other-migration-tools">Other Migration Tools</a></li>
</ul>
</li>
<li><a href="#logger1">Loggerã€1ã€‘</a>
<ul>
<li><a href="#%E6%97%A5%E5%BF%97">æ—¥å¿—</a></li>
<li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89logger">è‡ªå®šä¹‰Logger</a></li>
</ul>
</li>
<li><a href="#%E6%80%A7%E8%83%BD2">æ€§èƒ½ã€2ã€‘</a>
<ul>
<li><a href="#%E6%80%A7%E8%83%BD-%E7%A6%81%E7%94%A8%E9%BB%98%E8%AE%A4%E4%BA%8B%E5%8A%A1">æ€§èƒ½-ç¦ç”¨é»˜è®¤äº‹åŠ¡</a></li>
<li><a href="#%E7%BC%93%E5%AD%98%E9%A2%84%E7%BC%96%E8%AF%91%E8%AF%AD%E5%8F%A5">ç¼“å­˜é¢„ç¼–è¯‘è¯­å¥</a></li>
<li><a href="#%E9%80%89%E6%8B%A9%E5%AD%97%E6%AE%B5">é€‰æ‹©å­—æ®µ</a></li>
<li><a href="#%E8%BF%AD%E4%BB%A3-findinbatches">è¿­ä»£ã€FindInBatches</a></li>
<li><a href="#index-hints">Index Hints</a></li>
<li><a href="#%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB">è¯»å†™åˆ†ç¦»</a></li>
</ul>
</li>
<li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B4">è‡ªå®šä¹‰æ•°æ®ç±»å‹ã€4ã€‘</a>
<ul>
<li><a href="#%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%AE%9A%E4%B9%89%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B">å®ç°è‡ªå®šä¹‰æ•°æ®ç±»å‹</a></li>
<li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E9%9B%86%E5%90%88">è‡ªå®šä¹‰æ•°æ®ç±»å‹é›†åˆ</a></li>
</ul>
</li>
<li><a href="#scope3">Scopeã€3ã€‘</a>
<ul>
<li><a href="#scope%E6%9F%A5%E8%AF%A2">ScopeæŸ¥è¯¢</a></li>
<li><a href="#scope%E5%8A%A8%E6%80%81%E8%A1%A8">scopeåŠ¨æ€è¡¨</a></li>
<li><a href="#scope%E6%9B%B4%E6%96%B0">scopeæ›´æ–°</a></li>
</ul>
</li>
<li><a href="#%E7%BA%A6%E5%AE%9A">çº¦å®š</a>
<ul>
<li><a href="#%E4%BD%BF%E7%94%A8-id-%E4%BD%9C%E4%B8%BA%E4%B8%BB%E9%94%AE">ä½¿ç”¨ ID ä½œä¸ºä¸»é”®</a></li>
<li><a href="#%E5%A4%8D%E6%95%B0%E8%A1%A8%E5%90%8D">å¤æ•°è¡¨å</a></li>
<li><a href="#%E5%88%97%E5%90%8D">åˆ—å</a></li>
<li><a href="#%E6%97%B6%E9%97%B4%E6%88%B3%E8%BF%BD%E8%B8%AA">æ—¶é—´æˆ³è¿½è¸ª</a></li>
</ul>
</li>
<li><a href="#%E8%AE%BE%E7%BD%AE">è®¾ç½®</a></li>
</ul>
</li>
<li><a href="#%E9%AB%98%E7%BA%A7%E4%B8%BB%E9%A2%98">é«˜çº§ä¸»é¢˜</a>
<ul>
<li><a href="#database-resolver">Database Resolver</a></li>
<li><a href="#sharding">Sharding</a></li>
<li><a href="#serializer4">Serializerã€4ã€‘</a>
<ul>
<li><a href="#%E6%B3%A8%E5%86%8C%E5%BA%8F%E5%88%97%E5%8C%96%E5%99%A8">æ³¨å†Œåºåˆ—åŒ–å™¨</a></li>
<li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BA%8F%E5%88%97%E5%8C%96%E5%99%A8%E7%B1%BB%E5%9E%8B">è‡ªå®šä¹‰åºåˆ—åŒ–å™¨ç±»å‹</a></li>
</ul>
</li>
<li><a href="#%E7%B4%A2%E5%BC%951">ç´¢å¼•ã€1ã€‘</a>
<ul>
<li><a href="#%E7%B4%A2%E5%BC%95%E6%A0%87%E7%AD%BE">ç´¢å¼•æ ‡ç­¾</a></li>
<li><a href="#%E5%A4%8D%E5%90%88%E7%B4%A2%E5%BC%95">å¤åˆç´¢å¼•</a></li>
<li><a href="#%E5%A4%9A%E7%B4%A2%E5%BC%95">å¤šç´¢å¼•</a></li>
</ul>
</li>
<li><a href="#%E7%BA%A6%E6%9D%9F1">çº¦æŸã€1ã€‘</a>
<ul>
<li><a href="#%E6%A3%80%E6%9F%A5%E7%BA%A6%E6%9D%9F">æ£€æŸ¥çº¦æŸ</a></li>
<li><a href="#%E7%B4%A2%E5%BC%95-%E7%BA%A6%E6%9D%9F">ç´¢å¼• çº¦æŸ</a></li>
<li><a href="#%E5%A4%96%E9%94%AE-%E7%BA%A6%E6%9D%9F">å¤–é”® çº¦æŸ</a></li>
</ul>
</li>
<li><a href="#%E5%A4%8D%E5%90%88%E4%B8%BB%E9%94%AE1">å¤åˆä¸»é”®ã€1ã€‘</a></li>
<li><a href="#%E5%AE%89%E5%85%A8">å®‰å…¨</a></li>
<li><a href="#gorm%E9%85%8D%E7%BD%AE2">GORMé…ç½®ã€2ã€‘</a>
<ul>
<li><a href="#%E8%B7%B3%E8%BF%87%E9%BB%98%E8%AE%A4%E4%BA%8B%E5%8A%A1">è·³è¿‡é»˜è®¤äº‹åŠ¡</a></li>
<li><a href="#%E5%91%BD%E5%90%8D%E7%AD%96%E7%95%A5">å‘½åç­–ç•¥</a></li>
<li><a href="#logger">Logger</a></li>
<li><a href="#owfunc">owFunc</a></li>
<li><a href="#dryrun%E9%85%8D%E7%BD%AE">DryRuné…ç½®</a></li>
<li><a href="#preparestmt">PrepareStmt</a></li>
<li><a href="#%E7%A6%81%E7%94%A8%E5%B5%8C%E5%A5%97%E4%BA%8B%E5%8A%A1%E9%85%8D%E7%BD%AE">ç¦ç”¨åµŒå¥—äº‹åŠ¡é…ç½®</a></li>
<li><a href="#allowglobalupdate%E9%85%8D%E7%BD%AE">AllowGlobalUpdateé…ç½®</a></li>
<li><a href="#disableautomaticping">DisableAutomaticPing</a></li>
<li><a href="#disableforeignkeyconstraintwhenmigrating">DisableForeignKeyConstraintWhenMigrating</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</p>
<hr>
<p><a href="https://gorm.io/zh_CN/docs/">å®˜æ–¹ä¸­æ–‡æ–‡æ¡£</a><br>
åŸºæœ¬éƒ½åœ¨æŠ„æ–‡æ¡£ğŸ˜“<br>
å¿«é€Ÿå…¥é—¨çš„è¯ï¼Œçœ‹çœ‹crudï¼Œé¢„åŠ è½½ï¼Œé’©å­ï¼Œäº‹åŠ¡ï¼Œè¿ç§»å°±å·®ä¸å¤šäº†ã€‚æ›´é«˜çº§çš„å†…å®¹æœ‰éœ€è¦å†æŸ¥æ–‡æ¡£ä¹Ÿè¡Œã€‚</p>
<p>ã€1ã€‘ï¼šç®€å•ï¼ŒåŸºç¡€<br>
ã€2ã€‘ï¼šæœ‰ä¸€å®šé‡è¦æ€§ï¼Œäº†è§£ä¸€ä¸‹<br>
ã€3ã€‘ï¼šéå¸¸é‡è¦ï¼Œå¿…é¡»æŒæ¡<br>
ã€4ã€‘ï¼šå¤ªéš¾äº†çœ‹ä¸æ‡‚</p>
<h2 id="å…¥é—¨">å…¥é—¨</h2>
<h3 id="gormå®‰è£…1">GORMå®‰è£…ã€1ã€‘</h3>
<p><code>go get -u gorm.io/gorm</code><br>
<code>go get -u gorm.io/driver/sqlite</code></p>
<h3 id="è¿æ¥æ•°æ®åº“1">è¿æ¥æ•°æ®åº“ã€1ã€‘</h3>
<pre><code class="language-go"> //Data Source Name æ•°æ®æºåç§°
 dsn := &quot;root:root@tcp(127.0.0.1:3306)/test?charset=utf8mb4&amp;parseTime=True&amp;loc=Local&amp;&amp;timeout=10s&quot;
 //é“¾æ¥MySQLæ•°æ®åº“
 db, err := gorm.Open(mysql.Open(dsn), &amp;gorm.Config{})

 if err != nil {
  panic(&quot;failed to connect database: &quot; + err.Error())
 }
</code></pre>
<h3 id="è‡ªåŠ¨è¿ç§»1">è‡ªåŠ¨è¿ç§»ã€1ã€‘</h3>
<pre><code class="language-go"> //è‡ªåŠ¨è¿ç§»ï¼Œæ ¹æ®æ¨¡å‹ç”Ÿæˆæˆ–æ›´æ–°æ•°æ®è¡¨
 db.AutoMigrate(&amp;User{})
</code></pre>
<h3 id="å£°æ˜æ¨¡å‹">å£°æ˜æ¨¡å‹</h3>
<h4 id="æ¨¡å‹å®šä¹‰1">æ¨¡å‹å®šä¹‰ã€1ã€‘</h4>
<p>gormæ˜¯å…ˆå†™å¥½æ¨¡å‹ï¼Œå³è¡¨ç»“æ„ä½“ï¼Œå†é€šè¿‡è¿ç§»åœ¨æ•°æ®åº“ä¸­å»ºè¡¨ã€‚goframeçš„ormæ˜¯è¯»å–æ•°æ®åº“ä¸­çš„è¡¨ç”Ÿæˆæ¨¡å‹ã€‚ä¸¤è€…åŒºåˆ«è¿˜æŒºå¤§çš„ã€‚ä¸ªäººæ„Ÿè§‰gormçš„æ¨¡å‹å†™èµ·æ¥éº»çƒ¦äº›ï¼Œéœ€è¦é€šè¿‡æ ‡ç­¾è®¾ç½®æ•°æ®åº“ç›¸å…³é€‰é¡¹ã€‚</p>
<p>æ­¤å¤–å…³äºå­—æ®µç±»å‹ï¼Œuintï¼Œstringç­‰åŸºæœ¬ç±»å‹å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼›æŒ‡å‘ <code>*string</code> å’Œ <code>*time.Time</code> ç±»å‹çš„æŒ‡é’ˆè¡¨ç¤ºå¯ç©ºå­—æ®µã€‚è€Œæ¥è‡ª <code>database/sql</code> åŒ…çš„ <code>sql.NullString</code> å’Œ <code>sql.NullTime</code> ç”¨äºå…·æœ‰æ›´å¤šæ§åˆ¶çš„å¯ç©ºå­—æ®µã€‚</p>
<p><strong>çº¦å®š</strong>ï¼š</p>
<ul>
<li>
<p>ä¸»é”®ï¼šGORM ä½¿ç”¨ä¸€ä¸ªåä¸ºID çš„å­—æ®µä½œä¸ºæ¯ä¸ªæ¨¡å‹çš„é»˜è®¤ä¸»é”®ã€‚</p>
</li>
<li>
<p>è¡¨åï¼šé»˜è®¤æƒ…å†µä¸‹ï¼ŒGORM å°†ç»“æ„ä½“åç§°è½¬æ¢ä¸º snake_case å¹¶ä¸ºè¡¨ååŠ ä¸Šå¤æ•°å½¢å¼ã€‚ ä¾‹å¦‚ï¼Œä¸€ä¸ª User ç»“æ„ä½“åœ¨æ•°æ®åº“ä¸­çš„è¡¨åå˜ä¸º users ã€‚</p>
</li>
<li>
<p>åˆ—åï¼šGORM è‡ªåŠ¨å°†ç»“æ„ä½“å­—æ®µåç§°è½¬æ¢ä¸º snake_case ä½œä¸ºæ•°æ®åº“ä¸­çš„åˆ—åã€‚</p>
</li>
<li>
<p>æ—¶é—´æˆ³å­—æ®µï¼šGORMä½¿ç”¨å­—æ®µ CreatedAt å’Œ UpdatedAt æ¥è‡ªåŠ¨è·Ÿè¸ªè®°å½•çš„åˆ›å»ºå’Œæ›´æ–°æ—¶é—´ã€‚</p>
</li>
</ul>
<p><strong>gorm.Model</strong>ï¼š</p>
<p>GORMæä¾›äº†ä¸€ä¸ªé¢„å®šä¹‰çš„ç»“æ„ä½“ï¼Œåä¸ºgorm.Modelï¼Œå…¶ä¸­åŒ…å«å¸¸ç”¨å­—æ®µï¼š</p>
<pre><code class="language-go">// gorm.Model çš„å®šä¹‰
type Model struct {
  ID        uint           `gorm:&quot;primaryKey&quot;`
  CreatedAt time.Time
  UpdatedAt time.Time
  DeletedAt gorm.DeletedAt `gorm:&quot;index&quot;`
}
</code></pre>
<p>å¯ä»¥ç›´æ¥åœ¨è‡ªå·±çš„ç»“æ„ä½“ä¸­åµŒå…¥ gorm.Model ï¼Œä»¥ä¾¿è‡ªåŠ¨åŒ…å«è¿™äº›å­—æ®µã€‚</p>
<ul>
<li><code>ID</code> ï¼šæ¯ä¸ªè®°å½•çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆä¸»é”®ï¼‰ã€‚</li>
<li><code>CreatedAt</code> ï¼šåœ¨åˆ›å»ºè®°å½•æ—¶è‡ªåŠ¨è®¾ç½®ä¸ºå½“å‰æ—¶é—´ã€‚</li>
<li><code>UpdatedAt</code> ï¼šæ¯å½“è®°å½•æ›´æ–°æ—¶ï¼Œè‡ªåŠ¨æ›´æ–°ä¸ºå½“å‰æ—¶é—´ã€‚</li>
<li><code>DeletedAt</code> ï¼šç”¨äºè½¯åˆ é™¤ï¼ˆå°†è®°å½•æ ‡è®°ä¸ºå·²åˆ é™¤ï¼Œè€Œå®é™…ä¸Šå¹¶æœªä»æ•°æ®åº“ä¸­åˆ é™¤ï¼‰ã€‚</li>
</ul>
<h4 id="é«˜çº§é€‰é¡¹åµŒå…¥ç»“æ„ä½“1-å­—æ®µæ ‡ç­¾3">é«˜çº§é€‰é¡¹ã€åµŒå…¥ç»“æ„ä½“:1 å­—æ®µæ ‡ç­¾ï¼š3ã€‘</h4>
<p><strong>å­—æ®µçº§æƒé™æ§åˆ¶</strong>:<br>
å¯å¯¼å‡ºçš„å­—æ®µåœ¨ä½¿ç”¨ GORM è¿›è¡Œ CRUD æ—¶æ‹¥æœ‰å…¨éƒ¨çš„æƒé™ï¼Œæ­¤å¤–ï¼ŒGORM å…è®¸æ‚¨ç”¨æ ‡ç­¾æ§åˆ¶å­—æ®µçº§åˆ«çš„æƒé™ã€‚è¿™æ ·æ‚¨å°±å¯ä»¥è®©ä¸€ä¸ªå­—æ®µçš„æƒé™æ˜¯åªè¯»ã€åªå†™ã€åªåˆ›å»ºã€åªæ›´æ–°æˆ–è€…è¢«å¿½ç•¥</p>
<pre><code class="language-go">type User struct {
  Name string `gorm:&quot;&lt;-:create&quot;` // å…è®¸è¯»å’Œåˆ›å»º
  Name string `gorm:&quot;&lt;-:update&quot;` // å…è®¸è¯»å’Œæ›´æ–°
  Name string `gorm:&quot;&lt;-&quot;`        // å…è®¸è¯»å’Œå†™ï¼ˆåˆ›å»ºå’Œæ›´æ–°ï¼‰
  Name string `gorm:&quot;&lt;-:false&quot;`  // å…è®¸è¯»ï¼Œç¦æ­¢å†™
  Name string `gorm:&quot;-&gt;&quot;`        // åªè¯»ï¼ˆé™¤éæœ‰è‡ªå®šä¹‰é…ç½®ï¼Œå¦åˆ™ç¦æ­¢å†™ï¼‰
  Name string `gorm:&quot;-&gt;;&lt;-:create&quot;` // å…è®¸è¯»å’Œå†™
  Name string `gorm:&quot;-&gt;:false;&lt;-:create&quot;` // ä»…åˆ›å»ºï¼ˆç¦æ­¢ä» db è¯»ï¼‰
  Name string `gorm:&quot;-&quot;`  // é€šè¿‡ struct è¯»å†™ä¼šå¿½ç•¥è¯¥å­—æ®µ
  Name string `gorm:&quot;-:all&quot;`        // é€šè¿‡ struct è¯»å†™ã€è¿ç§»ä¼šå¿½ç•¥è¯¥å­—æ®µ
  Name string `gorm:&quot;-:migration&quot;`  // é€šè¿‡ struct è¿ç§»ä¼šå¿½ç•¥è¯¥å­—æ®µ
}
</code></pre>
<p><strong>åˆ›å»º/æ›´æ–°æ—¶é—´è¿½è¸ª</strong>ï¼š</p>
<p>GORM çº¦å®šä½¿ç”¨ CreatedAtã€UpdatedAt è¿½è¸ªåˆ›å»º/æ›´æ–°æ—¶é—´ã€‚å¦‚æœå®šä¹‰äº†è¿™ç§å­—æ®µï¼ŒGORM åœ¨åˆ›å»ºã€æ›´æ–°æ—¶ä¼šè‡ªåŠ¨å¡«å…… å½“å‰æ—¶é—´.è¦ä½¿ç”¨ä¸åŒåç§°çš„å­—æ®µï¼Œå¯ä»¥é…ç½® <code>autoCreateTime</code> ã€ <code>autoUpdateTime</code> æ ‡ç­¾ã€‚</p>
<p>å¦‚æœæ‚¨æƒ³è¦ä¿å­˜ UNIXï¼ˆæ¯«/çº³ï¼‰ç§’æ—¶é—´æˆ³ï¼Œè€Œä¸æ˜¯ timeï¼Œåªéœ€ç®€å•åœ°å°† time.Time ä¿®æ”¹ä¸º int å³å¯</p>
<pre><code class="language-go">type User struct {
  CreatedAt time.Time // åœ¨åˆ›å»ºæ—¶ï¼Œå¦‚æœè¯¥å­—æ®µå€¼ä¸ºé›¶å€¼ï¼Œåˆ™ä½¿ç”¨å½“å‰æ—¶é—´å¡«å……
  UpdatedAt int       // åœ¨åˆ›å»ºæ—¶è¯¥å­—æ®µå€¼ä¸ºé›¶å€¼æˆ–è€…åœ¨æ›´æ–°æ—¶ï¼Œä½¿ç”¨å½“å‰æ—¶é—´æˆ³ç§’æ•°å¡«å……
  Updated   int64 `gorm:&quot;autoUpdateTime:nano&quot;` // ä½¿ç”¨æ—¶é—´æˆ³çº³ç§’æ•°å¡«å……æ›´æ–°æ—¶é—´
  Updated   int64 `gorm:&quot;autoUpdateTime:milli&quot;` // ä½¿ç”¨æ—¶é—´æˆ³æ¯«ç§’æ•°å¡«å……æ›´æ–°æ—¶é—´
  Created   int64 `gorm:&quot;autoCreateTime&quot;`      // ä½¿ç”¨æ—¶é—´æˆ³ç§’æ•°å¡«å……åˆ›å»ºæ—¶é—´
}
</code></pre>
<p><strong>åµŒå…¥ç»“æ„ä½“</strong>:</p>
<p>å¯¹äºåŒ¿åå­—æ®µï¼ŒGORM ä¼šå°†å…¶å­—æ®µåŒ…å«åœ¨çˆ¶ç»“æ„ä½“ä¸­<br>
å¯¹äºæ­£å¸¸çš„ç»“æ„ä½“å­—æ®µï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ ‡ç­¾ embedded å°†å…¶åµŒå…¥<br>
å¹¶ä¸”ï¼Œå¯ä»¥ä½¿ç”¨æ ‡ç­¾ embeddedPrefix æ¥ä¸º db ä¸­çš„å­—æ®µåæ·»åŠ å‰ç¼€</p>
<pre><code class="language-go">type Blog struct {
  ID      int
  Author  Author `gorm:&quot;embedded;embeddedPrefix:author_&quot;`
  Upvotes int32
}
</code></pre>
<p><strong>å­—æ®µæ ‡ç­¾</strong><br>
åœ¨å£°æ˜æ¨¡å‹æ—¶ï¼Œæ ‡è®°æ˜¯å¯é€‰çš„ï¼ŒGORMæ”¯æŒä»¥ä¸‹æ ‡è®°:æ ‡è®°ä¸åŒºåˆ†å¤§å°å†™ï¼Œä½†é¦–é€‰<code>camelCase</code>é©¼å³°å‘½åæ³•ã€‚å¦‚æœä½¿ç”¨å¤šä¸ªæ ‡ç­¾ï¼Œå®ƒä»¬ä¹‹é—´åº”è¯¥ç”¨åˆ†å·(;)åˆ†éš”ã€‚å¯¹è§£æå™¨æœ‰ç‰¹æ®Šæ„ä¹‰çš„å­—ç¬¦å¯ä»¥ç”¨åæ–œæ (\)è½¬ä¹‰ï¼Œå…è®¸å®ƒä»¬ç”¨ä½œå‚æ•°å€¼ã€‚</p>
<table>
<thead>
<tr>
<th>æ ‡ç­¾å</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>column</td>
<td>æŒ‡å®š db åˆ—å</td>
</tr>
<tr>
<td>type</td>
<td>åˆ—æ•°æ®ç±»å‹ï¼Œæ¨èä½¿ç”¨å…¼å®¹æ€§å¥½çš„é€šç”¨ç±»å‹ï¼Œä¾‹å¦‚ï¼šæ‰€æœ‰æ•°æ®åº“éƒ½æ”¯æŒ boolã€intã€uintã€floatã€stringã€timeã€bytes å¹¶ä¸”å¯ä»¥å’Œå…¶ä»–æ ‡ç­¾ä¸€èµ·ä½¿ç”¨ï¼Œä¾‹å¦‚ï¼šnot nullã€size, autoIncrementâ€¦ åƒ varbinary(8) è¿™æ ·æŒ‡å®šæ•°æ®åº“æ•°æ®ç±»å‹ä¹Ÿæ˜¯æ”¯æŒçš„ã€‚åœ¨ä½¿ç”¨æŒ‡å®šæ•°æ®åº“æ•°æ®ç±»å‹æ—¶ï¼Œå®ƒéœ€è¦æ˜¯å®Œæ•´çš„æ•°æ®åº“æ•°æ®ç±»å‹ï¼Œå¦‚ï¼šMEDIUMINT UNSIGNED not NULL AUTO_INCREMENT</td>
</tr>
<tr>
<td>serializer</td>
<td>æŒ‡å®šå°†æ•°æ®åºåˆ—åŒ–æˆ–ååºåˆ—åŒ–åˆ°æ•°æ®åº“ä¸­çš„åºåˆ—åŒ–å™¨, ä¾‹å¦‚: serializer:json/gob/unixtime</td>
</tr>
<tr>
<td>size</td>
<td>å®šä¹‰åˆ—æ•°æ®ç±»å‹çš„å¤§å°æˆ–é•¿åº¦ï¼Œä¾‹å¦‚ size: 256</td>
</tr>
<tr>
<td>primaryKey</td>
<td>å°†åˆ—å®šä¹‰ä¸ºä¸»é”®</td>
</tr>
<tr>
<td>unique</td>
<td>å°†åˆ—å®šä¹‰ä¸ºå”¯ä¸€é”®</td>
</tr>
<tr>
<td>default</td>
<td>å®šä¹‰åˆ—çš„é»˜è®¤å€¼</td>
</tr>
<tr>
<td>precision</td>
<td>æŒ‡å®šåˆ—çš„ç²¾åº¦</td>
</tr>
<tr>
<td>scale</td>
<td>æŒ‡å®šåˆ—å¤§å°</td>
</tr>
<tr>
<td>not null</td>
<td>æŒ‡å®šåˆ—ä¸º NOT NULL</td>
</tr>
<tr>
<td>autoIncrement</td>
<td>æŒ‡å®šåˆ—ä¸ºè‡ªåŠ¨å¢é•¿</td>
</tr>
<tr>
<td>autoIncrementIncrement</td>
<td>è‡ªåŠ¨æ­¥é•¿ï¼Œæ§åˆ¶è¿ç»­è®°å½•ä¹‹é—´çš„é—´éš”</td>
</tr>
<tr>
<td>embedded</td>
<td>åµŒå¥—å­—æ®µ</td>
</tr>
<tr>
<td>embeddedPrefix</td>
<td>åµŒå…¥å­—æ®µçš„åˆ—åå‰ç¼€</td>
</tr>
<tr>
<td>autoCreateTime</td>
<td>åˆ›å»ºæ—¶è¿½è¸ªå½“å‰æ—¶é—´ï¼Œå¯¹äº int å­—æ®µï¼Œå®ƒä¼šè¿½è¸ªæ—¶é—´æˆ³ç§’æ•°ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ nano/milli æ¥è¿½è¸ªçº³ç§’ã€æ¯«ç§’æ—¶é—´æˆ³ï¼Œä¾‹å¦‚ï¼šautoCreateTime:nano</td>
</tr>
<tr>
<td>autoUpdateTime</td>
<td>åˆ›å»º/æ›´æ–°æ—¶è¿½è¸ªå½“å‰æ—¶é—´ï¼Œå¯¹äº int å­—æ®µï¼Œå®ƒä¼šè¿½è¸ªæ—¶é—´æˆ³ç§’æ•°ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ nano/milli æ¥è¿½è¸ªçº³ç§’ã€æ¯«ç§’æ—¶é—´æˆ³ï¼Œä¾‹å¦‚ï¼šautoUpdateTime:milli</td>
</tr>
<tr>
<td>index</td>
<td>æ ¹æ®å‚æ•°åˆ›å»ºç´¢å¼•ï¼Œå¤šä¸ªå­—æ®µä½¿ç”¨ç›¸åŒçš„åç§°åˆ™åˆ›å»ºå¤åˆç´¢å¼•ï¼ŒæŸ¥çœ‹ ç´¢å¼• è·å–è¯¦æƒ…</td>
</tr>
<tr>
<td>uniqueIndex</td>
<td>ä¸ index ç›¸åŒï¼Œä½†åˆ›å»ºçš„æ˜¯å”¯ä¸€ç´¢å¼•</td>
</tr>
<tr>
<td>check</td>
<td>åˆ›å»ºæ£€æŸ¥çº¦æŸï¼Œä¾‹å¦‚ check:age &gt; 13ï¼ŒæŸ¥çœ‹ çº¦æŸ è·å–è¯¦æƒ…</td>
</tr>
<tr>
<td>&lt;-</td>
<td>è®¾ç½®å­—æ®µå†™å…¥çš„æƒé™ï¼Œ &lt;-:create åªåˆ›å»ºã€&lt;-:update åªæ›´æ–°ã€&lt;-:false æ— å†™å…¥æƒé™ã€&lt;- åˆ›å»ºå’Œæ›´æ–°æƒé™</td>
</tr>
<tr>
<td>-&gt;</td>
<td>è®¾ç½®å­—æ®µè¯»çš„æƒé™ï¼Œ-&gt;:false æ— è¯»æƒé™</td>
</tr>
<tr>
<td>-</td>
<td>å¿½ç•¥è¯¥å­—æ®µï¼Œ- è¡¨ç¤ºæ— è¯»å†™ï¼Œ-:migration è¡¨ç¤ºæ— è¿ç§»æƒé™ï¼Œ-:all è¡¨ç¤ºæ— è¯»å†™è¿ç§»æƒé™</td>
</tr>
<tr>
<td>comment</td>
<td>è¿ç§»æ—¶ä¸ºå­—æ®µæ·»åŠ æ³¨é‡Š</td>
</tr>
</tbody>
</table>
<p><strong>å…³è”æ ‡ç­¾</strong><br>
GORM å…è®¸é€šè¿‡æ ‡ç­¾ä¸ºå…³è”é…ç½®å¤–é”®ã€çº¦æŸã€many2many è¡¨ï¼Œè¯¦æƒ…è¯·å‚è€ƒ <a href="#%E5%85%B3%E8%81%94">å…³è”éƒ¨åˆ†</a></p>
<h2 id="crud-æ¥å£3">CRUD æ¥å£ã€3ã€‘</h2>
<h3 id="åˆ›å»º">åˆ›å»º</h3>
<h4 id="åˆ›å»ºè®°å½•">åˆ›å»ºè®°å½•</h4>
<pre><code class="language-go"> user := User{Name: &quot;Jinzhu&quot;, Age: 18, Birthday: time.Now()}
 result := db.Create(&amp;user)
 //åˆ†æ‰¹æ’å…¥
 users := []User{...}
 db.CreateInBatches(users, 100)
</code></pre>
<p><code>Upsert</code> å’Œ <code>Create With Associations</code>åŒæ ·æ”¯æŒæ‰¹é‡æ’å…¥</p>
<h4 id="æ ¹æ®-map-åˆ›å»º">æ ¹æ® Map åˆ›å»º</h4>
<p>GORMæ”¯æŒé€šè¿‡ map[string]interface{} ä¸ []map[string]interface{}æ¥åˆ›å»ºè®°å½•ã€‚</p>
<pre><code class="language-go">db.Model(&amp;User{}).Create(map[string]interface{}{
  &quot;Name&quot;: &quot;jinzhu&quot;, &quot;Age&quot;: 18,
})

// batch insert from `[]map[string]interface{}{}`
db.Model(&amp;User{}).Create([]map[string]interface{}{
  {&quot;Name&quot;: &quot;jinzhu_1&quot;, &quot;Age&quot;: 18},
  {&quot;Name&quot;: &quot;jinzhu_2&quot;, &quot;Age&quot;: 20},
})
</code></pre>
<p>æ³¨æ„å½“ä½¿ç”¨mapæ¥åˆ›å»ºæ—¶ï¼Œé’©å­æ–¹æ³•ä¸ä¼šæ‰§è¡Œï¼Œå…³è”ä¸ä¼šè¢«ä¿å­˜ä¸”ä¸ä¼šå›å†™ä¸»é”®ã€‚</p>
<h4 id="æŒ‡å®šå­—æ®µåˆ›å»ºè®°å½•">æŒ‡å®šå­—æ®µåˆ›å»ºè®°å½•</h4>
<pre><code class="language-go">db.Select(å­—æ®µ1,...).Create(&amp;user)
db.Omit(å­—æ®µ1,...).Create(&amp;user)
</code></pre>
<h4 id="åˆ›å»ºè·³è¿‡é’©å­">åˆ›å»º&amp;è·³è¿‡é’©å­</h4>
<p>å¯ä»¥é€šè¿‡å®ç°æ¥å£è‡ªå®šä¹‰é’©å­ï¼Œç›¸å½“äºwebçš„ä¸­é—´ä»¶ï¼Œåœ¨æ•°æ®åº“æ“ä½œå‰åé™„åŠ æ“ä½œï¼Œè¯¦æƒ…å‚é˜…<a href="#%E9%92%A9%E5%AD%902">Hooks</a>ã€‚</p>
<pre><code class="language-go">// åˆ›å»ºé’©å­
func (u *User) BeforeCreate(tx *gorm.DB) (err error) {...}
// è·³è¿‡é’©å­
db.Session(&amp;gorm.Session{SkipHooks: true}).CRUD()
</code></pre>
<h4 id="ä½¿ç”¨-sql-è¡¨è¾¾å¼-context-valuer-åˆ›å»ºè®°å½•">ä½¿ç”¨ SQL è¡¨è¾¾å¼ã€Context Valuer åˆ›å»ºè®°å½•</h4>
<p>GORMå…è®¸ä½¿ç”¨SQLè¡¨è¾¾å¼æ¥æ’å…¥æ•°æ®ï¼Œæœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥è¾¾æˆè¯¥ç›®çš„ï¼Œä½¿ç”¨<code>map[string]interface{}</code>æˆ–è€… <a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B4">Customized Data Types</a>ã€‚</p>
<p>TODOï¼šè‡ªå®šä¹‰æ•°æ®ç±»å‹ç›¸å…³<br>
è¿™å—æ²¡çœ‹æ‡‚ï¼Œå›å¤´å†çœ‹ã€‚</p>
<h4 id="upsert">Upsert</h4>
<p>åœ¨ GORM ä¸­ï¼ŒUpsert é€šå¸¸ç”¨äºå¤„ç†ä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š</p>
<ul>
<li><code>Insert On Duplicate Key Update</code>ï¼šå¦‚æœè®°å½•å·²ç»å­˜åœ¨ï¼Œåˆ™æ›´æ–°è¯¥è®°å½•ï¼›å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™æ’å…¥æ–°è®°å½•ã€‚è¿™ç§ç”¨æ³•å’Œ<code>save</code>ç±»ä¼¼ã€‚</li>
</ul>
<pre><code class="language-go">db.Clauses(clause.OnConflict{
  DoNothing: false,
  Columns: []clause.Column{{Name: &quot;id&quot;}},
  DoUpdates: clause.AssignmentColumns([]string{&quot;name&quot;, &quot;email&quot;}),
}).Create(&amp;user)
</code></pre>
<p><code>Insert Ignore</code>ï¼šå¦‚æœè®°å½•å·²ç»å­˜åœ¨ï¼Œåˆ™å¿½ç•¥æ’å…¥æ“ä½œï¼›å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™æ’å…¥æ–°è®°å½•ã€‚</p>
<pre><code class="language-go">db.Clauses(clause.OnConflict{
  DoNothing: true,
  Columns: []clause.Column{{Name: &quot;id&quot;}},
}).Create(&amp;user)
</code></pre>
<h4 id="åˆ›å»ºé«˜çº§é€‰é¡¹">åˆ›å»ºé«˜çº§é€‰é¡¹</h4>
<ul>
<li><strong>å…³è”åˆ›å»º</strong></li>
</ul>
<p>åˆ›å»ºå…³è”æ•°æ®æ—¶ï¼Œå¦‚æœå…³è”å€¼éé›¶ï¼Œè¿™äº›å…³è”ä¼šè¢«<code>upsert</code>ï¼Œå¹¶ä¸”å®ƒä»¬çš„<code>Hooks</code>æ–¹æ³•ä¹Ÿä¼šè¢«è°ƒç”¨ã€‚</p>
<pre><code class="language-go">type CreditCard struct {
  gorm.Model
  Number   string
  UserID   uint
}

type User struct {
  gorm.Model
  Name       string
  CreditCard CreditCard
}

db.Create(&amp;User{
  Name: &quot;jinzhu&quot;,
  CreditCard: CreditCard{Number: &quot;411111111111&quot;}
})
// INSERT INTO `users` ...
// INSERT INTO `credit_cards` ...
</code></pre>
<p>å¯ä»¥é€šè¿‡<code>Select</code>, <code>Omit</code>æ–¹æ³•æ¥è·³è¿‡å…³è”æ›´æ–°ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-go">db.Omit(&quot;CreditCard&quot;).Create(&amp;user)

// skip all associations
db.Omit(clause.Associations).Create(&amp;user)
</code></pre>
<ul>
<li><strong>é»˜è®¤å€¼</strong></li>
</ul>
<p>å¯ä»¥é€šè¿‡ç»“æ„ä½“Tag <code>default</code>æ¥å®šä¹‰å­—æ®µçš„é»˜è®¤å€¼,è¿™äº›é»˜è®¤å€¼ä¼šè¢«å½“ä½œç»“æ„ä½“å­—æ®µçš„é›¶å€¼æ’å…¥åˆ°æ•°æ®åº“ä¸­ã€‚</p>
<pre><code class="language-go">type User struct {
  ID   int64
  Name string `gorm:&quot;default:galeone&quot;`
  Age  int64  `gorm:&quot;default:18&quot;`
}
</code></pre>
<p>ç»“æ„ä½“çš„å­—æ®µé»˜è®¤å€¼æ˜¯é›¶å€¼çš„æ—¶å€™æ¯”å¦‚ 0, '', falseï¼Œè¿™äº›å­—æ®µå€¼å°†ä¸ä¼šè¢«ä¿å­˜åˆ°æ•°æ®åº“ä¸­ï¼Œå¯ä»¥ä½¿ç”¨æŒ‡é’ˆç±»å‹æˆ–è€…Scanner/Valueræ¥é¿å…è¿™ç§æƒ…å†µã€‚</p>
<pre><code class="language-go">type User struct {
  gorm.Model
  Name string
  Age  *int           `gorm:&quot;default:18&quot;`
  Active sql.NullBool `gorm:&quot;default:true&quot;`
}
</code></pre>
<p>è‹¥è¦è®©å­—æ®µåœ¨æ•°æ®åº“ä¸­æ‹¥æœ‰é»˜è®¤å€¼åˆ™å¿…é¡»ä½¿ç”¨<code>default</code>Tagæ¥ä¸ºç»“æ„ä½“å­—æ®µè®¾ç½®é»˜è®¤å€¼ã€‚å¦‚æœæƒ³è¦åœ¨æ•°æ®åº“è¿ç§»çš„æ—¶å€™è·³è¿‡é»˜è®¤å€¼ï¼Œå¯ä»¥ä½¿ç”¨ <code>default:(-)</code>ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-go">type User struct {
  ID        string `gorm:&quot;default:uuid_generate_v3()&quot;` // db func
  FirstName string
  LastName  string
  Age       uint8
  FullName  string `gorm:&quot;-&gt;;type:GENERATED ALWAYS AS (concat(firstname,' ',lastname));default:(-);&quot;`
}
</code></pre>
<h3 id="æŸ¥è¯¢">æŸ¥è¯¢</h3>
<h4 id="æ£€ç´¢å•ä¸ªå¯¹è±¡">æ£€ç´¢å•ä¸ªå¯¹è±¡</h4>
<p>GORM æä¾›äº† <code>First</code>ã€<code>Take</code>ã€<code>Last</code> æ–¹æ³•ï¼Œä»¥ä¾¿ä»æ•°æ®åº“ä¸­æ£€ç´¢å•ä¸ªå¯¹è±¡ã€‚å½“æŸ¥è¯¢æ•°æ®åº“æ—¶å®ƒæ·»åŠ äº† <code>LIMIT 1</code> æ¡ä»¶ï¼Œä¸”æ²¡æœ‰æ‰¾åˆ°è®°å½•æ—¶ï¼Œå®ƒä¼šè¿”å› <code>ErrRecordNotFound</code> é”™è¯¯ã€‚</p>
<pre><code class="language-go">// è·å–ç¬¬ä¸€æ¡è®°å½•ï¼ˆä¸»é”®å‡åºï¼‰
db.First(&amp;user)
// SELECT * FROM users ORDER BY id LIMIT 1;

// è·å–ä¸€æ¡è®°å½•ï¼Œæ²¡æœ‰æŒ‡å®šæ’åºå­—æ®µ
db.Take(&amp;user)
// SELECT * FROM users LIMIT 1;

// è·å–æœ€åä¸€æ¡è®°å½•ï¼ˆä¸»é”®é™åºï¼‰
db.Last(&amp;user)
// SELECT * FROM users ORDER BY id DESC LIMIT 1;

// è·å–å…¨éƒ¨è®°å½•
db.Find(&amp;users)
// // SELECT * FROM users;
</code></pre>
<p><code>First</code> and <code>Last</code> æ–¹æ³•ä¼šæŒ‰ä¸»é”®æ’åºæ‰¾åˆ°ç¬¬ä¸€æ¡å’Œæœ€åä¸€æ¡è®°å½•ã€‚åªæœ‰åœ¨ç›®æ ‡ struct æ˜¯æŒ‡é’ˆæˆ–è€…é€šè¿‡ db.Model() æŒ‡å®š model æ—¶ï¼Œè¯¥æ–¹æ³•æ‰æœ‰æ•ˆã€‚å¦‚æœç›¸å…³ model æ²¡æœ‰å®šä¹‰ä¸»é”®ï¼Œé‚£ä¹ˆå°†æŒ‰ model çš„ç¬¬ä¸€ä¸ªå­—æ®µè¿›è¡Œæ’åºã€‚</p>
<h4 id="æŸ¥æ‰¾å¤±è´¥æ£€æŸ¥">æŸ¥æ‰¾å¤±è´¥æ£€æŸ¥</h4>
<pre><code class="language-go">result := db.First(&amp;user)
result.RowsAffected // è¿”å›æ‰¾åˆ°çš„è®°å½•æ•°
result.Error        // returns error or nil

// æ£€æŸ¥ ErrRecordNotFound é”™è¯¯
errors.Is(result.Error, gorm.ErrRecordNotFound)
</code></pre>
<h4 id="æ ¹æ®ä¸»é”®æŸ¥è¯¢">æ ¹æ®ä¸»é”®æŸ¥è¯¢</h4>
<pre><code class="language-go">db.First(&amp;user,primaryKey)
</code></pre>
<h4 id="æ ¹æ®æ¡ä»¶æŸ¥è¯¢">æ ¹æ®æ¡ä»¶æŸ¥è¯¢</h4>
<p><strong>Stringæ¡ä»¶</strong>ï¼š</p>
<pre><code class="language-go">db.Where(condition,args,...).CRUD()
</code></pre>
<p>ä½¿ç”¨<code>Where</code>æ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºæ¡ä»¶ï¼Œç”¨<code>?</code>å ä½ï¼Œåç»­å‚æ•°ä¸ºå‚æ•°é¡¹ã€‚ç¤ºä¾‹ï¼š</p>
<pre><code class="language-go">// Get first matched record
db.Where(&quot;name = ?&quot;, &quot;jinzhu&quot;).First(&amp;user)
// SELECT * FROM users WHERE name = 'jinzhu' ORDER BY id LIMIT 1;

// Get all matched records
db.Where(&quot;name &lt;&gt; ?&quot;, &quot;jinzhu&quot;).Find(&amp;users)
// SELECT * FROM users WHERE name &lt;&gt; 'jinzhu';

// IN
db.Where(&quot;name IN ?&quot;, []string{&quot;jinzhu&quot;, &quot;jinzhu 2&quot;}).Find(&amp;users)
// SELECT * FROM users WHERE name IN ('jinzhu','jinzhu 2');

// LIKE
db.Where(&quot;name LIKE ?&quot;, &quot;%jin%&quot;).Find(&amp;users)
// SELECT * FROM users WHERE name LIKE '%jin%';

// AND
db.Where(&quot;name = ? AND age &gt;= ?&quot;, &quot;jinzhu&quot;, &quot;22&quot;).Find(&amp;users)
// SELECT * FROM users WHERE name = 'jinzhu' AND age &gt;= 22;

// Time
db.Where(&quot;updated_at &gt; ?&quot;, lastWeek).Find(&amp;users)
// SELECT * FROM users WHERE updated_at &gt; '2000-01-01 00:00:00';

// BETWEEN
db.Where(&quot;created_at BETWEEN ? AND ?&quot;, lastWeek, today).Find(&amp;users)
// SELECT * FROM users WHERE created_at BETWEEN '2000-01-01 00:00:00' AND '2000-01-08 00:00:00';
</code></pre>
<p>å¦‚æœå¯¹è±¡è®¾ç½®äº†ä¸»é”®ï¼Œæ¡ä»¶æŸ¥è¯¢å°†ä¸ä¼šè¦†ç›–ä¸»é”®çš„å€¼ï¼Œè€Œæ˜¯ç”¨ And è¿æ¥æ¡ä»¶ã€‚ ä¾‹å¦‚ï¼š</p>
<pre><code class="language-go">var user = User{ID: 10}
db.Where(&quot;id = ?&quot;, 20).First(&amp;user)
// SELECT * FROM users WHERE id = 10 and id = 20 ORDER BY id ASC LIMIT 1
</code></pre>
<p>è¿™ä¸ªæŸ¥è¯¢å°†ä¼šç»™å‡º<code>record not found</code>é”™è¯¯ æ‰€ä»¥ï¼Œåœ¨æƒ³è¦ä½¿ç”¨ä¾‹å¦‚ user è¿™æ ·çš„å˜é‡ä»æ•°æ®åº“ä¸­è·å–æ–°å€¼å‰ï¼Œéœ€è¦å°†ä¾‹å¦‚ id è¿™æ ·çš„ä¸»é”®è®¾ç½®ä¸º<code>nil</code>ã€‚</p>
<p><strong>Struct &amp; Map æ¡ä»¶</strong>:</p>
<p>ç›´æ¥ä½¿ç”¨ç»“æ„ä½“æŒ‡é’ˆæˆ–mapä½œä¸ºå‚æ•°ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-go">// Struct
db.Where(&amp;User{Name: &quot;jinzhu&quot;, Age: 20}).First(&amp;user)
// SELECT * FROM users WHERE name = &quot;jinzhu&quot; AND age = 20 ORDER BY id LIMIT 1;

// Map
db.Where(map[string]interface{}{&quot;name&quot;: &quot;jinzhu&quot;, &quot;age&quot;: 20}).Find(&amp;users)
// SELECT * FROM users WHERE name = &quot;jinzhu&quot; AND age = 20;

// Slice of primary keys
db.Where([]int64{20, 21, 22}).Find(&amp;users)
// SELECT * FROM users WHERE id IN (20, 21, 22);
</code></pre>
<p>ä½¿ç”¨<code>struct</code>æŸ¥è¯¢æ—¶åªæŸ¥è¯¢<strong>éé›¶é¡¹</strong>ï¼Œå¦‚æœéœ€è¦æŸ¥è¯¢é›¶é¡¹å¯ä»¥æ”¹ç”¨<code>map</code>ã€‚</p>
<pre><code class="language-go">db.Where(&amp;User{Name: &quot;jinzhu&quot;, Age: 0}).Find(&amp;users)
// SELECT * FROM users WHERE name = &quot;jinzhu&quot;;

db.Where(map[string]interface{}{&quot;Name&quot;: &quot;jinzhu&quot;, &quot;Age&quot;: 0}).Find(&amp;users)
// SELECT * FROM users WHERE name = &quot;jinzhu&quot; AND age = 0;
</code></pre>
<p>ä½¿ç”¨<code>struct</code>æŸ¥è¯¢æ—¶å¯ä»¥æŒ‡å®šæŸ¥è¯¢å­—æ®µï¼Œè¿™æ ·ä¹Ÿå¯ä»¥æŸ¥è¯¢é›¶é¡¹ã€‚</p>
<pre><code class="language-go">db.Where(&amp;User{Name: &quot;jinzhu&quot;}, &quot;name&quot;, &quot;Age&quot;).Find(&amp;users)
// SELECT * FROM users WHERE name = &quot;jinzhu&quot; AND age = 0;

db.Where(&amp;User{Name: &quot;jinzhu&quot;}, &quot;Age&quot;).Find(&amp;users)
// SELECT * FROM users WHERE age = 0;
</code></pre>
<p><strong>å†…è”æ¡ä»¶</strong>å’Œ<code>Where</code>æ–¹æ³•å·®ä¸å¤šï¼Œåªæ˜¯æŠŠå‚æ•°å†™åœ¨CRUDé‡Œï¼Œ<code>Not</code>å’Œ<code>Or</code>çš„ç”¨æ³•ä¹Ÿå’ŒWhereå·®ä¸å¤šã€‚</p>
<p><strong>Not</strong>:</p>
<p><code>Not</code>é™¤äº†æŸ¥è¯¢æ¡ä»¶å¤–ï¼Œè¿˜æ”¯æŒnot inï¼Œnot structï¼Œprimary key not inç­‰ã€‚</p>
<pre><code class="language-go">db.Not(&quot;name = ?&quot;, &quot;jinzhu&quot;).First(&amp;user)
// SELECT * FROM users WHERE NOT name = &quot;jinzhu&quot; ORDER BY id LIMIT 1;

// Not In
db.Not(map[string]interface{}{&quot;name&quot;: []string{&quot;jinzhu&quot;, &quot;jinzhu 2&quot;}}).Find(&amp;users)
// SELECT * FROM users WHERE name NOT IN (&quot;jinzhu&quot;, &quot;jinzhu 2&quot;);

// Struct
db.Not(User{Name: &quot;jinzhu&quot;, Age: 18}).First(&amp;user)
// SELECT * FROM users WHERE name &lt;&gt; &quot;jinzhu&quot; AND age &lt;&gt; 18 ORDER BY id LIMIT 1;

// Not In slice of primary keys
db.Not([]int64{1,2,3}).First(&amp;user)
// SELECT * FROM users WHERE id NOT IN (1,2,3) ORDER BY id LIMIT 1;
</code></pre>
<h4 id="é€‰æ‹©ç‰¹å®šå­—æ®µ">é€‰æ‹©ç‰¹å®šå­—æ®µ</h4>
<p>ä½¿ç”¨<code>Select</code>æ–¹æ³•ï¼Œè¯¦è§<a href="#%E6%99%BA%E8%83%BD%E9%80%89%E6%8B%A9%E5%AD%97%E6%AE%B5">æ™ºèƒ½æŸ¥è¯¢å­—æ®µ</a>ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-go">db.Select(&quot;name&quot;, &quot;age&quot;).Find(&amp;users)
// SELECT name, age FROM users;

db.Select([]string{&quot;name&quot;, &quot;age&quot;}).Find(&amp;users)
// SELECT name, age FROM users;

db.Table(&quot;users&quot;).Select(&quot;COALESCE(age,?)&quot;, 42).Rows()
// SELECT COALESCE(age,'42') FROM users;
</code></pre>
<h4 id="æ’åº">æ’åº</h4>
<p>ä½¿ç”¨<code>Order</code>æ–¹æ³•ï¼Œæ”¯æŒå¤šå‚æ•°ï¼Œå¯ä»¥æ‹¼æˆä¸€ä¸ªå­—ç¬¦ä¸²æˆ–è€…é“¾å¼è¿æ¥ã€‚</p>
<pre><code class="language-go">db.Order(&quot;age desc, name&quot;).Find(&amp;users)
// SELECT * FROM users ORDER BY age desc, name;

// Multiple orders
db.Order(&quot;age desc&quot;).Order(&quot;name&quot;).Find(&amp;users)
// SELECT * FROM users ORDER BY age desc, name;

db.Clauses(clause.OrderBy{
  Expression: clause.Expr{SQL: &quot;FIELD(id,?)&quot;, Vars: []interface{}{[]int{1, 2, 3}}, WithoutParentheses: true},
}).Find(&amp;User{})
// SELECT * FROM users ORDER BY FIELD(id,1,2,3)
</code></pre>
<h4 id="limit-offset">Limit &amp; Offset</h4>
<p><code>Limit</code>è¡¨ç¤ºæœ€å¤§é€‰å–å‡ é¡¹ï¼Œ<code>Offset</code>è¡¨ç¤ºè·³è¿‡å‰å‡ é¡¹ã€‚åœ¨é“¾å¼ä¸­ä½¿ç”¨å‚æ•°-1å–æ¶ˆä¹‹å‰çš„è®¾å®šã€‚</p>
<pre><code class="language-go">db.Limit(3).Find(&amp;users)
// SELECT * FROM users LIMIT 3; 

// Cancel limit condition with -1
db.Limit(10).Find(&amp;users1).Limit(-1).Find(&amp;users2)
// SELECT * FROM users LIMIT 10; (users1)
// SELECT * FROM users; (users2)

db.Offset(3).Find(&amp;users)
// SELECT * FROM users OFFSET 3;

db.Limit(10).Offset(5).Find(&amp;users)
// SELECT * FROM users OFFSET 5 LIMIT 10;

// Cancel offset condition with -1
db.Offset(10).Find(&amp;users1).Offset(-1).Find(&amp;users2)
// SELECT * FROM users OFFSET 10; (users1)
// SELECT * FROM users; (users2)
</code></pre>
<h4 id="group-by-having">Group By &amp; Having</h4>
<p><code>Group</code>è¡¨ç¤ºæŒ‰å­—æ®µåˆ†ç»„ï¼Œå¯ä»¥ä½¿ç”¨<code>Having</code>å¯¹åˆ†ç»„ç»“æœè¿›ä¸€æ­¥è¿‡æ»¤ã€‚</p>
<pre><code class="language-go">type result struct {
  Date  time.Time
  Total int
}

db.Model(&amp;User{}).Select(&quot;name, sum(age) as total&quot;).Where(&quot;name LIKE ?&quot;, &quot;group%&quot;).Group(&quot;name&quot;).First(&amp;result)
// SELECT name, sum(age) as total FROM `users` WHERE name LIKE &quot;group%&quot; GROUP BY `name` LIMIT 1


db.Model(&amp;User{}).Select(&quot;name, sum(age) as total&quot;).Group(&quot;name&quot;).Having(&quot;name = ?&quot;, &quot;group&quot;).Find(&amp;result)
// SELECT name, sum(age) as total FROM `users` GROUP BY `name` HAVING name = &quot;group&quot;

rows, err := db.Table(&quot;orders&quot;).Select(&quot;date(created_at) as date, sum(amount) as total&quot;).Group(&quot;date(created_at)&quot;).Rows()
defer rows.Close()
for rows.Next() {
  ...
}

rows, err := db.Table(&quot;orders&quot;).Select(&quot;date(created_at) as date, sum(amount) as total&quot;).Group(&quot;date(created_at)&quot;).Having(&quot;sum(amount) &gt; ?&quot;, 100).Rows()
defer rows.Close()
for rows.Next() {
  ...
}

type Result struct {
  Date  time.Time
  Total int64
}
db.Table(&quot;orders&quot;).Select(&quot;date(created_at) as date, sum(amount) as total&quot;).Group(&quot;date(created_at)&quot;).Having(&quot;sum(amount) &gt; ?&quot;, 100).Scan(&amp;results)
</code></pre>
<h4 id="distinct">Distinct</h4>
<p><code>Distinct</code>è¡¨ç¤ºå»é‡ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-go">db.Distinct(&quot;name&quot;, &quot;age&quot;).Order(&quot;name, age desc&quot;).Find(&amp;results)
/*
SELECT DISTINCT name, age 
FROM users 
ORDER BY name ASC, age DESC;
*/
</code></pre>
<h4 id="joins">Joins</h4>
<p>æŒ‡å®šè¿æ¥æ¡ä»¶ã€‚</p>
<pre><code class="language-go">type result struct {
  Name  string
  Email string
}

db.Model(&amp;User{}).Select(&quot;users.name, emails.email&quot;).Joins(&quot;left join emails on emails.user_id = users.id&quot;).Scan(&amp;result{})
// SELECT users.name, emails.email FROM `users` left join emails on emails.user_id = users.id

rows, err := db.Table(&quot;users&quot;).Select(&quot;users.name, emails.email&quot;).Joins(&quot;left join emails on emails.user_id = users.id&quot;).Rows()
for rows.Next() {
  ...
}

db.Table(&quot;users&quot;).Select(&quot;users.name, emails.email&quot;).Joins(&quot;left join emails on emails.user_id = users.id&quot;).Scan(&amp;results)

// multiple joins with parameter
db.Joins(&quot;JOIN emails ON emails.user_id = users.id AND emails.email = ?&quot;, &quot;jinzhu@example.org&quot;).Joins(&quot;JOIN credit_cards ON credit_cards.user_id = users.id&quot;).Where(&quot;credit_cards.number = ?&quot;, &quot;411111111111&quot;).Find(&amp;user)

</code></pre>
<ul>
<li><strong>Joins é¢„åŠ è½½</strong></li>
</ul>
<p>è¯¦è§ <a href="#%E9%A2%84%E5%8A%A0%E8%BD%BD3">é¢„åŠ è½½</a> ç« èŠ‚ã€‚</p>
<p>è™½ç„¶è¿™é‡Œç›´æ¥å†™çš„Joinsï¼Œä½†æˆ‘è¿˜æ˜¯è§‰å¾—ç”¨Preloadæ›´å¥½ï¼Œè™½ç„¶æˆ‘ä¹Ÿä¸çŸ¥é“æœ‰ä»€ä¹ˆåŒºåˆ«ã€‚</p>
<pre><code class="language-go">db.Joins(&quot;Company&quot;).Find(&amp;users)
// SELECT `users`.`id`,`users`.`name`,`users`.`age`,`Company`.`id` AS `Company__id`,`Company`.`name` AS `Company__name` FROM `users` LEFT JOIN `companies` AS `Company` ON `users`.`company_id` = `Company`.`id`;

// inner join
db.InnerJoins(&quot;Company&quot;).Find(&amp;users)
// SELECT `users`.`id`,`users`.`name`,`users`.`age`,`Company`.`id` AS `Company__id`,`Company`.`name` AS `Company__name` FROM `users` INNER JOIN `companies` AS `Company` ON `users`.`company_id` = `Company`.`id`;

// join with conditions
db.Joins(&quot;Company&quot;, db.Where(&amp;Company{Alive: true})).Find(&amp;users)
// SELECT `users`.`id`,`users`.`name`,`users`.`age`,`Company`.`id` AS `Company__id`,`Company`.`name` AS `Company__name` FROM `users` LEFT JOIN `companies` AS `Company` ON `users`.`company_id` = `Company`.`id` AND `Company`.`alive` = true;
</code></pre>
<ul>
<li><strong>Joins ä¸€ä¸ªæ´¾ç”Ÿè¡¨</strong></li>
</ul>
<p>å¯ä»¥æŠŠæ´¾ç”Ÿè¡¨æ‹†å‡ºæ¥å•ç‹¬å†™ï¼Œä¹‹åä½œä¸ºå‚æ•°æ”¾åˆ°fromé‡Œï¼Œæé«˜äº†å¯è¯»æ€§ã€‚</p>
<pre><code class="language-go">type User struct {
  Id  int
  Age int
}

type Order struct {
  UserId     int
  FinishedAt *time.Time
}

query := db.Table(&quot;order&quot;).Select(&quot;MAX(order.finished_at) as latest&quot;).Joins(&quot;left join user user on order.user_id = user.id&quot;).Where(&quot;user.age &gt; ?&quot;, 18).Group(&quot;order.user_id&quot;)
db.Model(&amp;Order{}).Joins(&quot;join (?) q on order.finished_at = q.latest&quot;, query).Scan(&amp;results)
// SELECT `order`.`user_id`,`order`.`finished_at` FROM `order` join (SELECT MAX(order.finished_at) as latest FROM `order` left join user user on order.user_id = user.id WHERE user.age &gt; 18 GROUP BY `order`.`user_id`) q on order.finished_at = q.latest

</code></pre>
<h4 id="scan">Scan</h4>
<p><code>Scan</code>æ–¹æ³•æŠŠç»“æœè½¬åŒ–æˆç»“æ„ä½“ï¼Œç”¨æ³•ç±»ä¼¼äº<code>Find</code>ã€‚</p>
<pre><code class="language-go">type Result struct {
  Name string
  Age  int
}

var result Result
db.Table(&quot;users&quot;).Select(&quot;name&quot;, &quot;age&quot;).Where(&quot;name = ?&quot;, &quot;Antonio&quot;).Scan(&amp;result)

// Raw SQL
db.Raw(&quot;SELECT name, age FROM users WHERE name = ?&quot;, &quot;Antonio&quot;).Scan(&amp;result)
</code></pre>
<p><strong>Findå’ŒScanåŒºåˆ«</strong>ï¼š</p>
<p><code>Find</code>ï¼š</p>
<ul>
<li>ä¸“é—¨ç”¨äºæŸ¥è¯¢ GORM æ¨¡å‹ç»“æ„ä½“ã€‚</li>
<li>è¿”å›å…·ä½“çš„æ¨¡å‹å®ä¾‹æˆ–æ¨¡å‹åˆ‡ç‰‡ã€‚</li>
<li>é€šå¸¸ç”¨äºå¤„ç†å·²å®šä¹‰å¥½çš„æ¨¡å‹ç»“æ„ã€‚</li>
</ul>
<p><code>Scan</code>ï¼š</p>
<ul>
<li>é€‚ç”¨äºæŸ¥è¯¢ä»»æ„ç±»å‹çš„æ•°æ®ã€‚</li>
<li>å¯ä»¥å°†æŸ¥è¯¢ç»“æœä¿å­˜ä¸º <code>[]map[string]interface{}</code> æˆ–å…¶ä»–è‡ªå®šä¹‰çš„æ•°æ®ç»“æ„ã€‚</li>
<li>æä¾›æ›´é«˜çš„çµæ´»æ€§ï¼Œå°¤å…¶æ˜¯åœ¨å¤„ç†éæ ‡å‡†æ•°æ®ç»“æ„æ—¶ã€‚</li>
</ul>
<h3 id="é«˜çº§æŸ¥è¯¢">é«˜çº§æŸ¥è¯¢</h3>
<p>PS.è¿™ä¸€ç« å†…å®¹æŒºå¤šçš„ï¼Œä½†å…¶å®åªè¦æŒæ¡æœ€åŸºæœ¬çš„æŸ¥è¯¢å°±å¤Ÿç”¨äº†ã€‚å…¶ä»–éƒ½æ˜¯å‘Šè¯‰ä½ æ”¯æŒè¿™æ ·çš„ç‰¹æ€§ï¼Œå¦‚æœçŸ¥é“å¹¶ç”¨ä¸Šä¼šæ›´æ–¹ä¾¿ã€‚ä½†ä¸ªäººæ„Ÿè§‰ï¼Œé¦–å…ˆè¿™ä¹ˆå¤šä¸œè¥¿æ‡’å¾—è®°ï¼Œè®°äº†åˆ°æ—¶å€™ä¹Ÿä¼šå¿˜ã€‚é¡¶å¤šæ‰«ä¸€çœ¼ç•™ä¸ªå°è±¡ï¼Œèƒ½ç”¨ä¸Šæ—¶æƒ³èµ·æ¥å°±è¿‡æ¥çœ‹ä¸€çœ¼ï¼Œæƒ³ä¸èµ·æ¥å°±ç®—äº†ã€‚</p>
<h4 id="æ™ºèƒ½é€‰æ‹©å­—æ®µ">æ™ºèƒ½é€‰æ‹©å­—æ®µ</h4>
<p>åœ¨ GORM ä¸­ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ Select æ–¹æ³•æœ‰æ•ˆåœ°é€‰æ‹©ç‰¹å®šå­—æ®µã€‚ è¿™åœ¨Modelå­—æ®µè¾ƒå¤šä½†åªéœ€è¦å…¶ä¸­éƒ¨åˆ†çš„æ—¶å€™å°¤å…¶æœ‰ç”¨ï¼Œæ¯”å¦‚ç¼–å†™APIå“åº”ã€‚</p>
<pre><code class="language-go">type User struct {
  ID     uint
  Name   string
  Age    int
  Gender string
  // å¾ˆå¤šå¾ˆå¤šå­—æ®µ
}

type APIUser struct {
  ID   uint
  Name string
}

// åœ¨æŸ¥è¯¢æ—¶ï¼ŒGORM ä¼šè‡ªåŠ¨é€‰æ‹© `id `, `name` å­—æ®µ
db.Model(&amp;User{}).Limit(10).Find(&amp;APIUser{})
// SQL: SELECT `id`, `name` FROM `users` LIMIT 10
</code></pre>
<p><strong>æ³¨æ„</strong> åœ¨ QueryFields æ¨¡å¼ä¸­, æ‰€æœ‰çš„æ¨¡å‹å­—æ®µï¼ˆmodel fieldsï¼‰éƒ½ä¼šè¢«æ ¹æ®ä»–ä»¬çš„åå­—é€‰æ‹©ã€‚</p>
<pre><code class="language-go">db, err := gorm.Open(sqlite.Open(&quot;gorm.db&quot;), &amp;gorm.Config{
  QueryFields: true,
})

// å½“ QueryFields è¢«è®¾ç½®ä¸º true æ—¶ï¼Œæ­¤è¡Œä¸ºé»˜è®¤è¿›è¡Œ
db.Find(&amp;user)
// SQL: SELECT `users`.`name`, `users`.`age`, ... FROM `users`

// å¼€å¯ QueryFields å¹¶ä½¿ç”¨ä¼šè¯æ¨¡å¼ï¼ˆSession modeï¼‰
db.Session(&amp;gorm.Session{QueryFields: true}).Find(&amp;user)
// SQL: SELECT `users`.`name`, `users`.`age`, ... FROM `users`
</code></pre>
<h4 id="é”-2">é” ã€2ã€‘</h4>
<p>ä¸€äº›ç®€å•çš„é”æ“ä½œï¼Œæœ‰éœ€è¦å†æŸ¥ã€‚</p>
<pre><code class="language-go">// åŸºæœ¬çš„ FOR UPDATE é”
db.Clauses(clause.Locking{Strength: &quot;UPDATE&quot;}).Find(&amp;users)
// SQL: SELECT * FROM `users` FOR UPDATE
</code></pre>
<p>ä¸Šè¿°è¯­å¥å°†ä¼šåœ¨äº‹åŠ¡ï¼ˆtransactionï¼‰ä¸­é”å®šé€‰ä¸­è¡Œï¼ˆselected rowsï¼‰ã€‚ å¯ä»¥è¢«ç”¨äºä»¥ä¸‹åœºæ™¯ï¼šå½“ä½ å‡†å¤‡åœ¨äº‹åŠ¡ï¼ˆtransactionï¼‰ä¸­æ›´æ–°ï¼ˆupdateï¼‰ä¸€äº›è¡Œï¼ˆrowsï¼‰æ—¶ï¼Œå¹¶ä¸”æƒ³è¦åœ¨æœ¬äº‹åŠ¡å®Œæˆå‰ï¼Œé˜»æ­¢ï¼ˆpreventï¼‰å…¶ä»–çš„äº‹åŠ¡ï¼ˆother transactionsï¼‰ä¿®æ”¹ä½ å‡†å¤‡æ›´æ–°çš„é€‰ä¸­è¡Œã€‚</p>
<p><code>Strength</code> ä¹Ÿå¯ä»¥è¢«è®¾ç½®ä¸º <code>SHARE</code> ï¼Œè¿™ç§é”åªå…è®¸å…¶ä»–äº‹åŠ¡è¯»å–ï¼ˆreadï¼‰è¢«é”å®šçš„å†…å®¹ï¼Œè€Œæ— æ³•ä¿®æ”¹ï¼ˆupdateï¼‰æˆ–è€…åˆ é™¤ï¼ˆdeleteï¼‰ã€‚</p>
<pre><code class="language-go">db.Clauses(clause.Locking{
  Strength: &quot;SHARE&quot;,
  Table: clause.Table{Name: clause.CurrentTable},
}).Find(&amp;users)
// SQL: SELECT * FROM `users` FOR SHARE OF `users`
</code></pre>
<p><code>Table</code>é€‰é¡¹ç”¨äºæŒ‡å®šå°†è¦è¢«é”å®šçš„è¡¨ã€‚ è¿™åœ¨ä½ æƒ³è¦ join å¤šä¸ªè¡¨ï¼Œå¹¶ä¸”é”å®šå…¶ä¸€æ—¶éå¸¸æœ‰ç”¨ã€‚</p>
<p>ä½ ä¹Ÿå¯ä»¥æä¾›å¦‚ <code>NOWAIT</code> çš„Optionsï¼Œè¿™å°†å°è¯•è·å–ä¸€ä¸ªé”ï¼Œå¦‚æœé”ä¸å¯ç”¨ï¼Œå¯¼è‡´äº†è·å–å¤±è´¥ï¼Œå‡½æ•°å°†ä¼šç«‹å³è¿”å›ä¸€ä¸ªerrorã€‚ å½“ä¸€ä¸ªäº‹åŠ¡ç­‰å¾…å…¶ä»–äº‹åŠ¡é‡Šæ”¾å®ƒä»¬çš„é”æ—¶ï¼Œæ­¤Optionsï¼ˆNowaitï¼‰å¯ä»¥é˜»æ­¢è¿™ç§è¡Œä¸º</p>
<pre><code class="language-go">db.Clauses(clause.Locking{
  Strength: &quot;UPDATE&quot;,
  Options: &quot;NOWAIT&quot;,
}).Find(&amp;users)
// SQL: SELECT * FROM `users` FOR UPDATE NOWAIT
</code></pre>
<p>Optionsä¹Ÿå¯ä»¥æ˜¯SKIP LOCKEDï¼Œè®¾ç½®åå°†è·³è¿‡æ‰€æœ‰å·²ç»è¢«å…¶ä»–äº‹åŠ¡é”å®šçš„è¡Œï¼ˆany rows that are already locked by other transactions.ï¼‰ã€‚ è¿™æ¬¡é«˜å¹¶å‘æƒ…å†µä¸‹éå¸¸æœ‰ç”¨ï¼šé‚£æ—¶ä½ å¯èƒ½ä¼šæƒ³è¦å¯¹æœªç»å…¶ä»–äº‹åŠ¡é”å®šçš„è¡Œè¿›è¡Œæ“ä½œï¼ˆprocess ï¼‰ã€‚</p>
<pre><code class="language-go">type User struct {
  ID     uint
  Name   string
  Age    int
  Gender string
  // å¾ˆå¤šå¾ˆå¤šå­—æ®µ
}

type APIUser struct {
  ID   uint
  Name string
}

// åœ¨æŸ¥è¯¢æ—¶ï¼ŒGORM ä¼šè‡ªåŠ¨é€‰æ‹© `id `, `name` å­—æ®µ
db.Model(&amp;User{}).Limit(10).Find(&amp;APIUser{})
// SQL: SELECT `id`, `name` FROM `users` LIMIT 10
</code></pre>
<p><strong>QueryFields</strong>æ¨¡å¼ä¸­é»˜è®¤é€‰æ‹©æ‰€æœ‰å­—æ®µã€‚</p>
<pre><code class="language-go">db, err := gorm.Open(sqlite.Open(&quot;gorm.db&quot;), &amp;gorm.Config{
  QueryFields: true,
})

// å½“ QueryFields è¢«è®¾ç½®ä¸º true æ—¶ï¼Œæ­¤è¡Œä¸ºé»˜è®¤è¿›è¡Œ
db.Find(&amp;user)
// SQL: SELECT `users`.`name`, `users`.`age`, ... FROM `users`

// å¼€å¯ QueryFields å¹¶ä½¿ç”¨ä¼šè¯æ¨¡å¼ï¼ˆSession modeï¼‰
db.Session(&amp;gorm.Session{QueryFields: true}).Find(&amp;user)
// SQL: SELECT `users`.`name`, `users`.`age`, ... FROM `users`
</code></pre>
<h4 id="å­æŸ¥è¯¢">å­æŸ¥è¯¢</h4>
<p>PS.ç®€å•æ¥è¯´ï¼Œå°±æ˜¯å¯ä»¥æŠŠæŸ¥è¯¢è¯­å¥çš„ç»“æœå½“è¡¨å»æŸ¥è¯¢ã€‚</p>
<pre><code class="language-go">// åœ¨ FROM å­å¥ä¸­ä½¿ç”¨å­æŸ¥è¯¢
db.Table(&quot;(?) as u&quot;, db.Model(&amp;User{}).Select(&quot;name&quot;, &quot;age&quot;)).Where(&quot;age = ?&quot;, 18).Find(&amp;User{})
// SQL: SELECT * FROM (SELECT `name`,`age` FROM `users`) as u WHERE `age` = 18

// åœ¨ FROM å­å¥ä¸­ç»“åˆå¤šä¸ªå­æŸ¥è¯¢
subQuery1 := db.Model(&amp;User{}).Select(&quot;name&quot;)
subQuery2 := db.Model(&amp;Pet{}).Select(&quot;name&quot;)
db.Table(&quot;(?) as u, (?) as p&quot;, subQuery1, subQuery2).Find(&amp;User{})
// SQL: SELECT * FROM (SELECT `name` FROM `users`) as u, (SELECT `name` FROM `pets`) as p
</code></pre>
<h4 id="group-æ¡ä»¶">Group æ¡ä»¶</h4>
<pre><code class="language-go">// ä½¿ç”¨ Group æ¡ä»¶çš„å¤æ‚ SQL æŸ¥è¯¢
db.Where(
  db.Where(&quot;pizza = ?&quot;, &quot;pepperoni&quot;).Where(db.Where(&quot;size = ?&quot;, &quot;small&quot;).Or(&quot;size = ?&quot;, &quot;medium&quot;)),
).Or(
  db.Where(&quot;pizza = ?&quot;, &quot;hawaiian&quot;).Where(&quot;size = ?&quot;, &quot;xlarge&quot;),
).Find(&amp;Pizza{})
// SQL: SELECT * FROM `pizzas` WHERE (pizza = &quot;pepperoni&quot; AND (size = &quot;small&quot; OR size = &quot;medium&quot;)) OR (pizza = &quot;hawaiian&quot; AND size = &quot;xlarge&quot;ï¼‰
</code></pre>
<h4 id="å¸¦å¤šä¸ªåˆ—çš„in">å¸¦å¤šä¸ªåˆ—çš„In</h4>
<p>GROM æ”¯æŒå¤šåˆ—çš„ IN å­å¥ï¼ˆthe IN clause with multiple columnsï¼‰ï¼Œå…è®¸ä½ åœ¨å•æ¬¡æŸ¥è¯¢é‡ŒåŸºäºå¤šä¸ªå­—æ®µå€¼ç­›é€‰æ•°æ®ã€‚</p>
<pre><code class="language-go">// å¤šåˆ— IN
db.Where(&quot;(name, age, role) IN ?&quot;, [][]interface{}{{&quot;jinzhu&quot;, 18, &quot;admin&quot;}, {&quot;jinzhu2&quot;, 19, &quot;user&quot;}}).Find(&amp;users)
// SQL: SELECT * FROM users WHERE (name, age, role) IN ((&quot;jinzhu&quot;, 18, &quot;admin&quot;), (&quot;jinzhu 2&quot;, 19, &quot;user&quot;));
</code></pre>
<h4 id="å‘½åå‚æ•°è¯¦è§£">å‘½åå‚æ•°è¯¦è§£</h4>
<p>GORM æ”¯æŒå‘½åçš„å‚æ•°ï¼Œæé«˜SQL æŸ¥è¯¢çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚ æ­¤åŠŸèƒ½ä½¿æŸ¥è¯¢ç»“æ„æ›´åŠ æ¸…æ™°ã€æ›´åŠ æœ‰æ¡ç†ï¼Œå°¤å…¶æ˜¯åœ¨æœ‰å¤šä¸ªå‚æ•°çš„å¤æ‚æŸ¥è¯¢ä¸­ã€‚ å‘½åå‚æ•°å¯ä»¥ä½¿ç”¨ <code>sql.NamedArg</code> æˆ– <code>map[string]interface{}{}}</code>ï¼Œå¯ä»¥æ ¹æ®æŸ¥è¯¢ç»“æ„çµæ´»æä¾›ã€‚</p>
<pre><code class="language-go">// ä½¿ç”¨ sql.NamedArg å‘½åå‚æ•°çš„ä¾‹å­
db.Where(&quot;name1 = @name OR name2 = @name&quot;, sql.Named(&quot;name&quot;, &quot;jinzhu&quot;)).Find(&amp;user)
// SQL: SELECT * FROM `users` WHERE name1 = &quot;jinzhu&quot; OR name2 = &quot;jinzhu&quot;

// ä½¿ç”¨ map å‘½åå‚æ•°çš„ä¾‹å­
db.Where(&quot;name1 = @name OR name2 = @name&quot;, map[string]interface{}{&quot;name&quot;: &quot;jinzhu&quot;}).First(&amp;user)
// SQL: SELECT * FROM `users` WHERE name1 = &quot;jinzhu&quot; OR name2 = &quot;jinzhu&quot; ORDER BY `users`.`id` LIMIT 1
</code></pre>
<p>æ›´å¤šç¤ºä¾‹å’Œè¯¦ç»†ä¿¡æ¯è¯¦è§ <a href="#%E5%8E%9F%E7%94%9Fsql%E5%92%8Csql%E7%94%9F%E6%88%90%E5%99%A8">åŸç”ŸSQLå’ŒSQLç”Ÿæˆå™¨</a> ã€‚</p>
<h4 id="find-è‡³-map">Find è‡³ map</h4>
<p>GORM æä¾›äº†çµæ´»çš„æ•°æ®æŸ¥è¯¢ï¼Œå…è®¸å°†ç»“æœæ‰«æè¿›ï¼ˆscanned intoï¼‰<code>map[string]interface{}</code> or <code>[]map[string]interface{}</code>ï¼Œè¿™å¯¹åŠ¨æ€æ•°æ®ç»“æ„éå¸¸æœ‰ç”¨ã€‚</p>
<p>å½“ä½¿ç”¨ Find To Map æ—¶ï¼Œä¸€å®šè¦åœ¨ä½ çš„æŸ¥è¯¢ä¸­åŒ…å« <code>Model</code> æˆ–è€… <code>Table</code> ï¼Œä»¥æ­¤æ¥æ˜¾å¼åœ°æŒ‡å®šè¡¨åã€‚</p>
<pre><code class="language-go">// æ‰«æç¬¬ä¸€ä¸ªç»“æœåˆ° map with Model ä¸­
result := map[string]interface{}{}
db.Model(&amp;User{}).First(&amp;result, &quot;id = ?&quot;, 1)
// SQL: SELECT * FROM `users` WHERE id = 1 LIMIT 1

// æ‰«æå¤šä¸ªç»“æœåˆ°éƒ¨åˆ† maps with Table ä¸­
var results []map[string]interface{}
db.Table(&quot;users&quot;).Find(&amp;results)
// SQL: SELECT * FROM `users`
</code></pre>
<h4 id="firstorinit">FirstOrInit</h4>
<p>GORM çš„ <code>FirstOrInit</code> æ–¹æ³•ç”¨äºè·å–ä¸ç‰¹å®šæ¡ä»¶åŒ¹é…çš„ç¬¬ä¸€æ¡è®°å½•ï¼Œå¦‚æœæ²¡æœ‰æˆåŠŸè·å–ï¼Œå°±åˆå§‹åŒ–ä¸€ä¸ªæ–°å®ä¾‹ã€‚ è¿™ä¸ªæ–¹æ³•ä¸ç»“æ„å’Œmapæ¡ä»¶å…¼å®¹ï¼Œå¹¶ä¸”åœ¨ä½¿ç”¨ <code>Attrs</code> å’Œ <code>Assign</code> æ–¹æ³•æ—¶æœ‰ç€æ›´å¤šçš„çµæ´»æ€§ã€‚</p>
<pre><code class="language-go">// å¦‚æœæ²¡æ‰¾åˆ° name ä¸º &quot;non_existing&quot; çš„ Userï¼Œå°±åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„ User
var user User
db.FirstOrInit(&amp;user, User{Name: &quot;non_existing&quot;})
// user -&gt; User{Name: &quot;non_existing&quot;} if not found

// æ£€ç´¢åä¸º â€œjinzhuâ€ çš„ User
db.Where(User{Name: &quot;jinzhu&quot;}).FirstOrInit(&amp;user)
// user -&gt; User{ID: 111, Name: &quot;Jinzhu&quot;, Age: 18} if found

// ä½¿ç”¨ map æ¥æŒ‡å®šæœç´¢æ¡ä»¶
db.FirstOrInit(&amp;user, map[string]interface{}{&quot;name&quot;: &quot;jinzhu&quot;})
// user -&gt; User{ID: 111, Name: &quot;Jinzhu&quot;, Age: 18} if found
</code></pre>
<ul>
<li><strong>ä½¿ç”¨ <code>Attrs</code> è¿›è¡Œåˆå§‹åŒ–</strong></li>
</ul>
<p>å½“è®°å½•æœªæ‰¾åˆ°ï¼Œå¯ä»¥ä½¿ç”¨ <code>Attrs</code> æ¥åˆå§‹åŒ–ä¸€ä¸ªæœ‰ç€é¢å¤–å±æ€§çš„ç»“æ„ä½“ã€‚ è¿™äº›å±æ€§åŒ…å«åœ¨æ–°ç»“æ„ä¸­ï¼Œä½†ä¸åœ¨ SQL æŸ¥è¯¢ä¸­ä½¿ç”¨ã€‚</p>
<pre><code class="language-go">// å¦‚æœæ²¡æ‰¾åˆ° Userï¼Œæ ¹æ®æ‰€ç»™æ¡ä»¶å’Œé¢å¤–å±æ€§åˆå§‹åŒ– User
db.Where(User{Name: &quot;non_existing&quot;}).Attrs(User{Age: 20}).FirstOrInit(&amp;user)
// SQL: SELECT * FROM USERS WHERE name = 'non_existing' ORDER BY id LIMIT 1;
// user -&gt; User{Name: &quot;non_existing&quot;, Age: 20} if not found

// å¦‚æœåä¸º â€œJinzhuâ€ çš„ User è¢«æ‰¾åˆ°ï¼Œ`Attrs` ä¼šè¢«å¿½ç•¥
db.Where(User{Name: &quot;Jinzhu&quot;}).Attrs(User{Age: 20}).FirstOrInit(&amp;user)
// SQL: SELECT * FROM USERS WHERE name = 'Jinzhu' ORDER BY id LIMIT 1;
// user -&gt; User{ID: 111, Name: &quot;Jinzhu&quot;, Age: 18} if found
</code></pre>
<ul>
<li><strong>ä¸ºå±æ€§ä½¿ç”¨ <code>Assign</code></strong></li>
</ul>
<p><code>Assign</code> æ–¹æ³•å…è®¸æ‚¨åœ¨ç»“æ„ä¸Šè®¾ç½®å±æ€§ï¼Œä¸ç®¡æ˜¯å¦æ‰¾åˆ°è®°å½•ã€‚ è¿™äº›å±æ€§è®¾å®šåœ¨ç»“æ„ä¸Šï¼Œä½†ä¸ç”¨äºç”Ÿæˆ SQL æŸ¥è¯¢ï¼Œæœ€ç»ˆæ•°æ®ä¸ä¼šè¢«ä¿å­˜åˆ°æ•°æ®åº“ã€‚</p>
<pre><code class="language-go">// æ ¹æ®æ‰€ç»™æ¡ä»¶å’Œåˆ†é…çš„å±æ€§åˆå§‹åŒ–ï¼Œä¸ç®¡è®°å½•æ˜¯å¦å­˜åœ¨
db.Where(User{Name: &quot;non_existing&quot;}).Assign(User{Age: 20}).FirstOrInit(&amp;user)
// user -&gt; User{Name: &quot;non_existing&quot;, Age: 20} if not found

// å¦‚æœæ‰¾åˆ°äº†åä¸ºâ€œJinzhuâ€çš„ç”¨æˆ·ï¼Œä½¿ç”¨åˆ†é…çš„å±æ€§æ›´æ–°ç»“æ„ä½“
db.Where(User{Name: &quot;Jinzhu&quot;}).Assign(User{Age: 20}).FirstOrInit(&amp;user)
// SQL: SELECT * FROM USERS WHERE name = 'Jinzhu' ORDER BY id LIMIT 1;
// user -&gt; User{ID: 111, Name: &quot;Jinzhu&quot;, Age: 20} if found
</code></pre>
<p><code>FirstOrInit</code>, ä»¥åŠ <code>Attrs</code> å’Œ <code>Assign</code>, æä¾›äº†ä¸€ç§å¼ºå¤§å’Œçµæ´»çš„æ–¹æ³•æ¥ç¡®ä¿è®°å½•çš„å­˜åœ¨ï¼Œå¹¶ä¸”åœ¨ä¸€ä¸ªæ­¥éª¤ä¸­ä»¥ç‰¹å®šçš„å±æ€§åˆå§‹åŒ–æˆ–æ›´æ–°ã€‚</p>
<h4 id="firstorcreate">FirstOrCreate</h4>
<p><code>FirstOrCreate</code> ç”¨äºè·å–ä¸ç‰¹å®šæ¡ä»¶åŒ¹é…çš„ç¬¬ä¸€æ¡è®°å½•ï¼Œæˆ–è€…å¦‚æœæ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„è®°å½•ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„è®°å½•ã€‚ è¿™ä¸ªæ–¹æ³•åœ¨ç»“æ„å’Œmapæ¡ä»¶ä¸‹éƒ½æ˜¯æœ‰æ•ˆçš„ã€‚ <code>RowsAffected</code> å±æ€§æœ‰åŠ©äºç¡®å®šåˆ›å»ºæˆ–æ›´æ–°è®°å½•çš„æ•°é‡ã€‚</p>
<pre><code class="language-go">// å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°±åˆ›å»ºä¸€ä¸ªæ–°çºªå½•
result := db.FirstOrCreate(&amp;user, User{Name: &quot;non_existing&quot;})
// SQL: INSERT INTO &quot;users&quot; (name) VALUES (&quot;non_existing&quot;);
// user -&gt; User{ID: 112, Name: &quot;non_existing&quot;}
// result.RowsAffected // =&gt; 1 (record created)

// å¦‚æœç”¨æˆ·å·²ç»è¢«æ‰¾åˆ°ï¼Œä¸ä¼šåˆ›å»ºæ–°çºªå½•
result = db.Where(User{Name: &quot;jinzhu&quot;}).FirstOrCreate(&amp;user)
// user -&gt; User{ID: 111, Name: &quot;jinzhu&quot;, Age: 18}
// result.RowsAffected // =&gt; 0 (no record created)
</code></pre>
<ul>
<li><strong>é…åˆ <code>Attrs</code> ä½¿ç”¨ FirstOrCreate</strong></li>
</ul>
<p><code>Attrs</code> å¯ä»¥ç”¨äºæŒ‡å®šæ–°è®°å½•çš„é™„åŠ å±æ€§ã€‚ è¿™äº›å±æ€§ç”¨äºåˆ›å»ºï¼Œä½†ä¸åœ¨åˆå§‹æœç´¢æŸ¥è¯¢ä¸­ã€‚</p>
<pre><code class="language-go">// å¦‚æœæ²¡æ‰¾åˆ°ï¼Œæ ¹æ®é¢å¤–å±æ€§åˆ›å»ºæ–°çš„è®°å½•
db.Where(User{Name: &quot;non_existing&quot;}).Attrs(User{Age: 20}).FirstOrCreate(&amp;user)
// SQL: SELECT * FROM users WHERE name = 'non_existing';
// SQL: INSERT INTO &quot;users&quot; (name, age) VALUES (&quot;non_existing&quot;, 20);
// user -&gt; User{ID: 112, Name: &quot;non_existing&quot;, Age: 20}

// å¦‚æœuserè¢«æ‰¾åˆ°äº†ï¼Œ`Attrs` ä¼šè¢«å¿½ç•¥
db.Where(User{Name: &quot;jinzhu&quot;}).Attrs(User{Age: 20}).FirstOrCreate(&amp;user)
// SQL: SELECT * FROM users WHERE name = 'jinzhu';
// user -&gt; User{ID: 111, Name: &quot;jinzhu&quot;, Age: 18}
</code></pre>
<ul>
<li><strong>é…åˆ <code>Assign</code> ä½¿ç”¨ FirstOrCreate</strong></li>
</ul>
<pre><code class="language-go">// å¦‚æœæ²¡æ‰¾åˆ°è®°å½•ï¼Œé€šè¿‡ `Assign` å±æ€§ åˆå§‹åŒ–å¹¶ä¸”ä¿å­˜æ–°çš„è®°å½•
db.Where(User{Name: &quot;non_existing&quot;}).Assign(User{Age: 20}).FirstOrCreate(&amp;user)
// SQL: SELECT * FROM users WHERE name = 'non_existing';
// SQL: INSERT INTO &quot;users&quot; (name, age) VALUES (&quot;non_existing&quot;, 20);
// user -&gt; User{ID: 112, Name: &quot;non_existing&quot;, Age: 20}

// é€šè¿‡ `Assign` å±æ€§ æ›´æ–°è®°å½•
db.Where(User{Name: &quot;jinzhu&quot;}).Assign(User{Age: 20}).FirstOrCreate(&amp;user)
// SQL: SELECT * FROM users WHERE name = 'jinzhu';
// SQL: UPDATE users SET age=20 WHERE id = 111;
// user -&gt; User{ID: 111, Name: &quot;Jinzhu&quot;, Age: 20}
</code></pre>
<h4 id="ä¼˜åŒ–å™¨-ç´¢å¼•æç¤º4">ä¼˜åŒ–å™¨ã€ç´¢å¼•æç¤ºã€4ã€‘</h4>
<p>PS.ç•¥ï¼ŒClauseså’Œhintsä»€ä¹ˆçš„ï¼Œçˆ±å’‹å’‹åœ°ã€‚æ„Ÿå…´è¶£è‡ªå·±æŸ¥æ–‡æ¡£ã€‚é«˜çº§ä¸»é¢˜-æç¤ºã€‚</p>
<h4 id="è¿­ä»£">è¿­ä»£</h4>
<p>GORM æ”¯æŒä½¿ç”¨ <code>Rows</code> æ–¹æ³•å¯¹æŸ¥è¯¢ç»“æœè¿›è¡Œè¿­ä»£ã€‚æ‚¨å¯ä»¥é€šè¿‡å¯¹æŸ¥è¯¢è¿”å›çš„è¡Œè¿›è¡Œè¿­ä»£ï¼Œæ‰«ææ¯è¡Œåˆ°ä¸€ä¸ªç»“æ„ä½“ä¸­ã€‚ è¯¥æ–¹æ³•æä¾›äº†å¯¹å¦‚ä½•å¤„ç†æ¯æ¡è®°å½•çš„ç²’åº¦æ§åˆ¶ã€‚ï¼ˆgranular controlï¼‰ã€‚</p>
<pre><code class="language-go">`rows`, err := db.Model(&amp;User{}).Where(&quot;name = ?&quot;, &quot;jinzhu&quot;).Rows()
defer rows.Close()

for rows.Next() {
  var user User
  // ScanRows æ‰«ææ¯ä¸€è¡Œè¿›ç»“æ„ä½“
  db.ScanRows(rows, &amp;user)

  // å¯¹æ¯ä¸€ä¸ª User è¿›è¡Œæ“ä½œ
}
</code></pre>
<h4 id="findinbatches">FindInBatches</h4>
<p><code>FindInBatches</code> å…è®¸åˆ†æ‰¹æŸ¥è¯¢å’Œå¤„ç†è®°å½•ã€‚ è¿™å¯¹äºæœ‰æ•ˆåœ°å¤„ç†å¤§å‹æ•°æ®é›†ã€å‡å°‘å†…å­˜ä½¿ç”¨å’Œæé«˜æ€§èƒ½å°¤å…¶æœ‰ç”¨ã€‚</p>
<pre><code class="language-go">// å¤„ç†è®°å½•ï¼Œæ‰¹å¤„ç†å¤§å°ä¸º100
result := db.Where(&quot;processed = ?&quot;, false).FindInBatches(&amp;results, 100, func(tx *gorm.DB, batch int) error {
  for _, result := range results {
    // å¯¹æ‰¹ä¸­çš„æ¯æ¡è®°å½•è¿›è¡Œæ“ä½œ
  }

  // ä¿å­˜å¯¹å½“å‰æ‰¹è®°å½•çš„ä¿®æ”¹
  tx.Save(&amp;results)

  // tx.RowsAffected æä¾›å½“å‰æ‰¹å¤„ç†ä¸­è®°å½•çš„è®¡æ•°ï¼ˆthe count of records in the current batchï¼‰
  // 'batch' å˜é‡è¡¨ç¤ºå½“å‰æ‰¹å·ï¼ˆthe current batch numberï¼‰

  // è¿”å› error å°†é˜»æ­¢æ›´å¤šçš„æ‰¹å¤„ç†
  return nil
})

// result.Error åŒ…å«æ‰¹å¤„ç†è¿‡ç¨‹ä¸­é‡åˆ°çš„ä»»ä½•é”™è¯¯
// result.RowsAffected æä¾›è·¨æ‰¹å¤„ç†çš„æ‰€æœ‰è®°å½•çš„è®¡æ•°ï¼ˆthe count of all processed records across batchesï¼‰

</code></pre>
<h4 id="æŸ¥è¯¢é’©å­">æŸ¥è¯¢é’©å­</h4>
<p>ç±»ä¼¼è§¦å‘å™¨çš„å‡½æ•°ï¼Œä½†é™å®šè§¦å‘æ¡ä»¶ç”¨é€”è¾ƒçª„ã€‚è¯¦æƒ…çœ‹<a href="#%E9%92%A9%E5%AD%902">Hooks</a>éƒ¨åˆ†ã€‚</p>
<pre><code class="language-go">func (u *User) AfterFind(tx *gorm.DB) (err error) {
  // åœ¨æ‰¾åˆ° user åè‡ªå®šä¹‰é€»è¾‘
  if u.Role == &quot;&quot; {
    u.Role = &quot;user&quot; // å¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œå°†è®¾ç½®é»˜è®¤ role
  }
  return
}

// å½“ç”¨æˆ·è¢«æŸ¥è¯¢æ—¶ï¼Œä¼šè‡ªåŠ¨ä½¿ç”¨AfterFindé’©å­
</code></pre>
<h4 id="pluckæ–¹æ³•3">Pluckæ–¹æ³•ã€3ã€‘</h4>
<p>GORM ä¸­çš„ <code>Pluck</code> æ–¹æ³•ç”¨äºä»æ•°æ®åº“ä¸­æŸ¥è¯¢<strong>å•åˆ—</strong>å¹¶æ‰«æç»“æœåˆ°ç‰‡æ®µï¼ˆsliceï¼‰ã€‚ å½“æ‚¨éœ€è¦ä»æ¨¡å‹ä¸­æ£€ç´¢ç‰¹å®šå­—æ®µæ—¶ï¼Œæ­¤æ–¹æ³•éå¸¸ç†æƒ³ã€‚å¦‚æœéœ€è¦æŸ¥è¯¢å¤šä¸ªåˆ—ï¼Œå¯ä»¥ä½¿ç”¨ <code>Select</code> é…åˆ <code>Scan</code> æˆ–è€… <code>Find</code> æ¥ä»£æ›¿ã€‚</p>
<p>PS.è¿™ä¸ªæ–¹æ³•ç‰¹åˆ«å¥½ç”¨ï¼Œå¼ºçƒˆæ¨èã€‚ä¸€èˆ¬æŸ¥è¯¢ç»“æœéƒ½æ˜¯è¿”å›è¡Œï¼Œä½†è¿™ä¸ªæŸ¥è¯¢è¿”å›åˆ—ï¼Œçœçš„å¤„ç†è¡ŒæŸ¥è¯¢ç»“æœäº†ï¼Œåº”ç”¨åœºæ™¯å¾ˆå¹¿ã€‚æ–‡æ¡£æŠŠå®ƒæ”¾åœ¨è¿™ä¹ˆåé¢å®åœ¨æœ‰ç‚¹åŸ‹æ²¡äº†ã€‚</p>
<pre><code class="language-go">// æ£€ç´¢æ‰€æœ‰ç”¨æˆ·çš„ age
var ages []int64
db.Model(&amp;User{}).Pluck(&quot;age&quot;, &amp;ages)

// æ£€ç´¢æ‰€æœ‰ç”¨æˆ·çš„ name
var names []string
db.Model(&amp;User{}).Pluck(&quot;name&quot;, &amp;names)

// ä»ä¸åŒçš„è¡¨ä¸­æ£€ç´¢ name
db.Table(&quot;deleted_users&quot;).Pluck(&quot;name&quot;, &amp;names)

// ä½¿ç”¨Distinctå’ŒPluck
db.Model(&amp;User{}).Distinct().Pluck(&quot;Name&quot;, &amp;names)
// SQL: SELECT DISTINCT `name` FROM `users`

// å¤šåˆ—æŸ¥è¯¢
db.Select(&quot;name&quot;, &quot;age&quot;).Scan(&amp;users)
db.Select(&quot;name&quot;, &quot;age&quot;).Find(&amp;users)
</code></pre>
<h4 id="scopeæ–¹æ³•">Scopeæ–¹æ³•</h4>
<p>PS.æˆ‘ä¸€èˆ¬éƒ½æ˜¯å†™å¸¦å‡ ä¸ªé“¾å¼æ–¹æ³•çš„*gorm.DBå˜é‡ï¼Œè¦ç”¨æ—¶ç›´æ¥æ¥åœ¨åé¢å°±è¡Œã€‚ä¸è¿‡è¿™ä¸ªæ–¹æ³•ç¡®å®åˆæ›´å¥½çš„ç»“æ„å’Œå¯ç»´æŠ¤æ€§ï¼Œå°±æ˜¯æœ‰ç‚¹ç¹çã€‚</p>
<p>GORMä¸­çš„ <code>Scopes</code> æ˜¯ä¸€ä¸ªå¼ºå¤§çš„ç‰¹æ€§ï¼Œå®ƒå…è®¸å°†å¸¸ç”¨çš„æŸ¥è¯¢æ¡ä»¶å®šä¹‰ä¸ºå¯é‡ç”¨çš„æ–¹æ³•ã€‚ è¿™äº›ä½œç”¨åŸŸå¯ä»¥å¾ˆå®¹æ˜“åœ°åœ¨æŸ¥è¯¢ä¸­å¼•ç”¨ï¼Œä»è€Œä½¿ä»£ç æ›´åŠ æ¨¡å—åŒ–å’Œå¯è¯»ã€‚</p>
<ul>
<li>å®šä¹‰Scopes</li>
</ul>
<p><code>Scopes</code> è¢«å®šä¹‰ä¸ºè¢«ä¿®æ”¹åè¿”å›ä¸€ä¸ª gorm.DB å®ä¾‹çš„å‡½æ•°ã€‚ å¯ä»¥æ ¹æ®åº”ç”¨ç¨‹åºçš„éœ€è¦å®šä¹‰å„ç§æ¡ä»¶ä½œä¸ºèŒƒå›´ã€‚</p>
<pre><code class="language-go">// Scope for filtering records where amount is greater than 1000
func AmountGreaterThan1000(db *gorm.DB) *gorm.DB {
  return db.Where(&quot;amount &gt; ?&quot;, 1000)
}

// Scope for orders paid with a credit card
func PaidWithCreditCard(db *gorm.DB) *gorm.DB {
  return db.Where(&quot;pay_mode_sign = ?&quot;, &quot;C&quot;)
}

// Scope for orders paid with cash on delivery (COD)
func PaidWithCod(db *gorm.DB) *gorm.DB {
  return db.Where(&quot;pay_mode_sign = ?&quot;, &quot;COD&quot;)
}

// Scope for filtering orders by status
func OrderStatus(status []string) func(db *gorm.DB) *gorm.DB {
  return func(db *gorm.DB) *gorm.DB {
    return db.Where(&quot;status IN (?)&quot;, status)
  }
}
</code></pre>
<ul>
<li>åœ¨æŸ¥è¯¢ä¸­ä½¿ç”¨Scopes</li>
</ul>
<p>å¯ä»¥é€šè¿‡ Scopes æ–¹æ³•ä½¿ç”¨ä¸€ä¸ªæˆ–è€…å¤šä¸ª Scope æ¥æŸ¥è¯¢ã€‚ï¼Œä»è€ŒåŠ¨æ€åœ°è¿æ¥å¤šä¸ªæ¡ä»¶ã€‚</p>
<pre><code class="language-go">// ä½¿ç”¨ scopes æ¥å¯»æ‰¾æ‰€æœ‰çš„ é‡‘é¢å¤§äº1000çš„ä¿¡ç”¨å¡è®¢å•
db.Scopes(AmountGreaterThan1000, PaidWithCreditCard).Find(&amp;orders)

// ä½¿ç”¨ scopes æ¥å¯»æ‰¾æ‰€æœ‰çš„ é‡‘é¢å¤§äº1000çš„è´§åˆ°ä»˜æ¬¾ï¼ˆCODï¼‰è®¢å•
db.Scopes(AmountGreaterThan1000, PaidWithCod).Find(&amp;orders)

//ä½¿ç”¨ scopes æ¥å¯»æ‰¾æ‰€æœ‰çš„ å…·æœ‰ç‰¹å®šçŠ¶æ€ä¸”é‡‘é¢å¤§äº1000çš„è®¢å•
db.Scopes(AmountGreaterThan1000, OrderStatus([]string{&quot;paid&quot;, &quot;shipped&quot;})).Find(&amp;orders)
</code></pre>
<p><code>Scopes</code> æ˜¯å°è£…æ™®é€šæŸ¥è¯¢é€»è¾‘çš„ä¸€ç§å¹²å‡€è€Œæœ‰æ•ˆçš„æ–¹å¼ï¼Œå¢å¼ºäº†ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œå¯è¯»æ€§ã€‚ æ›´è¯¦ç»†çš„ç¤ºä¾‹å’Œç”¨æ³•è¯¦è§æ–‡æ¡£ä¸­çš„ <a href="#scope3">Scope</a>çš„ <strong>èŒƒå›´</strong> éƒ¨åˆ†ã€‚</p>
<h4 id="count">Count</h4>
<p>GORMä¸­çš„ <code>Count</code> æ–¹æ³•ç”¨äºæ£€ç´¢åŒ¹é…ç»™å®šæŸ¥è¯¢çš„è®°å½•æ•°ã€‚ è¿™æ˜¯äº†è§£æ•°æ®é›†å¤§å°çš„ä¸€ä¸ªæœ‰ç”¨çš„åŠŸèƒ½ï¼Œç‰¹åˆ«æ˜¯åœ¨æ¶‰åŠæœ‰æ¡ä»¶æŸ¥è¯¢æˆ–æ•°æ®åˆ†æçš„æƒ…å†µä¸‹ã€‚</p>
<ul>
<li><strong>å¾—åˆ°åŒ¹é…è®°å½•çš„ Count</strong></li>
</ul>
<p>å¯ä»¥ä½¿ç”¨ <code>Count</code> æ¥ç¡®å®šç¬¦åˆæ‚¨çš„æŸ¥è¯¢ä¸­ç¬¦åˆç‰¹å®šæ ‡å‡†çš„è®°å½•çš„æ•°é‡ã€‚</p>
<pre><code class="language-go">var count int64

// è®¡æ•° æœ‰ç€ç‰¹å®šåå­—çš„ users
db.Model(&amp;User{}).Where(&quot;name = ?&quot;, &quot;jinzhu&quot;).Or(&quot;name = ?&quot;, &quot;jinzhu 2&quot;).Count(&amp;count)
// SQL: SELECT count(1) FROM users WHERE name = 'jinzhu' OR name = 'jinzhu 2'

// è®¡æ•° æœ‰ç€å•ä¸€åå­—æ¡ä»¶ï¼ˆsingle name conditionï¼‰çš„ users
db.Model(&amp;User{}).Where(&quot;name = ?&quot;, &quot;jinzhu&quot;).Count(&amp;count)
// SQL: SELECT count(1) FROM users WHERE name = 'jinzhu'

// åœ¨ä¸åŒçš„è¡¨ä¸­å¯¹è®°å½•è®¡æ•°
db.Table(&quot;deleted_users&quot;).Count(&amp;count)
// SQL: SELECT count(1) FROM deleted_users
</code></pre>
<ul>
<li><strong>é…åˆ Distinct å’Œ Group ä½¿ç”¨ Count</strong></li>
</ul>
<p>GORMè¿˜å…è®¸å¯¹ä¸åŒçš„å€¼è¿›è¡Œè®¡æ•°å¹¶å¯¹ç»“æœè¿›è¡Œåˆ†ç»„ã€‚</p>
<pre><code class="language-go">// ä¸ºä¸åŒ name è®¡æ•°
db.Model(&amp;User{}).Distinct(&quot;name&quot;).Count(&amp;count)
// SQL: SELECT COUNT(DISTINCT(`name`)) FROM `users`

// ä½¿ç”¨è‡ªå®šä¹‰é€‰æ‹©ï¼ˆcustom selectï¼‰è®¡æ•°ä¸åŒçš„å€¼
db.Table(&quot;deleted_users&quot;).Select(&quot;count(distinct(name))&quot;).Count(&amp;count)
// SQL: SELECT count(distinct(name)) FROM deleted_users

// åˆ†ç»„è®°å½•è®¡æ•°
users := []User{
  {Name: &quot;name1&quot;},
  {Name: &quot;name2&quot;},
  {Name: &quot;name3&quot;},
  {Name: &quot;name3&quot;},
}

db.Model(&amp;User{}).Group(&quot;name&quot;).Count(&amp;count)
// æŒ‰åç§°åˆ†ç»„åè®¡æ•°
// count =&gt; 3
</code></pre>
<h3 id="æ›´æ–°">æ›´æ–°</h3>
<h4 id="ä¿å­˜æ‰€æœ‰å­—æ®µ">ä¿å­˜æ‰€æœ‰å­—æ®µ</h4>
<p><code>Save</code>ä¼šä¿å­˜æ‰€æœ‰çš„å­—æ®µï¼Œå³ä½¿å­—æ®µæ˜¯é›¶å€¼ã€‚</p>
<pre><code class="language-go">db.First(&amp;user)

user.Name = &quot;jinzhu 2&quot;
user.Age = 100
db.Save(&amp;user)
// UPDATE users SET name='jinzhu 2', age=100, birthday='2016-01-01', updated_at = '2013-11-17 21:34:10' WHERE id=111;

</code></pre>
<p><code>Save</code>æ˜¯ä¸€ä¸ªç»„åˆå‡½æ•°ã€‚ å¦‚æœä¿å­˜å€¼ä¸åŒ…å«ä¸»é”®ï¼Œå®ƒå°†æ‰§è¡Œ Createï¼Œå¦åˆ™å®ƒå°†æ‰§è¡Œ Update (åŒ…å«æ‰€æœ‰å­—æ®µ)ã€‚</p>
<pre><code class="language-go">db.Save(&amp;User{Name: &quot;jinzhu&quot;, Age: 100})
// INSERT INTO `users` (`name`,`age`,`birthday`,`update_at`) VALUES (&quot;jinzhu&quot;,100,&quot;0000-00-00 00:00:00&quot;,&quot;0000-00-00 00:00:00&quot;)

db.Save(&amp;User{ID: 1, Name: &quot;jinzhu&quot;, Age: 100})
// UPDATE `users` SET `name`=&quot;jinzhu&quot;,`age`=100,`birthday`=&quot;0000-00-00 00:00:00&quot;,`update_at`=&quot;0000-00-00 00:00:00&quot; WHERE `id` = 1
</code></pre>
<p><strong>NOTE:</strong> è¦å°† <code>Save</code> å’Œ <code>Model</code> ä¸€åŒä½¿ç”¨, è¿™æ˜¯ æœªå®šä¹‰çš„è¡Œä¸ºã€‚</p>
<h4 id="æ›´æ–°å•ä¸ªåˆ—">æ›´æ–°å•ä¸ªåˆ—</h4>
<p>å½“ä½¿ç”¨ <code>Update</code> æ›´æ–°å•åˆ—æ—¶ï¼Œéœ€è¦æœ‰ä¸€äº›æ¡ä»¶ï¼Œå¦åˆ™å°†ä¼šå¼•èµ·<code>ErrMissingWhereClause</code> é”™è¯¯ï¼ŒæŸ¥çœ‹<a href="#%E6%89%B9%E9%87%8F%E6%9B%B4%E6%96%B0">æ‰¹é‡æ›´æ–°</a>çš„<strong>é˜»æ­¢å…¨å±€æ›´æ–°</strong>äº†è§£è¯¦æƒ…ã€‚<br>
å½“ä½¿ç”¨ <code>Model</code> æ–¹æ³•ï¼Œå¹¶ä¸”å®ƒæœ‰ä¸»é”®å€¼æ—¶ï¼Œä¸»é”®å°†ä¼šè¢«ç”¨äºæ„å»ºæ¡ä»¶ï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-go">// æ ¹æ®æ¡ä»¶æ›´æ–°
db.Model(&amp;User{}).Where(&quot;active = ?&quot;, true).Update(&quot;name&quot;, &quot;hello&quot;)
// UPDATE users SET name='hello', updated_at='2013-11-17 21:34:10' WHERE active=true;

// User çš„ ID æ˜¯ `111`
db.Model(&amp;user).Update(&quot;name&quot;, &quot;hello&quot;)
// UPDATE users SET name='hello', updated_at='2013-11-17 21:34:10' WHERE id=111;

// æ ¹æ®æ¡ä»¶å’Œ model çš„å€¼è¿›è¡Œæ›´æ–°
db.Model(&amp;user).Where(&quot;active = ?&quot;, true).Update(&quot;name&quot;, &quot;hello&quot;)
// UPDATE users SET name='hello', updated_at='2013-11-17 21:34:10' WHERE id=111 AND active=true;
</code></pre>
<p>è¿™é‡Œåªä¸¾ä¾‹äº†<code>Update</code>çš„ä½¿ç”¨æ–¹æ³•ï¼Œå´æ²¡æœ‰è®²æ¸…æ¥šä»–æåˆ°çš„é‚£ä¸ªé”™è¯¯æ€ä¹ˆå¼•èµ·æ€ä¹ˆæ£€æµ‹æ€ä¹ˆè§£å†³ï¼Œå…·ä½“çœ‹ä¸‹é¢<a href="#%E6%89%B9%E9%87%8F%E6%9B%B4%E6%96%B0">æ‰¹é‡æ›´æ–°</a>çš„<strong>é˜»æ­¢å…¨å±€æ›´æ–°</strong>éƒ¨åˆ†ã€‚</p>
<h4 id="æ›´æ–°å¤šåˆ—">æ›´æ–°å¤šåˆ—</h4>
<p><code>Updates</code> æ–¹æ³•æ”¯æŒ <code>struct</code> å’Œ <code>map[string]interface{}</code> å‚æ•°ã€‚å½“ä½¿ç”¨ struct æ›´æ–°æ—¶ï¼Œé»˜è®¤æƒ…å†µä¸‹GORM <strong>åªæ›´æ–°éé›¶å€¼</strong>çš„å­—æ®µã€‚</p>
<pre><code class="language-go">// æ ¹æ® `struct` æ›´æ–°å±æ€§ï¼Œåªä¼šæ›´æ–°éé›¶å€¼çš„å­—æ®µ
db.Model(&amp;user).Updates(User{Name: &quot;hello&quot;, Age: 18, Active: false})
// UPDATE users SET name='hello', age=18, updated_at = '2013-11-17 21:34:10' WHERE id = 111;

// æ ¹æ® `map` æ›´æ–°å±æ€§
db.Model(&amp;user).Updates(map[string]interface{}{&quot;name&quot;: &quot;hello&quot;, &quot;age&quot;: 18, &quot;active&quot;: false})
// UPDATE users SET name='hello', age=18, active=false, updated_at='2013-11-17 21:34:10' WHERE id=111;

</code></pre>
<h4 id="æ›´æ–°é€‰å®šå­—æ®µ">æ›´æ–°é€‰å®šå­—æ®µ</h4>
<p>å¦‚æœæƒ³è¦åœ¨æ›´æ–°æ—¶é€‰æ‹©ã€å¿½ç•¥æŸäº›å­—æ®µï¼Œå¯ä»¥ä½¿ç”¨ <code>Select</code>ã€<code>Omit</code>ã€‚</p>
<pre><code class="language-go">// é€‰æ‹© Map çš„å­—æ®µ
// User çš„ ID æ˜¯ `111`:
db.Model(&amp;user).Select(&quot;name&quot;).Updates(map[string]interface{}{&quot;name&quot;: &quot;hello&quot;, &quot;age&quot;: 18, &quot;active&quot;: false})
// UPDATE users SET name='hello' WHERE id=111;

db.Model(&amp;user).Omit(&quot;name&quot;).Updates(map[string]interface{}{&quot;name&quot;: &quot;hello&quot;, &quot;age&quot;: 18, &quot;active&quot;: false})
// UPDATE users SET age=18, active=false, updated_at='2013-11-17 21:34:10' WHERE id=111;

// é€‰æ‹© Struct çš„å­—æ®µï¼ˆä¼šé€‰ä¸­é›¶å€¼çš„å­—æ®µï¼‰
db.Model(&amp;user).Select(&quot;Name&quot;, &quot;Age&quot;).Updates(User{Name: &quot;new_name&quot;, Age: 0})
// UPDATE users SET name='new_name', age=0 WHERE id=111;

// é€‰æ‹©æ‰€æœ‰å­—æ®µï¼ˆé€‰æ‹©åŒ…æ‹¬é›¶å€¼å­—æ®µçš„æ‰€æœ‰å­—æ®µï¼‰
db.Model(&amp;user).Select(&quot;*&quot;).Updates(User{Name: &quot;jinzhu&quot;, Role: &quot;admin&quot;, Age: 0})

// é€‰æ‹©é™¤ Role å¤–çš„æ‰€æœ‰å­—æ®µï¼ˆåŒ…æ‹¬é›¶å€¼å­—æ®µçš„æ‰€æœ‰å­—æ®µï¼‰
db.Model(&amp;user).Select(&quot;*&quot;).Omit(&quot;Role&quot;).Updates(User{Name: &quot;jinzhu&quot;, Role: &quot;admin&quot;, Age: 0})
</code></pre>
<h4 id="æ›´æ–°hook">æ›´æ–°Hook</h4>
<p>çœ‹ <a href="#hook">é’©å­</a> ä¸€èŠ‚å§ï¼Œè¿™é‡Œå†™äº†å’Œæ²¡å†™ä¸€æ ·ã€‚</p>
<h4 id="æ‰¹é‡æ›´æ–°">æ‰¹é‡æ›´æ–°</h4>
<p>æ­£å¸¸çš„æ›´æ–°å°±æ˜¯æ‰¹é‡çš„ï¼ŒæŸ¥è¯¢ç»“æœæœ‰å‡ æ¡æ›´æ–°å‡ æ¡ã€‚</p>
<ul>
<li><strong>é˜»æ­¢å…¨å±€æ›´æ–°</strong></li>
</ul>
<p>å¦‚æœä¸å¸¦æ¡ä»¶è¿›è¡Œæ›´æ–°ï¼ˆæ›´æ–°æ•´ä¸ªè¡¨ï¼‰ï¼ŒGORMä¸ä¼šæ‰§è¡Œå¹¶è¿”å›<code>ErrMissingWhereClause</code>é”™è¯¯ã€‚</p>
<p>è§£å†³æ–¹æ³•æœ‰ä½¿ç”¨æ¡ä»¶ï¼Œä½¿ç”¨åŸç”ŸSQLæˆ–è€…å¼€å¯<code>AllowGlobalUpdate</code>æ¨¡å¼ã€‚</p>
<pre><code class="language-go">db.Model(&amp;User{}).Update(&quot;name&quot;, &quot;jinzhu&quot;).Error // gorm.ErrMissingWhereClause

db.Model(&amp;User{}).Where(&quot;1 = 1&quot;).Update(&quot;name&quot;, &quot;jinzhu&quot;)
// UPDATE users SET `name` = &quot;jinzhu&quot; WHERE 1=1

db.Exec(&quot;UPDATE users SET name = ?&quot;, &quot;jinzhu&quot;)
// UPDATE users SET name = &quot;jinzhu&quot;

db.Session(&amp;gorm.Session{AllowGlobalUpdate: true}).Model(&amp;User{}).Update(&quot;name&quot;, &quot;jinzhu&quot;)
// UPDATE users SET `name` = &quot;jinzhu&quot;
</code></pre>
<ul>
<li><strong>æ›´æ–°çš„è®°å½•æ•°</strong></li>
</ul>
<p>å¯ä»¥ä½¿ç”¨ <code>result</code>å˜é‡ä½œä¸ºCRUDæ“ä½œçš„è¿”å›å€¼ï¼Œ<code>result.RowsAffected</code>å³ä¸ºæ›´æ–°è®°å½•æ•°ï¼Œ<code>result.Error</code>å³ä¸ºé”™è¯¯ã€‚</p>
<pre><code class="language-go">// Get updated records count with `RowsAffected`
result := db.Model(User{}).Where(&quot;role = ?&quot;, &quot;admin&quot;).Updates(User{Name: &quot;hello&quot;, Age: 18})
// UPDATE users SET name='hello', age=18 WHERE role = 'admin';

result.RowsAffected // returns updated records count
result.Error        // returns updating error
</code></pre>
<h4 id="æ›´æ–°é«˜çº§é€‰é¡¹">æ›´æ–°é«˜çº§é€‰é¡¹</h4>
<ul>
<li><strong>ä½¿ç”¨SQLè¡¨è¾¾å¼æ›´æ–°</strong></li>
</ul>
<p>èµ‹å€¼æ—¶å¯ä»¥ä½¿ç”¨sqlè¡¨è¾¾å¼ã€‚</p>
<pre><code class="language-go">// product's ID is `3`
db.Model(&amp;product).Update(&quot;price&quot;, gorm.Expr(&quot;price * ? + ?&quot;, 2, 100))
// UPDATE &quot;products&quot; SET &quot;price&quot; = price * 2 + 100, &quot;updated_at&quot; = '2013-11-17 21:34:10' WHERE &quot;id&quot; = 3;

db.Model(&amp;product).Updates(map[string]interface{}{&quot;price&quot;: gorm.Expr(&quot;price * ? + ?&quot;, 2, 100)})
// UPDATE &quot;products&quot; SET &quot;price&quot; = price * 2 + 100, &quot;updated_at&quot; = '2013-11-17 21:34:10' WHERE &quot;id&quot; = 3;

db.Model(&amp;product).UpdateColumn(&quot;quantity&quot;, gorm.Expr(&quot;quantity - ?&quot;, 1))
// UPDATE &quot;products&quot; SET &quot;quantity&quot; = quantity - 1 WHERE &quot;id&quot; = 3;

db.Model(&amp;product).Where(&quot;quantity &gt; 1&quot;).UpdateColumn(&quot;quantity&quot;, gorm.Expr(&quot;quantity - ?&quot;, 1))
// UPDATE &quot;products&quot; SET &quot;quantity&quot; = quantity - 1 WHERE &quot;id&quot; = 3 AND quantity &gt; 1;
</code></pre>
<p>TODO:è‡ªå®šæ•°æ®ç±»å‹ç›¸å…³</p>
<ul>
<li><strong>æ ¹æ®å­æŸ¥è¯¢è¿›è¡Œæ›´æ–°</strong></li>
</ul>
<p>å½“ç„¶ä¹Ÿå¯ä»¥ç”¨å¦ä¸€ä¸ªæŸ¥è¯¢çš„ç»“æœæ¥èµ‹å€¼ã€‚</p>
<pre><code class="language-go">db.Model(&amp;user).Update(&quot;company_name&quot;, db.Model(&amp;Company{}).Select(&quot;name&quot;).Where(&quot;companies.id = users.company_id&quot;))
// UPDATE &quot;users&quot; SET &quot;company_name&quot; = (SELECT name FROM companies WHERE companies.id = users.company_id);

db.Table(&quot;users as u&quot;).Where(&quot;name = ?&quot;, &quot;jinzhu&quot;).Update(&quot;company_name&quot;, db.Table(&quot;companies as c&quot;).Select(&quot;name&quot;).Where(&quot;c.id = u.company_id&quot;))
// UPDATE users as u SET company_name = (SELECT name FROM campanies as c WHERE c.id = u.company_id) WHERE u.name = &quot;jinzhu&quot; 

db.Table(&quot;users as u&quot;).Where(&quot;name = ?&quot;, &quot;jinzhu&quot;).Updates(map[string]interface{}{&quot;company_name&quot;: db.Table(&quot;companies as c&quot;).Select(&quot;name&quot;).Where(&quot;c.id = u.company_id&quot;)})
</code></pre>
<ul>
<li><strong>ä¸ä½¿ç”¨Hookå’Œäº‹ä»¶è¿½è¸ª</strong></li>
</ul>
<p>å¦‚æœæƒ³è·³è¿‡é’©å­æ–¹æ³•ï¼Œå’Œä¸æ›´æ–°æ›´æ–°æ—¶é—´ï¼Œå¯ä»¥ä½¿ç”¨<code>UpdateColumn</code>, <code>UpdateColumns</code>æ–¹æ³•ï¼Œå’Œ<code>Update</code>,<code>Updates</code>æ–¹æ³•ç”¨æ³•ç±»ä¼¼ã€‚</p>
<ul>
<li><strong>è¿”å›ä¿®æ”¹è¡Œçš„æ•°æ®</strong></li>
</ul>
<p>åªç”¨äºæ”¯æŒè¿”å›çš„æ•°æ®åº“ï¼Œä½¿ç”¨<code>Clauses(clause.Returning{})</code>æ–¹æ³•ã€‚</p>
<pre><code class="language-go">// return all columns
var users []User
db.Model(&amp;users).Clauses(clause.Returning{}).Where(&quot;role = ?&quot;, &quot;admin&quot;).Update(&quot;salary&quot;, gorm.Expr(&quot;salary * ?&quot;, 2))
// UPDATE `users` SET `salary`=salary * 2,`updated_at`=&quot;2021-10-28 17:37:23.19&quot; WHERE role = &quot;admin&quot; RETURNING *
// users =&gt; []User{{ID: 1, Name: &quot;jinzhu&quot;, Role: &quot;admin&quot;, Salary: 100}, {ID: 2, Name: &quot;jinzhu.2&quot;, Role: &quot;admin&quot;, Salary: 1000}}

// return specified columns
db.Model(&amp;users).Clauses(clause.Returning{Columns: []clause.Column{{Name: &quot;name&quot;}, {Name: &quot;salary&quot;}}}).Where(&quot;role = ?&quot;, &quot;admin&quot;).Update(&quot;salary&quot;, gorm.Expr(&quot;salary * ?&quot;, 2))
// UPDATE `users` SET `salary`=salary * 2,`updated_at`=&quot;2021-10-28 17:37:23.19&quot; WHERE role = &quot;admin&quot; RETURNING `name`, `salary`
// users =&gt; []User{{ID: 0, Name: &quot;jinzhu&quot;, Role: &quot;&quot;, Salary: 100}, {ID: 0, Name: &quot;jinzhu.2&quot;, Role: &quot;&quot;, Salary: 1000}}
</code></pre>
<ul>
<li><strong>æ£€æŸ¥å­—æ®µæ˜¯å¦æœ‰å˜æ›´</strong></li>
</ul>
<p>GORMæä¾›<code>Changed</code>æ–¹æ³•ç”¨äº<strong>Before Update Hooks</strong>ï¼Œå°†è¿”å› å­—æ®µæ˜¯å¦æ”¹å˜ã€‚</p>
<p><code>Changed</code>æ–¹æ³•åªç”¨äº<code>Update</code>å’Œ<code>Updates</code>æ–¹æ³•ï¼Œåªæ£€æŸ¥æ›´æ–°å€¼æ˜¯å¦ç­‰äºæ¨¡å‹å€¼ï¼Œå¦‚æœæ”¹å˜ä¸”æœªè¢«çœç•¥åˆ™è¿”å›trueã€‚</p>
<pre><code class="language-go">func (u *User) BeforeUpdate(tx *gorm.DB) (err error) {
  // if Role changed
    if tx.Statement.Changed(&quot;Role&quot;) {
    return errors.New(&quot;role not allowed to change&quot;)
    }

  if tx.Statement.Changed(&quot;Name&quot;, &quot;Admin&quot;) { // if Name or Role changed
    tx.Statement.SetColumn(&quot;Age&quot;, 18)
  }

  // if any fields changed
    if tx.Statement.Changed() {
        tx.Statement.SetColumn(&quot;RefreshedAt&quot;, time.Now())
    }
    return nil
}

db.Model(&amp;User{ID: 1, Name: &quot;jinzhu&quot;}).Updates(map[string]interface{&quot;name&quot;: &quot;jinzhu2&quot;})
// Changed(&quot;Name&quot;) =&gt; true
db.Model(&amp;User{ID: 1, Name: &quot;jinzhu&quot;}).Updates(map[string]interface{&quot;name&quot;: &quot;jinzhu&quot;})
// Changed(&quot;Name&quot;) =&gt; false, `Name` not changed
db.Model(&amp;User{ID: 1, Name: &quot;jinzhu&quot;}).Select(&quot;Admin&quot;).Updates(map[string]interface{
  &quot;name&quot;: &quot;jinzhu2&quot;, &quot;admin&quot;: false,
})
// Changed(&quot;Name&quot;) =&gt; false, `Name` not selected to update

db.Model(&amp;User{ID: 1, Name: &quot;jinzhu&quot;}).Updates(User{Name: &quot;jinzhu2&quot;})
// Changed(&quot;Name&quot;) =&gt; true
db.Model(&amp;User{ID: 1, Name: &quot;jinzhu&quot;}).Updates(User{Name: &quot;jinzhu&quot;})
// Changed(&quot;Name&quot;) =&gt; false, `Name` not changed
db.Model(&amp;User{ID: 1, Name: &quot;jinzhu&quot;}).Select(&quot;Admin&quot;).Updates(User{Name: &quot;jinzhu2&quot;})
// Changed(&quot;Name&quot;) =&gt; false, `Name` not selected to update
</code></pre>
<ul>
<li><strong>åœ¨Updateæ—¶ä¿®æ”¹å€¼</strong></li>
</ul>
<p>è¦åœ¨Before Hooksé‡Œæ›´æ”¹æ›´æ–°å€¼ï¼Œåº”è¯¥ä½¿ç”¨<code>SetColumn</code>ï¼Œé™¤éå®ƒæ˜¯ä½¿ç”¨<code>save</code>çš„å…¨ä¿®æ”¹ã€‚</p>
<pre><code class="language-go">func (user *User) BeforeSave(tx *gorm.DB) (err error) {
  if pw, err := bcrypt.GenerateFromPassword(user.Password, 0); err == nil {
    tx.Statement.SetColumn(&quot;EncryptedPassword&quot;, pw)
  }

  if tx.Statement.Changed(&quot;Code&quot;) {
    user.Age += 20
    tx.Statement.SetColumn(&quot;Age&quot;, user.Age)
  }
}

db.Model(&amp;user).Update(&quot;Name&quot;, &quot;jinzhu&quot;)
</code></pre>
<h3 id="åˆ é™¤">åˆ é™¤</h3>
<p>åˆ é™¤ä¸€æ¡è®°å½•æ—¶éœ€è¦æŒ‡å®šä¸»é”®ï¼Œå¦åˆ™å°†å‡ºå‘æ‰¹é‡åˆ é™¤ã€‚</p>
<p>GORMå¯ä»¥é€šè¿‡ä¸»é”®ï¼ˆå¤åˆä¸»é”®ï¼‰å’Œå†…è”æ¡ä»¶åˆ é™¤å¯¹è±¡ï¼Œè¯¦æƒ…è§ <a href="#%E6%A0%B9%E6%8D%AE%E6%9D%A1%E4%BB%B6%E6%9F%A5%E8%AF%A2">æ¡ä»¶</a>çš„ <strong>å†…è”æ¡ä»¶</strong>éƒ¨åˆ†ã€‚</p>
<pre><code class="language-go">// Email çš„ ID æ˜¯ `10`
db.Delete(&amp;email)
// DELETE from emails where id = 10;

// å¸¦é¢å¤–æ¡ä»¶çš„åˆ é™¤
db.Where(&quot;name = ?&quot;, &quot;jinzhu&quot;).Delete(&amp;email)
// DELETE from emails where id = 10 AND name = &quot;jinzhu&quot;;

db.Delete(&amp;User{}, 10)
// DELETE FROM users WHERE id = 10;

db.Delete(&amp;User{}, &quot;10&quot;)
// DELETE FROM users WHERE id = 10;

db.Delete(&amp;users, []int{1,2,3})
// DELETE FROM users WHERE id IN (1,2,3);
</code></pre>
<h4 id="é’©å­å‡½æ•°">é’©å­å‡½æ•°</h4>
<p>å¯¹äºåˆ é™¤æ“ä½œï¼ŒGORM æ”¯æŒ BeforeDeleteã€AfterDelete Hookï¼Œè¯¦è§ <a href="#hook">é’©å­</a>ã€‚</p>
<h4 id="æ‰¹é‡åˆ é™¤">æ‰¹é‡åˆ é™¤</h4>
<p>å¦‚æœæŒ‡å®šçš„å€¼ä¸åŒ…æ‹¬ä¸»å±æ€§ï¼Œå°†åˆ é™¤æ‰€æœ‰åŒ¹é…çš„è®°å½•ã€‚å¯ä»¥å°†ä¸€ä¸ªä¸»é”®åˆ‡ç‰‡ä¼ é€’ç»™Delete æ–¹æ³•ï¼Œä»¥ä¾¿æ›´é«˜æ•ˆçš„åˆ é™¤æ•°æ®é‡å¤§çš„è®°å½•ã€‚</p>
<pre><code class="language-go">db.Where(&quot;email LIKE ?&quot;, &quot;%jinzhu%&quot;).Delete(&amp;Email{})
// DELETE from emails where email LIKE &quot;%jinzhu%&quot;;

db.Delete(&amp;Email{}, &quot;email LIKE ?&quot;, &quot;%jinzhu%&quot;)
// DELETE from emails where email LIKE &quot;%jinzhu%&quot;;

db.Where(&quot;email LIKE ?&quot;, &quot;%jinzhu%&quot;).Delete(&amp;Email{})
// DELETE from emails where email LIKE &quot;%jinzhu%&quot;;

db.Delete(&amp;Email{}, &quot;email LIKE ?&quot;, &quot;%jinzhu%&quot;)
// DELETE from emails where email LIKE &quot;%jinzhu%&quot;;

</code></pre>
<ul>
<li><strong>é˜»æ­¢å…¨å±€åˆ é™¤</strong></li>
</ul>
<p>å¦‚æœä¸å¸¦æ¡ä»¶è¿›è¡Œåˆ é™¤ï¼ˆåˆ é™¤æ•´ä¸ªè¡¨ï¼‰ï¼ŒGORMä¸ä¼šæ‰§è¡Œå¹¶è¿”å›<code>ErrMissingWhereClause</code>é”™è¯¯ã€‚</p>
<p>è§£å†³æ–¹æ³•æœ‰ä½¿ç”¨æ¡ä»¶ï¼Œä½¿ç”¨åŸç”ŸSQLæˆ–è€…å¼€å¯<code>AllowGlobalUpdate</code>æ¨¡å¼ã€‚</p>
<pre><code class="language-go">db.Delete(&amp;User{}).Error // gorm.ErrMissingWhereClause

db.Delete(&amp;[]User{{Name: &quot;jinzhu1&quot;}, {Name: &quot;jinzhu2&quot;}}).Error // gorm.ErrMissingWhereClause

db.Where(&quot;1 = 1&quot;).Delete(&amp;User{})
// DELETE FROM `users` WHERE 1=1

db.Exec(&quot;DELETE FROM users&quot;)
// DELETE FROM users

db.Session(&amp;gorm.Session{AllowGlobalUpdate: true}).Delete(&amp;User{})
// DELETE FROM users
</code></pre>
<ul>
<li><strong>è¿”å›åˆ é™¤è¡Œçš„ä¿¡æ¯</strong></li>
</ul>
<p>è¿”å›è¢«åˆ é™¤çš„æ•°æ®ï¼Œä»…å½“æ•°æ®åº“æ”¯æŒå›å†™åŠŸèƒ½æ—¶æ‰èƒ½æ­£å¸¸è¿è¡Œï¼Œå¦‚ä¸‹ä¾‹ï¼š</p>
<pre><code class="language-go">// å›å†™æ‰€æœ‰çš„åˆ—
var users []User
DB.Clauses(clause.Returning{}).Where(&quot;role = ?&quot;, &quot;admin&quot;).Delete(&amp;users)
// DELETE FROM `users` WHERE role = &quot;admin&quot; RETURNING *
// users =&gt; []User{{ID: 1, Name: &quot;jinzhu&quot;, Role: &quot;admin&quot;, Salary: 100}, {ID: 2, Name: &quot;jinzhu.2&quot;, Role: &quot;admin&quot;, Salary: 1000}}

// å›å†™æŒ‡å®šçš„åˆ—
DB.Clauses(clause.Returning{Columns: []clause.Column{{Name: &quot;name&quot;}, {Name: &quot;salary&quot;}}}).Where(&quot;role = ?&quot;, &quot;admin&quot;).Delete(&amp;users)
// DELETE FROM `users` WHERE role = &quot;admin&quot; RETURNING `name`, `salary`
// users =&gt; []User{{ID: 0, Name: &quot;jinzhu&quot;, Role: &quot;&quot;, Salary: 100}, {ID: 0, Name: &quot;jinzhu.2&quot;, Role: &quot;&quot;, Salary: 1000}}
</code></pre>
<h4 id="è½¯åˆ é™¤">è½¯åˆ é™¤</h4>
<p>å¦‚æœæ¨¡å‹ä¸­åŒ…å«<code>gorm.DeletedAt</code>å­—æ®µï¼ˆåŒ…å«åœ¨gorm.Modelä¸­ï¼‰ï¼Œå°†ä½¿ç”¨è½¯åˆ é™¤ã€‚å½“è°ƒç”¨<code>Delete</code>æ—¶ï¼ŒGORMå¹¶ä¸ä¼šä»æ•°æ®åº“ä¸­åˆ é™¤è¯¥è®°å½•ï¼Œè€Œæ˜¯å°†è¯¥è®°å½•çš„<code>DeleteAt</code>è®¾ç½®ä¸ºå½“å‰æ—¶é—´ï¼Œè€Œåçš„ä¸€èˆ¬æŸ¥è¯¢æ–¹æ³•å°†æ— æ³•æŸ¥æ‰¾åˆ°æ­¤æ¡è®°å½•ã€‚</p>
<pre><code class="language-go">// user's ID is `111`
db.Delete(&amp;user)
// UPDATE users SET deleted_at=&quot;2013-10-29 10:23&quot; WHERE id = 111;

// Batch Delete
db.Where(&quot;age = ?&quot;, 20).Delete(&amp;User{})
// UPDATE users SET deleted_at=&quot;2013-10-29 10:23&quot; WHERE age = 20;

// Soft deleted records will be ignored when querying
db.Where(&quot;age = 20&quot;).Find(&amp;user)
// SELECT * FROM users WHERE age = 20 AND deleted_at IS NULL;
</code></pre>
<p>å¦‚æœä¸æƒ³ä½¿ç”¨gorm.Modelï¼Œå¯ä»¥åœ¨æ¨¡å‹ä¸­å®šä¹‰ä¸€ä¸ªç±»å‹ä¸º<code>gorm.DeletedAt</code>çš„å­—æ®µæ¥å¼€å¯è½¯åˆ é™¤ã€‚</p>
<ul>
<li><strong>æŸ¥æ‰¾è¢«è½¯åˆ é™¤çš„è®°å½•</strong></li>
</ul>
<p>å¯ä»¥ä½¿ç”¨<code>Unscoped</code>æ¥æŸ¥è¯¢åˆ°è¢«è½¯åˆ é™¤çš„è®°å½•ã€‚</p>
<pre><code class="language-go">db.Unscoped().Where(&quot;age = 20&quot;).Find(&amp;users)
// SELECT * FROM users WHERE age = 20;
</code></pre>
<ul>
<li><strong>æ°¸ä¹…åˆ é™¤</strong></li>
</ul>
<p>å¯ä»¥ä½¿ç”¨<code>Unscoped</code>æ¥æ°¸ä¹…åˆ é™¤åŒ¹é…çš„è®°å½•ã€‚</p>
<pre><code class="language-go">db.Unscoped().Delete(&amp;order)
// DELETE FROM orders WHERE id=10;
</code></pre>
<h3 id="åŸç”Ÿsqlå’Œsqlç”Ÿæˆå™¨">åŸç”ŸSQLå’ŒSQLç”Ÿæˆå™¨</h3>
<h4 id="åŸç”Ÿ-sql">åŸç”Ÿ SQL</h4>
<p><code>Raw</code>å’Œ<code>Exec</code>æ–¹æ³•éƒ½å¯ç”¨äºæ‰§è¡ŒåŸç”ŸSQLè¯­å¥ã€‚ä¸¤è€…åŒºåˆ«å¦‚ä¸‹ï¼š</p>
<p>Rawå¸¸ç”¨äºæ‰§è¡Œ SELECT æŸ¥è¯¢ï¼Œè¿”å›æŸ¥è¯¢ç»“æœï¼Œå¯ä»¥æ˜ å°„åˆ° Go ç»“æ„ä½“ï¼Œé€šå¸¸ç”¨äºè¯»å–æ•°æ®ã€‚</p>
<p>Execå¸¸ç”¨äºæ‰§è¡ŒéæŸ¥è¯¢æ“ä½œï¼Œä¹Ÿå¯ä»¥ç”¨äºæ‰§è¡ŒæŸ¥è¯¢æ“ä½œï¼Œä½†ä¸è¿”å›ç»“æœã€‚Execè¿”å›ä¸€ä¸ª sql.Result å¯¹è±¡ï¼Œå¯ä»¥ç”¨æ¥è·å–å—å½±å“çš„è¡Œæ•°ç­‰ä¿¡æ¯ã€‚</p>
<h4 id="å‘½åå‚æ•°ç®€ä»‹">å‘½åå‚æ•°ç®€ä»‹</h4>
<p>GORM æ”¯æŒ <code>sql.NamedArg</code>ã€<code>map[string]interface{}{}</code> æˆ– <code>struct</code> å½¢å¼çš„å‘½åå‚æ•°ã€‚</p>
<p>ç®€å•æ¥è¯´ï¼Œå°±æ˜¯æœ‰äº†å›ºå®šçš„é”®å€¼å¯¹è€Œä¸æ˜¯å…¨ç”¨ï¼Ÿå ä½ï¼Œä¸éœ€è¦æ³¨æ„é¡ºåºï¼Œæé«˜äº†å¯è¯»æ€§ã€‚</p>
<pre><code class="language-go">db.Where(&quot;name1 = @name OR name2 = @name&quot;, sql.Named(&quot;name&quot;, &quot;jinzhu&quot;)).Find(&amp;user)
// SELECT * FROM `users` WHERE name1 = &quot;jinzhu&quot; OR name2 = &quot;jinzhu&quot;

db.Where(&quot;name1 = @name OR name2 = @name&quot;, map[string]interface{}{&quot;name&quot;: &quot;jinzhu2&quot;}).First(&amp;result3)
// SELECT * FROM `users` WHERE name1 = &quot;jinzhu2&quot; OR name2 = &quot;jinzhu2&quot; ORDER BY `users`.`id` LIMIT 1

// åŸç”Ÿ SQL åŠå‘½åå‚æ•°
db.Raw(&quot;SELECT * FROM users WHERE name1 = @name OR name2 = @name2 OR name3 = @name&quot;,
   sql.Named(&quot;name&quot;, &quot;jinzhu1&quot;), sql.Named(&quot;name2&quot;, &quot;jinzhu2&quot;)).Find(&amp;user)
// SELECT * FROM users WHERE name1 = &quot;jinzhu1&quot; OR name2 = &quot;jinzhu2&quot; OR name3 = &quot;jinzhu1&quot;

db.Exec(&quot;UPDATE users SET name1 = @name, name2 = @name2, name3 = @name&quot;,
   sql.Named(&quot;name&quot;, &quot;jinzhunew&quot;), sql.Named(&quot;name2&quot;, &quot;jinzhunew2&quot;))
// UPDATE users SET name1 = &quot;jinzhunew&quot;, name2 = &quot;jinzhunew2&quot;, name3 = &quot;jinzhunew&quot;

db.Raw(&quot;SELECT * FROM users WHERE (name1 = @name AND name3 = @name) AND name2 = @name2&quot;,
   map[string]interface{}{&quot;name&quot;: &quot;jinzhu&quot;, &quot;name2&quot;: &quot;jinzhu2&quot;}).Find(&amp;user)
// SELECT * FROM users WHERE (name1 = &quot;jinzhu&quot; AND name3 = &quot;jinzhu&quot;) AND name2 = &quot;jinzhu2&quot;

type NamedArgument struct {
    Name string
    Name2 string
}

db.Raw(&quot;SELECT * FROM users WHERE (name1 = @Name AND name3 = @Name) AND name2 = @Name2&quot;,
     NamedArgument{Name: &quot;jinzhu&quot;, Name2: &quot;jinzhu2&quot;}).Find(&amp;user)
// SELECT * FROM users WHERE (name1 = &quot;jinzhu&quot; AND name3 = &quot;jinzhu&quot;) AND name2 = &quot;jinzhu2&quot;
</code></pre>
<h4 id="dryrun-æ¨¡å¼">DryRun æ¨¡å¼</h4>
<p>åœ¨ä¸æ‰§è¡Œçš„æƒ…å†µä¸‹ç”Ÿæˆ SQL åŠå…¶å‚æ•°ï¼Œå¯ä»¥ç”¨äºå‡†å¤‡æˆ–æµ‹è¯•ç”Ÿæˆçš„ SQLï¼Œè¯¦æƒ…å‚è§ <a href="#session2">ä¼šè¯</a>ã€‚</p>
<pre><code class="language-go">stmt := db.Session(&amp;gorm.Session{DryRun: true}).First(&amp;user, 1).Statement
stmt.SQL.String() //=&gt; SELECT * FROM `users` WHERE `id` = $1 ORDER BY `id`
stmt.Vars         //=&gt; []interface{}{1}
</code></pre>
<h4 id="tosql">ToSQL</h4>
<p>è¿”å›ç”Ÿæˆçš„ SQL ä½†ä¸æ‰§è¡Œã€‚</p>
<p>GORMä½¿ç”¨ <code>database/sql</code> çš„å‚æ•°å ä½ç¬¦æ¥æ„å»º SQL è¯­å¥ï¼Œå®ƒä¼šè‡ªåŠ¨è½¬ä¹‰å‚æ•°ä»¥é¿å… SQL æ³¨å…¥ï¼Œä½†ä¸ä¿è¯ç”Ÿæˆ SQL çš„å®‰å…¨ï¼Œå»ºè®®åªç”¨äºè°ƒè¯•ã€‚</p>
<pre><code class="language-go">sql := db.ToSQL(func(tx *gorm.DB) *gorm.DB {
  return tx.Model(&amp;User{}).Where(&quot;id = ?&quot;, 100).Limit(10).Order(&quot;age desc&quot;).Find(&amp;[]User{})
})
sql //=&gt; SELECT * FROM &quot;users&quot; WHERE id = 100 AND &quot;users&quot;.&quot;deleted_at&quot; IS NULL ORDER BY age desc LIMIT 10

</code></pre>
<h4 id="row-rows">Row &amp; Rows</h4>
<p>è·å– <code>*sql.Row</code> ç»“æœ</p>
<pre><code class="language-go">// ä½¿ç”¨ GORM API æ„å»º SQL
row := db.Table(&quot;users&quot;).Where(&quot;name = ?&quot;, &quot;jinzhu&quot;).Select(&quot;name&quot;, &quot;age&quot;).Row()
row.Scan(&amp;name, &amp;age)

// ä½¿ç”¨åŸç”Ÿ SQL
row := db.Raw(&quot;select name, age, email from users where name = ?&quot;, &quot;jinzhu&quot;).Row()
row.Scan(&amp;name, &amp;age, &amp;email)
</code></pre>
<p>è·å– <code>*sql.Rows</code> ç»“æœ</p>
<pre><code class="language-go">// ä½¿ç”¨ GORM API æ„å»º SQL
rows, err := db.Model(&amp;User{}).Where(&quot;name = ?&quot;, &quot;jinzhu&quot;).Select(&quot;name, age, email&quot;).Rows()
defer rows.Close()
for rows.Next() {
  rows.Scan(&amp;name, &amp;age, &amp;email)

  // ä¸šåŠ¡é€»è¾‘...
}

// åŸç”Ÿ SQL
rows, err := db.Raw(&quot;select name, age, email from users where name = ?&quot;, &quot;jinzhu&quot;).Rows()
defer rows.Close()
for rows.Next() {
  rows.Scan(&amp;name, &amp;age, &amp;email)

  // ä¸šåŠ¡é€»è¾‘...
}
</code></pre>
<h4 id="å°†-sqlrows-æ‰«æè‡³-model">å°† sql.Rows æ‰«æè‡³ model</h4>
<p>ä½¿ç”¨ ScanRows å°†ä¸€è¡Œè®°å½•æ‰«æè‡³ structï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-go">rows, err := db.Model(&amp;User{}).Where(&quot;name = ?&quot;, &quot;jinzhu&quot;).Select(&quot;name, age, email&quot;).Rows() // (*sql.Rows, error)
defer rows.Close()

var user User
for rows.Next() {
  // ScanRows å°†ä¸€è¡Œæ‰«æè‡³ user
  db.ScanRows(rows, &amp;user)

  // ä¸šåŠ¡é€»è¾‘...
}
</code></pre>
<h4 id="è¿æ¥">è¿æ¥</h4>
<p>åœ¨ä¸€æ¡ tcp DB è¿æ¥ä¸­è¿è¡Œå¤šæ¡ SQL (ä¸æ˜¯äº‹åŠ¡)</p>
<pre><code class="language-go">db.Connection(func(tx *gorm.DB) error {
  tx.Exec(&quot;SET my.role = ?&quot;, &quot;admin&quot;)

  tx.First(&amp;User{})
})
</code></pre>
<h4 id="é«˜çº§">é«˜çº§</h4>
<ul>
<li>å­å¥ï¼ˆClauseï¼‰</li>
<li>å­å¥æ„é€ å™¨</li>
<li>å­å¥é€‰é¡¹</li>
<li>StatementModifier</li>
</ul>
<h2 id="å…³è”">å…³è”</h2>
<h3 id="belongs-to">Belongs To</h3>
<ul>
<li>Belongs To</li>
</ul>
<p><code>belongs to</code> ä¼šä¸å¦ä¸€ä¸ªæ¨¡å‹å»ºç«‹äº†ä¸€å¯¹ä¸€çš„è¿æ¥ã€‚ è¿™ç§æ¨¡å‹çš„æ¯ä¸€ä¸ªå®ä¾‹éƒ½â€œå±äºâ€å¦ä¸€ä¸ªæ¨¡å‹çš„ä¸€ä¸ªå®ä¾‹ã€‚</p>
<pre><code class="language-go">// `User` å±äº `Company`ï¼Œ`CompanyID` æ˜¯å¤–é”®
type User struct {
  gorm.Model
  Name      string
  CompanyID int
  Company   Company
}

type Company struct {
  ID   int
  Name string
}
</code></pre>
<ul>
<li>é‡å†™å¤–é”®</li>
</ul>
<p>ä½¿ç”¨<code>foreignKey</code>æ ‡ç­¾å¯ä»¥è‡ªå®šä¹‰å¤–é”®åå­—ã€‚</p>
<pre><code class="language-go">type User struct {
  gorm.Model
  Name         string
  CompanyRefer int
  Company      Company `gorm:&quot;foreignKey:CompanyRefer&quot;`
  // ä½¿ç”¨ CompanyRefer ä½œä¸ºå¤–é”®
}

type Company struct {
  ID   int
  Name string
}
</code></pre>
<p><code>foreignKey:CompanyID</code>ï¼šæŒ‡å®šäº†å¤–é”®å­—æ®µçš„åç§°ä¸º CompanyIDã€‚<br>
è¿™å‘Šè¯‰ GORM åœ¨ User è¡¨ä¸­åº”è¯¥ä½¿ç”¨ CompanyID å­—æ®µä½œä¸ºå¤–é”®ã€‚</p>
<ul>
<li>é‡å†™å¼•ç”¨</li>
</ul>
<p>ä½¿ç”¨<code>references</code>æ ‡ç­¾å¯ä»¥æ›´æ”¹å¼•ç”¨.</p>
<pre><code class="language-go">type User struct {
  gorm.Model
  Name      string
  CompanyID string
  Company   Company `gorm:&quot;references:CompanyID&quot;` // ä½¿ç”¨ Company.CompanyID ä½œä¸ºå¼•ç”¨
}

type Company struct {
  CompanyID   int
  Code        string
  Name        string
}
</code></pre>
<p><code>references:ID</code>ï¼šæŒ‡å®šå¼•ç”¨å­—æ®µçš„åç§°ä¸º IDã€‚<br>
è¿™å‘Šè¯‰ GORM åœ¨ Company è¡¨ä¸­åº”è¯¥ä½¿ç”¨ ID å­—æ®µä½œä¸ºè¢«å¼•ç”¨çš„ä¸»é”®ã€‚</p>
<ul>
<li>Belongs to çš„ CRUD</li>
</ul>
<p>è§ <a href="#%E5%85%B3%E8%81%94%E6%A8%A1%E5%BC%8F">å…³è”æ¨¡å¼</a> éƒ¨åˆ†ã€‚</p>
<ul>
<li>é¢„åŠ è½½</li>
</ul>
<p>GORM å¯ä»¥é€šè¿‡ <code>Preload</code>ã€<code>Joins</code> é¢„åŠ è½½ belongs to å…³è”çš„è®°å½•ï¼ŒæŸ¥çœ‹ <a href="#%E9%A2%84%E5%8A%A0%E8%BD%BD3">é¢„åŠ è½½</a> è·å–è¯¦æƒ…</p>
<h3 id="has-one">Has One</h3>
<p><code>has one</code> ä¸å¦ä¸€ä¸ªæ¨¡å‹å»ºç«‹ä¸€å¯¹ä¸€çš„å…³è”ï¼Œä½†å®ƒå’Œä¸€å¯¹ä¸€å…³ç³»æœ‰äº›è®¸ä¸åŒã€‚ è¿™ç§å…³è”è¡¨æ˜ä¸€ä¸ªæ¨¡å‹çš„æ¯ä¸ªå®ä¾‹éƒ½åŒ…å«æˆ–æ‹¥æœ‰å¦ä¸€ä¸ªæ¨¡å‹çš„ä¸€ä¸ªå®ä¾‹ã€‚</p>
<ul>
<li><strong>é‡å†™å¤–é”®&amp;å¼•ç”¨</strong></li>
</ul>
<p>åŒ<a href="#belongs-to">belongs to</a></p>
<ul>
<li><strong>Has One çš„ CURD</strong></li>
</ul>
<p>è§ <a href="#%E5%85%B3%E8%81%94%E6%A8%A1%E5%BC%8F">å…³è”æ¨¡å¼</a> éƒ¨åˆ†ã€‚</p>
<ul>
<li><strong>é¢„åŠ è½½</strong></li>
</ul>
<p>æŸ¥çœ‹ <a href="#%E9%A2%84%E5%8A%A0%E8%BD%BD3">é¢„åŠ è½½</a> è·å–è¯¦æƒ…</p>
<h4 id="å£°æ˜æ£€ç´¢-has-one">å£°æ˜&amp;æ£€ç´¢ Has One</h4>
<ul>
<li><strong>å£°æ˜</strong></li>
</ul>
<pre><code class="language-go">// User æœ‰ä¸€å¼  CreditCardï¼ŒUserID æ˜¯å¤–é”®
type User struct {
  gorm.Model
  CreditCard CreditCard
}

type CreditCard struct {
  gorm.Model
  Number string
  UserID uint
}
</code></pre>
<ul>
<li><strong>æ£€ç´¢</strong></li>
</ul>
<pre><code class="language-go">// æ£€ç´¢ç”¨æˆ·åˆ—è¡¨å¹¶é¢„åŠ è½½ä¿¡ç”¨å¡
func GetAll(db *gorm.DB) ([]User, error) {
    var users []User
    err := db.Model(&amp;User{}).Preload(&quot;CreditCard&quot;).Find(&amp;users).Error
    return users, err
}
</code></pre>
<h4 id="è‡ªå¼•ç”¨-has-one">è‡ªå¼•ç”¨ Has One</h4>
<pre><code class="language-go">type User struct {
  gorm.Model
  Name      string
  ManagerID *uint
  Manager   *User
}
</code></pre>
<h3 id="has-many">Has Many</h3>
<p>has many ä¸å¦ä¸€ä¸ªæ¨¡å‹å»ºç«‹äº†ä¸€å¯¹å¤šçš„è¿æ¥ã€‚ ä¸åŒäº has oneï¼Œæ‹¥æœ‰è€…å¯ä»¥æœ‰é›¶æˆ–å¤šä¸ªå…³è”æ¨¡å‹ã€‚</p>
<ul>
<li><strong>é‡å†™å¤–é”®&amp;å¼•ç”¨</strong></li>
</ul>
<p>åŒ<a href="#belongs-to">belongs to</a></p>
<ul>
<li><strong>Has Many çš„ CURD</strong></li>
</ul>
<p>è§ <a href="#%E5%85%B3%E8%81%94%E6%A8%A1%E5%BC%8F">å…³è”æ¨¡å¼</a> éƒ¨åˆ†ã€‚</p>
<ul>
<li><strong>é¢„åŠ è½½</strong></li>
</ul>
<p>æŸ¥çœ‹ <a href="#%E9%A2%84%E5%8A%A0%E8%BD%BD3">é¢„åŠ è½½</a> è·å–è¯¦æƒ…</p>
<h4 id="å£°æ˜æ£€ç´¢-has-many">å£°æ˜&amp;æ£€ç´¢ Has Many</h4>
<ul>
<li><strong>å£°æ˜</strong></li>
</ul>
<pre><code class="language-go">// User æœ‰å¤šå¼  CreditCardï¼ŒUserID æ˜¯å¤–é”®
type User struct {
  gorm.Model
  CreditCards []CreditCard
}

type CreditCard struct {
  gorm.Model
  Number string
  UserID uint
}
</code></pre>
<ul>
<li><strong>æ£€ç´¢</strong></li>
</ul>
<pre><code class="language-go">// æ£€ç´¢ç”¨æˆ·åˆ—è¡¨å¹¶é¢„åŠ è½½ä¿¡ç”¨å¡
func GetAll(db *gorm.DB) ([]User, error) {
    var users []User
    err := db.Model(&amp;User{}).Preload(&quot;CreditCards&quot;).Find(&amp;users).Error
    return users, err
}
</code></pre>
<h4 id="è‡ªå¼•ç”¨-has-many">è‡ªå¼•ç”¨ Has Many</h4>
<p>type User struct {<br>
gorm.Model<br>
Name      string<br>
ManagerID *uint<br>
Team      []User <code>gorm:&quot;foreignkey:ManagerID&quot;</code><br>
}</p>
<h3 id="many-to-many">Many To Many</h3>
<p>Many to Many ä¼šåœ¨ä¸¤ä¸ª model ä¸­æ·»åŠ ä¸€å¼ è¿æ¥è¡¨ã€‚</p>
<pre><code class="language-go">// User æ‹¥æœ‰å¹¶å±äºå¤šç§ languageï¼Œ`user_languages` æ˜¯è¿æ¥è¡¨
type User struct {
  gorm.Model
  Languages []Language `gorm:&quot;many2many:user_languages;&quot;`
}

type Language struct {
  gorm.Model
  Name string
}
</code></pre>
<p>æ ‡ç­¾ <code>gorm:&quot;many2many:user_languages;&quot;</code> æ¥æŒ‡å®šä¸­é—´è¡¨çš„åç§°ä¸º user_languagesã€‚</p>
<ul>
<li><strong>Has Many çš„ CURD</strong></li>
</ul>
<p>è§ <a href="#%E5%85%B3%E8%81%94%E6%A8%A1%E5%BC%8F">å…³è”æ¨¡å¼</a> éƒ¨åˆ†ã€‚</p>
<ul>
<li><strong>é¢„åŠ è½½</strong></li>
</ul>
<p>æŸ¥çœ‹ <a href="#%E9%A2%84%E5%8A%A0%E8%BD%BD3">é¢„åŠ è½½</a> è·å–è¯¦æƒ…</p>
<ul>
<li><strong>å¤–é”®çº¦æŸ</strong></li>
</ul>
<p>è§<a href="#%E5%A4%96%E9%94%AE%E7%BA%A6%E6%9D%9F">å¤–é”®çº¦æŸ</a></p>
<p>**æ³¨æ„ï¼š**æŸäº›æ•°æ®åº“åªå…è®¸åœ¨å”¯ä¸€ç´¢å¼•å­—æ®µä¸Šåˆ›å»ºå¤–é”®ï¼Œå¦‚æœæ‚¨åœ¨è¿ç§»æ—¶ä¼šåˆ›å»ºå¤–é”®ï¼Œåˆ™éœ€è¦æŒ‡å®š <code>unique index</code> æ ‡ç­¾ã€‚</p>
<h4 id="åå‘å¼•ç”¨-many-to-many">åå‘å¼•ç”¨-Many To Many</h4>
<ul>
<li>å£°æ˜</li>
</ul>
<pre><code class="language-go">// User æ‹¥æœ‰å¹¶å±äºå¤šç§ languageï¼Œ`user_languages` æ˜¯è¿æ¥è¡¨
type User struct {
  gorm.Model
  Languages []*Language `gorm:&quot;many2many:user_languages;&quot;`
}

type Language struct {
  gorm.Model
  Name string
  Users []*User `gorm:&quot;many2many:user_languages;&quot;`
}
</code></pre>
<ul>
<li>æ£€ç´¢</li>
</ul>
<pre><code class="language-go">// æ£€ç´¢ User åˆ—è¡¨å¹¶é¢„åŠ è½½ Language
func GetAllUsers(db *gorm.DB) ([]User, error) {
    var users []User
    err := db.Model(&amp;User{}).Preload(&quot;Languages&quot;).Find(&amp;users).Error
    return users, err
}

// æ£€ç´¢ Language åˆ—è¡¨å¹¶é¢„åŠ è½½ User
func GetAllLanguages(db *gorm.DB) ([]Language, error) {
    var languages []Language
    err := db.Model(&amp;Language{}).Preload(&quot;Users&quot;).Find(&amp;languages).Error
    return languages, err
}
</code></pre>
<h4 id="è‡ªå¼•ç”¨-many2many">è‡ªå¼•ç”¨ Many2Many</h4>
<pre><code class="language-go">type User struct {
  gorm.Model
    Friends []*User `gorm:&quot;many2many:user_friends&quot;`
}

// ä¼šåˆ›å»ºè¿æ¥è¡¨ï¼šuser_friends
//   foreign key: user_id, reference: users.id
//   foreign key: friend_id, reference: users.id

</code></pre>
<h4 id="è‡ªå®šä¹‰è¿æ¥è¡¨">è‡ªå®šä¹‰è¿æ¥è¡¨</h4>
<p>è¿æ¥è¡¨ å¯ä»¥æ˜¯ä¸€ä¸ªåŠŸèƒ½é½å…¨çš„æ¨¡å‹ï¼Œæ¯”å¦‚æ”¯æŒ è½¯åˆ é™¤ã€é’©å­å‡½æ•°åŠŸèƒ½ï¼Œå¹¶ä¸”å¯ä»¥å…·æœ‰æ›´å¤šå­—æ®µã€‚æ‚¨å¯ä»¥é€šè¿‡ SetupJoinTable è®¾ç½®ï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-go">type Person struct {
  ID        int
  Name      string
  Addresses []Address `gorm:&quot;many2many:person_addresses;&quot;`
}

type Address struct {
  ID   uint
  Name string
}

type PersonAddress struct {
  PersonID  int `gorm:&quot;primaryKey&quot;`
  AddressID int `gorm:&quot;primaryKey&quot;`
  CreatedAt time.Time
  DeletedAt gorm.DeletedAt
}

func (PersonAddress) BeforeCreate(db *gorm.DB) error {
  // ...
}

// ä¿®æ”¹ Person çš„ Addresses å­—æ®µçš„è¿æ¥è¡¨ä¸º PersonAddress
// PersonAddress å¿…é¡»å®šä¹‰å¥½æ‰€éœ€çš„å¤–é”®ï¼Œå¦åˆ™ä¼šæŠ¥é”™
err := db.SetupJoinTable(&amp;Person{}, &quot;Addresses&quot;, &amp;PersonAddress{})
</code></pre>
<h4 id="å¤åˆå¤–é”®">å¤åˆå¤–é”®</h4>
<p>å¦‚æœæ¨¡å‹ä½¿ç”¨äº† å¤åˆä¸»é”®ï¼ŒGORM ä¼šé»˜è®¤å¯ç”¨å¤åˆå¤–é”®ã€‚</p>
<p>ä¹Ÿå¯ä»¥è¦†ç›–é»˜è®¤çš„å¤–é”®ã€æŒ‡å®šå¤šä¸ªå¤–é”®ï¼Œåªéœ€ç”¨é€—å·åˆ†éš”é‚£äº›é”®åã€‚</p>
<h3 id="polymorphism">Polymorphism</h3>
<p>GORMæ”¯æŒHas Oneå’ŒHas Manyçš„å¤šæ€å…³è”ï¼Œå®ƒå°†æ‹¥æœ‰çš„å®ä½“çš„è¡¨åä¿å­˜åˆ°å¤šæ€ç±»å‹çš„å­—æ®µä¸­ï¼Œä¸»é”®å€¼ä¿å­˜åˆ°å¤šæ€å­—æ®µä¸­ã€‚</p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>polymorphic:&lt;value&gt;</code>å°†ä»¥<code>&lt;value&gt;</code>ä½œä¸ºåˆ—ç±»å‹å’Œåˆ—idçš„å‰ç¼€ã€‚<br>
è¯¥å€¼å°†æ˜¯è¡¨åçš„å¤æ•°å½¢å¼ã€‚</p>
<pre><code class="language-go">type Dog struct {
  ID   int
  Name string
  Toys []Toy `gorm:&quot;polymorphic:Owner;&quot;`
}

type Toy struct {
  ID        int
  Name      string
  OwnerID   int
  OwnerType string
}

db.Create(&amp;Dog{Name: &quot;dog1&quot;, Toys: []Toy{{Name: &quot;toy1&quot;}, {Name: &quot;toy2&quot;}}})
// INSERT INTO `dogs` (`name`) VALUES (&quot;dog1&quot;)
// INSERT INTO `toys` (`name`,`owner_id`,`owner_type`) VALUES (&quot;toy1&quot;,1,&quot;dogs&quot;), (&quot;toy2&quot;,1,&quot;dogs&quot;)
</code></pre>
<p>å¯ä»¥ä½¿ç”¨ä»¥ä¸‹GORMæ ‡ç­¾åˆ†åˆ«æŒ‡å®šå¤šæ€æ€§å±æ€§:</p>
<ul>
<li><code>polymorphicType</code>:åˆ—çš„ç±»å‹ã€‚</li>
<li><code>polymorphicId</code>:åˆ—IDã€‚</li>
<li><code>polymorphicValue</code>:ç±»å‹å€¼ã€‚</li>
</ul>
<pre><code class="language-go">type Dog struct {
  ID   int
  Name string
  Toys []Toy `gorm:&quot;polymorphicType:Kind;polymorphicId:OwnerID;polymorphicValue:master&quot;`
}

type Toy struct {
  ID        int
  Name      string
  OwnerID   int
  Kind      string
}

db.Create(&amp;Dog{Name: &quot;dog1&quot;, Toys: []Toy{{Name: &quot;toy1&quot;}, {Name: &quot;toy2&quot;}}})
// INSERT INTO `dogs` (`name`) VALUES (&quot;dog1&quot;)
// INSERT INTO `toys` (`name`,`owner_id`,`kind`) VALUES (&quot;toy1&quot;,1,&quot;master&quot;), (&quot;toy2&quot;,1,&quot;master&quot;)
</code></pre>
<h3 id="å¤–é”®çº¦æŸ">å¤–é”®çº¦æŸ</h3>
<p>å¯ä»¥é€šè¿‡ constraint æ ‡ç­¾é…ç½® <code>OnUpdate</code>ã€<code>OnDelete</code> å®ç°å¤–é”®çº¦æŸï¼Œåœ¨ä½¿ç”¨ GORM è¿›è¡Œè¿ç§»æ—¶å®ƒä¼šè¢«åˆ›å»ºï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-go">type User struct {
  gorm.Model
  Name      string
  CompanyID int
  Company   Company `gorm:&quot;constraint:OnUpdate:CASCADE,OnDelete:SET NULL;&quot;`
}

type Company struct {
  ID   int
  Name string
}
</code></pre>
<p><code>OnUpdate:CASCADE</code>ï¼šå½“å…³è”çš„è®°å½•æ›´æ–°æ—¶ï¼Œçº§è”æ›´æ–°å¤–é”®ã€‚<br>
<code>OnDelete:SET NULL</code>ï¼šå½“å…³è”çš„è®°å½•è¢«åˆ é™¤æ—¶ï¼Œå°†å¤–é”®è®¾ç½®ä¸º NULLã€‚</p>
<p>å…¶ä»–å¸¸ç”¨è®¾ç½®ï¼š<br>
<code>OnUpdate:NO ACTION</code>ï¼šå¦‚æœæ›´æ–°è¢«å¼•ç”¨çš„è®°å½•ä¼šå¯¼è‡´è¿åå¤–é”®çº¦æŸï¼Œåˆ™æ›´æ–°æ“ä½œå°†è¢«æ‹’ç»ã€‚è¿™æ˜¯mysqlçš„é»˜è®¤è¡Œä¸ºã€‚<br>
<code>OnDelete:SET DEFAULT</code>ï¼šå½“å…³è”çš„ä¸»è®°å½•è¢«åˆ é™¤æ—¶ï¼Œæ‰€æœ‰ä¸ä¹‹å…³è”çš„è®°å½•çš„å¤–é”®å­—æ®µä¼šè¢«è®¾ç½®ä¸ºé»˜è®¤å€¼ã€‚<br>
<code>OnDelete:NO ACTION</code>ï¼šè¿™æ˜¯è®¸å¤šæ•°æ®åº“ç³»ç»Ÿçš„é»˜è®¤è¡Œä¸ºã€‚å¦‚æœå…³è”çš„ä¸»è®°å½•è¯•å›¾è¢«åˆ é™¤ï¼Œä½†ä»ç„¶æœ‰ä¸ä¹‹å…³è”çš„è®°å½•ï¼Œé‚£ä¹ˆåˆ é™¤æ“ä½œå°†å¤±è´¥ã€‚<br>
<code>OnDelete:RESTRICT</code>ï¼š<br>
ä¸ OnDelete:NO ACTION ç±»ä¼¼ï¼Œå¦‚æœå…³è”çš„ä¸»è®°å½•è¯•å›¾è¢«åˆ é™¤ï¼Œä½†ä»ç„¶æœ‰ä¸ä¹‹å…³è”çš„è®°å½•ï¼Œé‚£ä¹ˆåˆ é™¤æ“ä½œå°†å¤±è´¥ã€‚<br>
<code>OnDelete:DO NOTHING</code>ï¼š<br>
å¦‚æœå…³è”çš„ä¸»è®°å½•è¯•å›¾è¢«åˆ é™¤ï¼Œä½†ä»ç„¶æœ‰ä¸ä¹‹å…³è”çš„è®°å½•ï¼Œé‚£ä¹ˆåˆ é™¤æ“ä½œå°†ç»§ç»­ï¼Œä½†æ˜¯ä¸ä¹‹å…³è”çš„è®°å½•çš„å¤–é”®å­—æ®µä¸ä¼šè¢«æ›´æ”¹ã€‚</p>
<h3 id="å…³è”æ¨¡å¼">å…³è”æ¨¡å¼</h3>
<h4 id="è‡ªåŠ¨åˆ›å»º-æ›´æ–°">è‡ªåŠ¨åˆ›å»ºã€æ›´æ–°</h4>
<p>GORMåœ¨åˆ›å»ºæˆ–æ›´æ–°è®°å½•æ—¶ä¼šè‡ªåŠ¨åœ°ä¿å­˜å…¶å…³è”å’Œå¼•ç”¨ï¼Œä¸»è¦ä½¿ç”¨upsertæŠ€æœ¯æ¥æ›´æ–°ç°æœ‰å…³è”çš„å¤–é”®å¼•ç”¨ã€‚</p>
<ul>
<li>åœ¨åˆ›å»ºæ—¶è‡ªåŠ¨ä¿å­˜å…³è”</li>
</ul>
<p>å½“ä½ åˆ›å»ºä¸€æ¡æ–°çš„è®°å½•æ—¶ï¼ŒGORMä¼šè‡ªåŠ¨ä¿å­˜å®ƒçš„å…³è”æ•°æ®ã€‚ è¿™ä¸ªè¿‡ç¨‹åŒ…æ‹¬å‘å…³è”è¡¨æ’å…¥æ•°æ®ä»¥åŠç»´æŠ¤å¤–é”®å¼•ç”¨ã€‚</p>
<pre><code class="language-go">user := User{
  Name:            &quot;jinzhu&quot;,
  BillingAddress:  Address{Address1: &quot;Billing Address - Address 1&quot;},
  ShippingAddress: Address{Address1: &quot;Shipping Address - Address 1&quot;},
  Emails:          []Email{
    {Email: &quot;jinzhu@example.com&quot;},
    {Email: &quot;jinzhu-2@example.com&quot;},
  },
  Languages:       []Language{
    {Name: &quot;ZH&quot;},
    {Name: &quot;EN&quot;},
  },
}

// åˆ›å»ºç”¨æˆ·åŠå…¶å…³è”çš„åœ°å€ã€ç”µå­é‚®ä»¶å’Œè¯­è¨€
db.Create(&amp;user)
// BEGIN TRANSACTION;
// INSERT INTO &quot;addresses&quot; (address1) VALUES (&quot;Billing Address - Address 1&quot;), (&quot;Shipping Address - Address 1&quot;) ON DUPLICATE KEY DO NOTHING;
// INSERT INTO &quot;users&quot; (name,billing_address_id,shipping_address_id) VALUES (&quot;jinzhu&quot;, 1, 2);
// INSERT INTO &quot;emails&quot; (user_id,email) VALUES (111, &quot;jinzhu@example.com&quot;), (111, &quot;jinzhu-2@example.com&quot;) ON DUPLICATE KEY DO NOTHING;
// INSERT INTO &quot;languages&quot; (&quot;name&quot;) VALUES ('ZH'), ('EN') ON DUPLICATE KEY DO NOTHING;
// INSERT INTO &quot;user_languages&quot; (&quot;user_id&quot;,&quot;language_id&quot;) VALUES (111, 1), (111, 2) ON DUPLICATE KEY DO NOTHING;
// COMMIT;

db.Save(&amp;user)
</code></pre>
<ul>
<li>é€šè¿‡FullSaveAssociationsæ¥æ›´æ–°å…³è”</li>
</ul>
<p>å¯¹äºéœ€è¦å…¨é¢æ›´æ–°å…³è”æ•°æ®ï¼ˆä¸æ­¢å¤–é”®ï¼‰çš„æƒ…å†µï¼Œå°±åº”è¯¥ä½¿ç”¨ FullSaveAssociations æ–¹æ³•ã€‚</p>
<pre><code class="language-go">// æ›´æ–°ç”¨æˆ·å¹¶å®Œå…¨æ›´æ–°å…¶æ‰€æœ‰å…³è”
db.Session(&amp;gorm.Session{FullSaveAssociations: true}).Updates(&amp;user)
// SQLï¼šå®Œå…¨æ›´æ–°åœ°å€ã€ç”¨æˆ·ã€ç”µå­é‚®ä»¶è¡¨ï¼ŒåŒ…æ‹¬ç°æœ‰çš„å…³è”è®°å½•
</code></pre>
<p>ä½¿ç”¨FullSaveAssociations æ–¹æ³•æ¥ç¡®ä¿æ¨¡å‹çš„æ•´ä½“çŠ¶æ€ï¼ŒåŒ…æ‹¬å…¶æ‰€æœ‰å…³è”éƒ½åæ˜ åœ¨äº†æ•°æ®åº“ä¸­ï¼Œä»åœ¨åº”ç”¨ä¸­ä¿æŒæ•°æ®çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§ã€‚</p>
<h4 id="è·³è¿‡è‡ªåŠ¨åˆ›å»º-æ›´æ–°">è·³è¿‡è‡ªåŠ¨åˆ›å»ºã€æ›´æ–°</h4>
<p>GORMæä¾›äº†åœ¨åˆ›å»ºæˆ–æ›´æ–°æ“ä½œæœŸé—´è·³è¿‡è‡ªåŠ¨ä¿å­˜å…³è”çš„çµæ´»æ€§ã€‚è¿™å¯ä»¥ä½¿ç”¨Selectæˆ–Omitæ–¹æ³•æ¥å®ç°ã€‚</p>
<ul>
<li>ä½¿ç”¨Select æ¥æŒ‡å®šå­—æ®µèŒƒå›´</li>
</ul>
<p>Selectæ–¹æ³•å…è®¸æ‚¨æŒ‡å®šåº”è¯¥ä¿å­˜æ¨¡å‹çš„å“ªäº›å­—æ®µã€‚è¿™æ„å‘³ç€åªæœ‰é€‰å®šçš„å­—æ®µå°†åŒ…å«åœ¨SQLæ“ä½œä¸­ã€‚</p>
<pre><code class="language-go">user := User{
  // User and associated data
}

// Only include the 'Name' field when creating the user
db.Select(&quot;Name&quot;).Create(&amp;user)
// SQL: INSERT INTO &quot;users&quot; (name) VALUES (&quot;jinzhu&quot;);
</code></pre>
<ul>
<li>ä½¿ç”¨Omitæ¥æ’é™¤å­—æ®µæˆ–å…³è”</li>
</ul>
<p>ç›¸åï¼Œçœç•¥å…è®¸æ‚¨åœ¨ä¿å­˜æ¨¡å‹æ—¶æ’é™¤æŸäº›å­—æ®µæˆ–å…³è”ã€‚</p>
<pre><code class="language-go">// Skip creating the 'BillingAddress' when creating the user
db.Omit(&quot;BillingAddress&quot;).Create(&amp;user)

// Skip all associations when creating the user
db.Omit(clause.Associations).Create(&amp;user)
</code></pre>
<p><strong>æ³¨æ„</strong>:å¯¹äºå¤šå¯¹å¤šå…³è”ï¼ŒGORMä¼šåœ¨åˆ›å»ºè¿æ¥è¡¨å¼•ç”¨ä¹‹å‰æ’å…¥å…³è”ã€‚è‹¥è¦è·³è¿‡æ­¤è®¾ç½®ï¼Œè¯·ä½¿ç”¨çœç•¥å’Œå…³è”åç§°åé¢è·Ÿç€ã€‚*:</p>
<pre><code class="language-go">// Skip upserting 'Languages' associations
db.Omit(&quot;Languages.*&quot;).Create(&amp;user)
</code></pre>
<p>è·³è¿‡åˆ›å»ºå…³è”åŠå…¶å¼•ç”¨:</p>
<pre><code class="language-go">// Skip creating 'Languages' associations and their references
db.Omit(&quot;Languages&quot;).Create(&amp;user)
</code></pre>
<h4 id="selectomit-å…³è”å­—æ®µ">Select/Omit å…³è”å­—æ®µ</h4>
<p>åœ¨GORMä¸­ï¼Œå½“åˆ›å»ºæˆ–æ›´æ–°è®°å½•æ—¶ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨Selectå’ŒOmitæ–¹æ³•æ¥æ˜ç¡®åœ°åŒ…æ‹¬æˆ–æ’é™¤å…³è”æ¨¡å‹çš„æŸäº›å­—æ®µã€‚<br>
ä½¿ç”¨Selectï¼Œæ‚¨å¯ä»¥æŒ‡å®šåœ¨ä¿å­˜ä¸»æ¨¡å‹æ—¶åº”è¯¥åŒ…å«å…³è”æ¨¡å‹çš„å“ªäº›å­—æ®µã€‚è¿™å¯¹äºæœ‰é€‰æ‹©åœ°ä¿å­˜å…³è”çš„æŸäº›éƒ¨åˆ†ç‰¹åˆ«æœ‰ç”¨ã€‚<br>
ç›¸åï¼Œçœç•¥å…è®¸æ‚¨ä»ä¿å­˜ä¸­æ’é™¤å…³è”æ¨¡å‹çš„æŸäº›å­—æ®µã€‚å½“æ‚¨æƒ³è¦é˜»æ­¢å…³è”çš„ç‰¹å®šéƒ¨åˆ†è¢«æŒä¹…åŒ–æ—¶ï¼Œè¿™å¾ˆæœ‰ç”¨ã€‚</p>
<pre><code class="language-go">user := User{
  Name:            &quot;jinzhu&quot;,
  BillingAddress:  Address{Address1: &quot;Billing Address - Address 1&quot;, Address2: &quot;addr2&quot;},
  ShippingAddress: Address{Address1: &quot;Shipping Address - Address 1&quot;, Address2: &quot;addr2&quot;},
}

// Create user and his BillingAddress, ShippingAddress, including only specified fields of BillingAddress
db.Select(&quot;BillingAddress.Address1&quot;, &quot;BillingAddress.Address2&quot;).Create(&amp;user)
// SQL: Creates user and BillingAddress with only 'Address1' and 'Address2' fields

// Create user and his BillingAddress, ShippingAddress, excluding specific fields of BillingAddress
db.Omit(&quot;BillingAddress.Address2&quot;, &quot;BillingAddress.CreatedAt&quot;).Create(&amp;user)
// SQL: Creates user and BillingAddress, omitting 'Address2' and 'CreatedAt' fields
</code></pre>
<h4 id="åˆ é™¤å…³è”">åˆ é™¤å…³è”</h4>
<p>GORMå…è®¸åœ¨åˆ é™¤ä¸»è®°å½•æ—¶ä½¿ç”¨Selectæ–¹æ³•åˆ é™¤ç‰¹å®šçš„å…³è”å…³ç³»(has one, has many, many2many)ã€‚æ­¤ç‰¹æ€§å¯¹äºç»´æŠ¤æ•°æ®åº“å®Œæ•´æ€§å’Œç¡®ä¿åœ¨åˆ é™¤æ—¶é€‚å½“ç®¡ç†ç›¸å…³æ•°æ®ç‰¹åˆ«æœ‰ç”¨ã€‚</p>
<p>å¯ä»¥ä½¿ç”¨<code>Select</code>æŒ‡å®šå“ªäº›å…³è”åº”è¯¥ä¸ä¸»è®°å½•ä¸€èµ·åˆ é™¤ã€‚</p>
<pre><code class="language-go">// Delete a user's account when deleting the user
db.Select(&quot;Account&quot;).Delete(&amp;user)

// Delete a user's Orders and CreditCards associations when deleting the user
db.Select(&quot;Orders&quot;, &quot;CreditCards&quot;).Delete(&amp;user)

// Delete all of a user's has one, has many, and many2many associations
db.Select(clause.Associations).Delete(&amp;user)

// Delete each user's account when deleting multiple users
db.Select(&quot;Account&quot;).Delete(&amp;users)
</code></pre>
<h4 id="å…³è”æ¨¡å¼ç›¸å…³">å…³è”æ¨¡å¼ç›¸å…³</h4>
<p>GORMä¸­çš„å…³è”æ¨¡å¼æä¾›äº†å„ç§è¾…åŠ©æ–¹æ³•æ¥å¤„ç†æ¨¡å‹ä¹‹é—´çš„å…³ç³»ï¼Œæä¾›äº†ä¸€ç§æœ‰æ•ˆçš„æ–¹æ³•æ¥ç®¡ç†å…³è”æ•°æ®ã€‚</p>
<p>è¦å¯åŠ¨Association Modeï¼Œè¯·æŒ‡å®šæºæ¨¡å‹å’Œå…³ç³»çš„å­—æ®µåã€‚æºæ¨¡å‹å¿…é¡»åŒ…å«ä¸€ä¸ªä¸»é”®ï¼Œå¹¶ä¸”å…³ç³»çš„å­—æ®µååº”è¯¥ä¸ç°æœ‰çš„å…³è”åŒ¹é…ã€‚</p>
<pre><code class="language-go">var user User
db.Model(&amp;user).Association(&quot;Languages&quot;)
// Check for errors
error := db.Model(&amp;user).Association(&quot;Languages&quot;).Error
</code></pre>
<ul>
<li>æŸ¥è¯¢å…³è”</li>
</ul>
<p>æ£€ç´¢æœ‰æˆ–æ²¡æœ‰é™„åŠ æ¡ä»¶çš„å…³è”è®°å½•ã€‚</p>
<pre><code class="language-go">// Simple find
db.Model(&amp;user).Association(&quot;Languages&quot;).Find(&amp;languages)

// Find with conditions
codes := []string{&quot;zh-CN&quot;, &quot;en-US&quot;, &quot;ja-JP&quot;}
db.Model(&amp;user).Where(&quot;code IN ?&quot;, codes).Association(&quot;Languages&quot;).Find(&amp;languages)
</code></pre>
<ul>
<li>è¿½åŠ å…³è”</li>
</ul>
<p>ä¸ºmany to manyã€has manyæ·»åŠ æ–°çš„å…³è”ï¼Œæˆ–è€…ä¸ºhas oneã€belongs toæ›¿æ¢å½“å‰å…³è”ã€‚</p>
<pre><code class="language-go">// Append new languages
db.Model(&amp;user).Association(&quot;Languages&quot;).Append([]Language{languageZH, languageEN})

db.Model(&amp;user).Association(&quot;Languages&quot;).Append(&amp;Language{Name: &quot;DE&quot;})

db.Model(&amp;user).Association(&quot;CreditCard&quot;).Append(&amp;CreditCard{Number: &quot;411111111111&quot;}
</code></pre>
<ul>
<li>æ›¿æ¢å…³è”</li>
</ul>
<p>ç”¨æ–°å…³è”æ›¿æ¢å½“å‰å…³è”</p>
<pre><code class="language-go">// Replace existing languages
db.Model(&amp;user).Association(&quot;Languages&quot;).Replace([]Language{languageZH, languageEN})

db.Model(&amp;user).Association(&quot;Languages&quot;).Replace(Language{Name: &quot;DE&quot;}, languageEN)
</code></pre>
<ul>
<li>åˆ é™¤å…³è”</li>
</ul>
<p>åˆ é™¤æºå’Œå‚æ•°ä¹‹é—´çš„å…³ç³»ï¼Œåªåˆ é™¤å¼•ç”¨ã€‚</p>
<pre><code class="language-go">// Delete specific languages
db.Model(&amp;user).Association(&quot;Languages&quot;).Delete([]Language{languageZH, languageEN})

db.Model(&amp;user).Association(&quot;Languages&quot;).Delete(languageZH, languageEN)
</code></pre>
<ul>
<li>æ¸…ç©ºå…³è”</li>
</ul>
<p>åˆ é™¤æºå’Œå…³è”ä¹‹é—´çš„æ‰€æœ‰å¼•ç”¨ã€‚</p>
<pre><code class="language-go">// Clear all languages
db.Model(&amp;user).Association(&quot;Languages&quot;).Clear()
</code></pre>
<ul>
<li>å…³è”è®¡æ•°</li>
</ul>
<p>è·å–å¸¦æœ‰æˆ–ä¸å¸¦æœ‰æ¡ä»¶çš„å½“å‰å…³è”çš„è®¡æ•°ã€‚</p>
<pre><code class="language-go">// Count all languages
db.Model(&amp;user).Association(&quot;Languages&quot;).Count()

// Count with conditions
codes := []string{&quot;zh-CN&quot;, &quot;en-US&quot;, &quot;ja-JP&quot;}
db.Model(&amp;user).Where(&quot;code IN ?&quot;, codes).Association(&quot;Languages&quot;).Count()

</code></pre>
<ul>
<li>
<p>æ‰¹é‡æ•°æ®å¤„ç†<br>
å…³è”æ¨¡å¼å…è®¸æ‚¨å¤„ç†æ‰¹å¤„ç†ä¸­å¤šæ¡è®°å½•çš„å…³ç³»ã€‚è¿™åŒ…æ‹¬æŸ¥æ‰¾ã€è¿½åŠ ã€æ›¿æ¢ã€åˆ é™¤å’Œè®¡æ•°ç›¸å…³æ•°æ®çš„æ“ä½œã€‚</p>
<ul>
<li><strong>æŸ¥æ‰¾å…³è”</strong>:æ£€ç´¢è®°å½•é›†åˆçš„å…³è”æ•°æ®ã€‚</li>
</ul>
<pre><code class="language-go">db.Model(&amp;users).Association(&quot;Role&quot;).Find(&amp;roles)
</code></pre>
<ul>
<li><strong>åˆ é™¤å…³è”</strong>:åˆ é™¤å¤šä¸ªè®°å½•ä¹‹é—´çš„ç‰¹å®šå…³è”ã€‚</li>
</ul>
<pre><code class="language-go">db.Model(&amp;users).Association(&quot;Team&quot;).Delete(&amp;userA)
</code></pre>
<ul>
<li><strong>è®¡æ•°å…³è”</strong>:è·å–ä¸€æ‰¹è®°å½•çš„å…³è”è®¡æ•°ã€‚</li>
</ul>
<pre><code class="language-go">db.Model(&amp;users).Association(&quot;Team&quot;).Count()
</code></pre>
<ul>
<li><strong>è¿½åŠ /æ›¿æ¢å…³è”</strong>:ç®¡ç†å¤šä¸ªè®°å½•çš„å…³è”ã€‚æ³¨æ„éœ€è¦å°†å‚æ•°é•¿åº¦ä¸æ•°æ®åŒ¹é…ã€‚</li>
</ul>
<pre><code class="language-go">var users = []User{user1, user2, user3}

// Append different teams to different users in a batch
// Append userA to user1's team, userB to user2's team, and userA, userB, userC to user3's team
db.Model(&amp;users).Association(&quot;Team&quot;).Append(&amp;userA, &amp;userB, &amp;[]User{userA, userB, userC})

// Replace teams for multiple users in a batch
// Reset user1's team to userA, user2's team to userB, and user3's team to userA, userB, and userC
db.Model(&amp;users).Association(&quot;Team&quot;).Replace(&amp;userA, &amp;userB, &amp;[]User{userA, userB, userC})
</code></pre>
</li>
</ul>
<h4 id="åˆ é™¤å…³è”è®°å½•">åˆ é™¤å…³è”è®°å½•</h4>
<p>åœ¨GORMä¸­ï¼Œå…³è”æ¨¡å¼ä¸­çš„Replaceã€Deleteå’ŒClearæ–¹æ³•ä¸»è¦å½±å“å¤–é”®å¼•ç”¨ï¼Œè€Œä¸æ˜¯å…³è”çš„è®°å½•æœ¬èº«ã€‚ç†è§£å’Œç®¡ç†è¿™ç§è¡Œä¸ºå¯¹äºæ•°æ®å®Œæ•´æ€§è‡³å…³é‡è¦ã€‚</p>
<ul>
<li><strong>å¼•ç”¨æ›´æ–°</strong>:è¿™äº›æ–¹æ³•å°†å…³è”çš„å¤–é”®æ›´æ–°ä¸ºnullï¼Œæœ‰æ•ˆåœ°åˆ é™¤æºå’Œå…³è”æ¨¡å‹ä¹‹é—´çš„é“¾æ¥ã€‚</li>
<li><strong>æ— ç‰©ç†è®°å½•åˆ é™¤</strong>:å®é™…å…³è”çš„è®°å½•åœ¨æ•°æ®åº“ä¸­ä¿æŒä¸å˜ã€‚</li>
</ul>
<p><strong>é€šè¿‡Unscopedæ¥å˜æ›´é»˜è®¤çš„åˆ é™¤è¡Œä¸º</strong>:</p>
<p>å¯¹äºéœ€è¦å®é™…åˆ é™¤å…³è”è®°å½•çš„åœºæ™¯ï¼ŒUnscopedæ–¹æ³•ä¼šæ”¹å˜æ­¤è¡Œä¸ºã€‚</p>
<ul>
<li>
<p><strong>è½¯åˆ é™¤</strong>:å°†å…³è”çš„è®°å½•æ ‡è®°ä¸ºå·²åˆ é™¤(è®¾ç½®deleted_atå­—æ®µ)ï¼Œè€Œä¸ä»æ•°æ®åº“ä¸­åˆ é™¤å®ƒä»¬ã€‚</p>
<pre><code class="language-go">db.Model(&amp;user).Association(&quot;Languages&quot;).Unscoped().Clear()
</code></pre>
</li>
<li>
<p><strong>æ°¸ä¹…åˆ é™¤</strong>:å¯¹æ•°æ®åº“ä¸­çš„å…³è”è®°å½•è¿›è¡Œç‰©ç†åˆ é™¤ã€‚</p>
<pre><code class="language-go">// db.Unscoped().Model(&amp;user)
db.Unscoped().Model(&amp;user).Association(&quot;Languages&quot;).Unscoped().Clear()
</code></pre>
</li>
</ul>
<h4 id="å…³è”æ ‡ç­¾association-tags">å…³è”æ ‡ç­¾ï¼ˆAssociation Tagsï¼‰</h4>
<p>GORMä¸­çš„å…³è”æ ‡ç­¾é€šå¸¸ç”¨äºæŒ‡å®šå¦‚ä½•å¤„ç†æ¨¡å‹ä¹‹é—´çš„å…³è”ã€‚ è¿™äº›æ ‡ç­¾å®šä¹‰äº†ä¸€äº›å…³ç³»ç»†èŠ‚ï¼Œæ¯”å¦‚å¤–é”®ï¼Œå¼•ç”¨å’Œçº¦æŸã€‚ ç†è§£è¿™äº›æ ‡ç­¾å¯¹äºæœ‰æ•ˆåœ°å»ºç«‹å’Œç®¡ç†æ¨¡å‹ä¹‹é—´çš„å…³ç³»è€Œè¨€è‡³å…³é‡è¦ã€‚</p>
<table>
<thead>
<tr>
<th>æ ‡ç­¾</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>foreignKey</td>
<td>æŒ‡å®šè¿æ¥è¡¨ä¸­ç”¨ä½œå¤–é”®çš„å½“å‰æ¨¡å‹çš„åˆ—åã€‚</td>
</tr>
<tr>
<td>references</td>
<td>æŒ‡ç¤ºè¿æ¥è¡¨çš„å¤–é”®æ˜ å°„åˆ°çš„å¼•ç”¨è¡¨ä¸­çš„åˆ—åã€‚</td>
</tr>
<tr>
<td>polymorphic</td>
<td>å®šä¹‰å¤šæ€ç±»å‹ï¼Œé€šå¸¸æ˜¯æ¨¡å‹åç§°ã€‚</td>
</tr>
<tr>
<td>polymorphicValue</td>
<td>å¦‚æœæ²¡æœ‰å¦è¡ŒæŒ‡å®šï¼Œåˆ™è®¾ç½®å¤šæ€å€¼ï¼Œé€šå¸¸ä¸ºè¡¨åã€‚</td>
</tr>
<tr>
<td>many2many</td>
<td>å‘½åå¤šå¯¹å¤šå…³ç³»ä¸­ä½¿ç”¨çš„è¿æ¥è¡¨ã€‚</td>
</tr>
<tr>
<td>joinForeignKey</td>
<td>æ ‡è¯†è¿æ¥è¡¨ä¸­æ˜ å°„å›å½“å‰æ¨¡å‹è¡¨çš„å¤–é”®åˆ—ã€‚</td>
</tr>
<tr>
<td>joinReferences</td>
<td>æŒ‡å‘é“¾æ¥åˆ°å‚è€ƒæ¨¡å‹è¡¨çš„è¿æ¥è¡¨ä¸­çš„å¤–é”®åˆ—ã€‚</td>
</tr>
<tr>
<td>constraint</td>
<td>ä¸ºå…³è”æŒ‡å®šå…³ç³»çº¦æŸï¼Œå¦‚OnUpdate, OnDeleteã€‚</td>
</tr>
</tbody>
</table>
<h3 id="é¢„åŠ è½½3">é¢„åŠ è½½ã€3ã€‘</h3>
<h4 id="é¢„åŠ è½½ç¤ºä¾‹">é¢„åŠ è½½ç¤ºä¾‹</h4>
<p>GORMå…è®¸ä½¿ç”¨ Preloadé€šè¿‡å¤šä¸ªSQLä¸­æ¥ç›´æ¥åŠ è½½å…³ç³», ä¾‹å¦‚ï¼š</p>
<pre><code class="language-go">type User struct {
  gorm.Model
  Username string
  Orders   []Order
}

type Order struct {
  gorm.Model
  UserID uint
  Price  float64
}

// æŸ¥æ‰¾ user æ—¶é¢„åŠ è½½ç›¸å…³ Order
db.Preload(&quot;Orders&quot;).Find(&amp;users)
// SELECT * FROM users;
// SELECT * FROM orders WHERE user_id IN (1,2,3,4);

db.Preload(&quot;Orders&quot;).Preload(&quot;Profile&quot;).Preload(&quot;Role&quot;).Find(&amp;users)
// SELECT * FROM users;
// SELECT * FROM orders WHERE user_id IN (1,2,3,4); // has many
// SELECT * FROM profiles WHERE user_id IN (1,2,3,4); // has one
// SELECT * FROM roles WHERE id IN (4,5,6); // belongs to
</code></pre>
<h4 id="joins-é¢„åŠ è½½">Joins é¢„åŠ è½½</h4>
<p><code>Preload</code>åœ¨å•ç‹¬çš„æŸ¥è¯¢ä¸­åŠ è½½å…³è”æ•°æ®ï¼Œ<code>Join Preload</code>å°†ä½¿ç”¨å·¦è¿æ¥åŠ è½½å…³è”æ•°æ®ã€‚</p>
<pre><code class="language-go">db.Joins(&quot;Company&quot;).Joins(&quot;Manager&quot;).Joins(&quot;Account&quot;).First(&amp;user, 1)
db.Joins(&quot;Company&quot;).Joins(&quot;Manager&quot;).Joins(&quot;Account&quot;).First(&amp;user, &quot;users.name = ?&quot;, &quot;jinzhu&quot;)
db.Joins(&quot;Company&quot;).Joins(&quot;Manager&quot;).Joins(&quot;Account&quot;).Find(&amp;users, &quot;users.id IN ?&quot;, []int{1,2,3,4,5}
</code></pre>
<p>å¸¦æ¡ä»¶çš„join</p>
<pre><code class="language-go">db.Joins(&quot;Company&quot;, DB.Where(&amp;Company{Alive: true})).Find(&amp;users)
// SELECT `users`.`id`,`users`.`name`,`users`.`age`,`Company`.`id` AS `Company__id`,`Company`.`name` AS `Company__name` 
// FROM `users` 
// LEFT JOIN `companies` AS `Company` 
//ON `users`.`company_id` = `Company`.`id` AND `Company`.`alive` = true;
</code></pre>
<p>joinåµŒå¥—æ¨¡å‹</p>
<pre><code class="language-go">db.Joins(&quot;Manager&quot;).Joins(&quot;Manager.Company&quot;).Find(&amp;users)
// SELECT &quot;users&quot;.&quot;id&quot;,&quot;users&quot;.&quot;created_at&quot;,&quot;users&quot;.&quot;updated_at&quot;,&quot;users&quot;.&quot;deleted_at&quot;,&quot;users&quot;.&quot;name&quot;,&quot;users&quot;.&quot;age&quot;,&quot;users&quot;.&quot;birthday&quot;,&quot;users&quot;.&quot;company_id&quot;,&quot;users&quot;.&quot;manager_id&quot;,&quot;users&quot;.&quot;active&quot;,&quot;Manager&quot;.&quot;id&quot; AS &quot;Manager__id&quot;,&quot;Manager&quot;.&quot;created_at&quot; AS &quot;Manager__created_at&quot;,&quot;Manager&quot;.&quot;updated_at&quot; AS &quot;Manager__updated_at&quot;,&quot;Manager&quot;.&quot;deleted_at&quot; AS &quot;Manager__deleted_at&quot;,&quot;Manager&quot;.&quot;name&quot; AS &quot;Manager__name&quot;,&quot;Manager&quot;.&quot;age&quot; AS &quot;Manager__age&quot;,&quot;Manager&quot;.&quot;birthday&quot; AS &quot;Manager__birthday&quot;,&quot;Manager&quot;.&quot;company_id&quot; AS &quot;Manager__company_id&quot;,&quot;Manager&quot;.&quot;manager_id&quot; AS &quot;Manager__manager_id&quot;,&quot;Manager&quot;.&quot;active&quot; AS &quot;Manager__active&quot;,&quot;Manager__Company&quot;.&quot;id&quot; AS &quot;Manager__Company__id&quot;,&quot;Manager__Company&quot;.&quot;name&quot; AS &quot;Manager__Company__name&quot; 
// FROM &quot;users&quot; 
// LEFT JOIN &quot;users&quot; &quot;Manager&quot; 
// ON &quot;users&quot;.&quot;manager_id&quot; = &quot;Manager&quot;.&quot;id&quot; AND &quot;Manager&quot;.&quot;deleted_at&quot; IS NULL 
// LEFT JOIN &quot;companies&quot; &quot;Manager__Company&quot; 
// ON &quot;Manager&quot;.&quot;company_id&quot; = &quot;Manager__Company&quot;.&quot;id&quot; 
// WHERE &quot;users&quot;.&quot;deleted_at&quot; IS NULL
</code></pre>
<p><code>Join Preload</code>æ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»ï¼Œä¾‹å¦‚has one, belong to</p>
<h4 id="é¢„åŠ è½½å…¨éƒ¨">é¢„åŠ è½½å…¨éƒ¨</h4>
<p><code>clause.Associations</code> can work with <code>Preload</code> similar like <code>Select</code> when creating/updating,<br>
you can use it to <code>Preload</code> all associations, for example:</p>
<p><code>clause.Associations</code>å¯ä»¥åƒselecté‚£æ ·åœ¨åˆ›å»º/æ›´æ–°æ—¶ç”¨äº<code>Preload</code>ï¼Œå¯ä»¥ç”¨å®ƒé¢„åŠ è½½æ‰€æœ‰çš„å…³è”ã€‚</p>
<pre><code class="language-go">type User struct {
  gorm.Model
  Name       string
  CompanyID  uint
  Company    Company
  Role       Role
  Orders     []Order
}

db.Preload(clause.Associations).Find(&amp;users)
</code></pre>
<p><code>clause.Associations</code>ä¸ä¼šé¢„åŠ è½½åµŒå¥—å…³è”ï¼Œä½†ä½ å¯ä»¥å°†å®ƒä¸<a href="#%E5%B5%8C%E5%A5%97%E9%A2%84%E5%8A%A0%E8%BD%BD">åµŒå¥—é¢„åŠ è½½</a>ä¸€èµ·ä½¿ç”¨ï¼Œä¾‹å¦‚:</p>
<pre><code class="language-go">db.Preload(&quot;Orders.OrderItems.Product&quot;).Preload(clause.Associations).Find(&amp;users)
</code></pre>
<h4 id="æ¡ä»¶é¢„åŠ è½½">æ¡ä»¶é¢„åŠ è½½</h4>
<p>GORMå…è®¸é¢„åŠ è½½ä¸æ¡ä»¶å…³è”ï¼Œå®ƒçš„å·¥ä½œåŸç†ç±»ä¼¼äº<a href="#%E6%A0%B9%E6%8D%AE%E6%9D%A1%E4%BB%B6%E6%9F%A5%E8%AF%A2">æ ¹æ®æ¡ä»¶æŸ¥è¯¢</a>çš„å†…è”æ¡ä»¶ã€‚</p>
<pre><code class="language-go">// Preload Orders with conditions
db.Preload(&quot;Orders&quot;, &quot;state NOT IN (?)&quot;, &quot;cancelled&quot;).Find(&amp;users)
// SELECT * FROM users;
// SELECT * FROM orders WHERE user_id IN (1,2,3,4) AND state NOT IN ('cancelled');

db.Where(&quot;state = ?&quot;, &quot;active&quot;).Preload(&quot;Orders&quot;, &quot;state NOT IN (?)&quot;, &quot;cancelled&quot;).Find(&amp;users)
// SELECT * FROM users WHERE state = 'active';
// SELECT * FROM orders WHERE user_id IN (1,2) AND state NOT IN ('cancelled');
</code></pre>
<h4 id="è‡ªå®šä¹‰é¢„åŠ è½½-sql">è‡ªå®šä¹‰é¢„åŠ è½½ SQL</h4>
<p>å¯ä»¥é€šè¿‡ä¼ å…¥<code>func(db *gorm.DB) *gorm.DB</code>æ¥è‡ªå®šä¹‰é¢„åŠ è½½SQLï¼Œä¾‹å¦‚:</p>
<pre><code class="language-go">db.Preload(&quot;Orders&quot;, func(db *gorm.DB) *gorm.DB {
  return db.Order(&quot;orders.amount DESC&quot;)
}).Find(&amp;users)
// SELECT * FROM users;
// SELECT * FROM orders WHERE user_id IN (1,2,3,4) order by orders.amount DESC;
</code></pre>
<h4 id="åµŒå¥—é¢„åŠ è½½">åµŒå¥—é¢„åŠ è½½</h4>
<p>GORMæ”¯æŒåµŒå¥—é¢„åŠ è½½ï¼Œä¾‹å¦‚:</p>
<pre><code class="language-go">db.Preload(&quot;Orders.OrderItems.Product&quot;).Preload(&quot;CreditCard&quot;).Find(&amp;users)

// Customize Preload conditions for `Orders`
// And GORM won't preload unmatched order's OrderItems then
db.Preload(&quot;Orders&quot;, &quot;state = ?&quot;, &quot;paid&quot;).Preload(&quot;Orders.OrderItems&quot;).Find(&amp;users)

</code></pre>
<h4 id="åµŒå…¥å¼é¢„åŠ è½½">åµŒå…¥å¼é¢„åŠ è½½</h4>
<p>åµŒå…¥å¼é¢„åŠ è½½ç”¨äºåµŒå…¥å¼ç»“æ„ä½“ï¼Œç‰¹åˆ«æ˜¯åŒä¸€ç»“æ„ä½“ã€‚åµŒå…¥å¼é¢„åŠ è½½çš„è¯­æ³•ç±»ä¼¼äºåµŒå¥—é¢„åŠ è½½ï¼Œå®ƒä»¬ç”±ç‚¹åˆ’åˆ†ã€‚</p>
<pre><code class="language-go">type Address struct {
    CountryID int
    Country   Country
}

type Org struct {
    PostalAddress   Address `gorm:&quot;embedded;embeddedPrefix:postal_address_&quot;`
    VisitingAddress Address `gorm:&quot;embedded;embeddedPrefix:visiting_address_&quot;`
    Address         struct {
        ID int
        Address
    }
}

// Only preload Org.Address and Org.Address.Country
db.Preload(&quot;Address.Country&quot;)  // &quot;Address&quot; is has_one, &quot;Country&quot; is belongs_to (nested association)

// Only preload Org.VisitingAddress
db.Preload(&quot;PostalAddress.Country&quot;) // &quot;PostalAddress.Country&quot; is belongs_to (embedded association)

// Only preload Org.NestedAddress
db.Preload(&quot;NestedAddress.Address.Country&quot;) // &quot;NestedAddress.Address.Country&quot; is belongs_to (embedded association)

// All preloaded include &quot;Address&quot; but exclude &quot;Address.Country&quot;, because it won't preload nested associations.
db.Preload(clause.Associations)
</code></pre>
<p>åœ¨æ²¡æœ‰æ­§ä¹‰çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥çœç•¥åµŒå…¥éƒ¨åˆ†ã€‚</p>
<pre><code class="language-go">type Address struct {
    CountryID int
    Country   Country
}

type Org struct {
    Address Address `gorm:&quot;embedded&quot;`
}

db.Preload(&quot;Address.Country&quot;).Find(&amp;orgs)
db.Preload(&quot;Country&quot;).Find(&amp;orgs) // omit &quot;Address&quot; because there is no ambiguity
</code></pre>
<h2 id="æ•™ç¨‹">æ•™ç¨‹</h2>
<h3 id="ä¸Šä¸‹æ–‡2">ä¸Šä¸‹æ–‡ã€2ã€‘</h3>
<p>GORM çš„ä¸Šä¸‹æ–‡æ”¯æŒç”± WithContext æ–¹æ³•å¯ç”¨ï¼Œæ˜¯ä¸€é¡¹å¼ºå¤§çš„åŠŸèƒ½ï¼Œå¯ä»¥å¢å¼º Go åº”ç”¨ç¨‹åºä¸­æ•°æ®åº“æ“ä½œçš„çµæ´»æ€§å’Œæ§åˆ¶åŠ›ã€‚ å®ƒå…è®¸åœ¨ä¸åŒçš„æ“ä½œæ¨¡å¼ã€è¶…æ—¶è®¾ç½®ä»¥åŠç”šè‡³é›†æˆåˆ°é’©å­/å›è°ƒå’Œä¸­é—´ä»¶ä¸­è¿›è¡Œä¸Šä¸‹æ–‡ç®¡ç†ã€‚</p>
<h4 id="å•ä¼šè¯æ¨¡å¼">å•ä¼šè¯æ¨¡å¼</h4>
<p>å•ä¼šè¯æ¨¡å¼é€‚ç”¨äºæ‰§è¡Œå•ä¸ªæ“ä½œã€‚å®ƒç¡®ä¿ç‰¹å®šæ“ä½œåœ¨ä¸Šä¸‹æ–‡èŒƒå›´å†…æ‰§è¡Œï¼Œä»è€Œå®ç°æ›´å¥½çš„æ§åˆ¶å’Œç›‘è§†ã€‚</p>
<pre><code class="language-go">db.WithContext(ctx).Find(&amp;users)

</code></pre>
<h4 id="è¿ç»­ä¼šè¯æ¨¡å¼">è¿ç»­ä¼šè¯æ¨¡å¼</h4>
<p>è¿ç»­ä¼šè¯æ¨¡å¼æ˜¯æ‰§è¡Œä¸€ç³»åˆ—ç›¸å…³æ“ä½œçš„ç†æƒ³æ¨¡å¼ã€‚å®ƒè·¨è¿™äº›æ“ä½œç»´æŠ¤ä¸Šä¸‹æ–‡ï¼Œè¿™åœ¨äº‹åŠ¡ç­‰åœºæ™¯ä¸­ç‰¹åˆ«æœ‰ç”¨ã€‚</p>
<pre><code class="language-go">tx := db.WithContext(ctx)
tx.First(&amp;user, 1)
tx.Model(&amp;user).Update(&quot;role&quot;, &quot;admin&quot;)
</code></pre>
<h4 id="ä¸Šä¸‹æ–‡è¶…æ—¶">ä¸Šä¸‹æ–‡è¶…æ—¶</h4>
<p>ç»™ä¼ é€’ç»™<code>db.WithContext</code>çš„ä¸Šä¸‹æ–‡è®¾ç½®è¶…æ—¶å¯ä»¥æ§åˆ¶é•¿æ—¶é—´è¿è¡ŒæŸ¥è¯¢çš„æŒç»­æ—¶é—´ã€‚è¿™å¯¹äºç»´æŠ¤æ€§èƒ½å’Œé¿å…æ•°æ®åº“äº¤äº’ä¸­çš„èµ„æºé”å®šè‡³å…³é‡è¦ã€‚</p>
<pre><code class="language-go">ctx, cancel := context.WithTimeout(context.Background(), 2*time.Second)
defer cancel()

db.WithContext(ctx).Find(&amp;users)
</code></pre>
<h4 id="hookscallbacks-ä¸­çš„-context">Hooks/Callbacks ä¸­çš„ Context</h4>
<p>ä¸Šä¸‹æ–‡ä¹Ÿå¯ä»¥åœ¨GORMçš„é’©å­/å›è°ƒä¸­è®¿é—®ã€‚è¿™æ ·å°±å¯ä»¥åœ¨è¿™äº›ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ä¸­ä½¿ç”¨ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</p>
<pre><code class="language-go">func (u *User) BeforeCreate(tx *gorm.DB) (err error) {
  ctx := tx.Statement.Context
  // ... use context
  return
}
</code></pre>
<h4 id="ä¸chiä¸­é—´ä»¶é›†æˆ">ä¸Chiä¸­é—´ä»¶é›†æˆ</h4>
<p>GORMçš„ä¸Šä¸‹æ–‡æ”¯æŒæ‰©å±•åˆ°webæœåŠ¡å™¨ä¸­é—´ä»¶ï¼Œä¾‹å¦‚Chiè·¯ç”±å™¨ä¸­çš„é‚£äº›ã€‚è¿™å…è®¸ä¸ºwebè¯·æ±‚èŒƒå›´å†…çš„æ‰€æœ‰æ•°æ®åº“æ“ä½œè®¾ç½®ä¸€ä¸ªå¸¦æœ‰è¶…æ—¶çš„ä¸Šä¸‹æ–‡ã€‚</p>
<pre><code class="language-go">func SetDBMiddleware(next http.Handler) http.Handler {
  return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
    timeoutContext, _ := context.WithTimeout(context.Background(), time.Second)
    ctx := context.WithValue(r.Context(), &quot;DB&quot;, db.WithContext(timeoutContext))
    next.ServeHTTP(w, r.WithContext(ctx))
  })
}

// Router setup
r := chi.NewRouter()
r.Use(SetDBMiddleware)

// Route handlers
r.Get(&quot;/&quot;, func(w http.ResponseWriter, r *http.Request) {
  db, ok := r.Context().Value(&quot;DB&quot;).(*gorm.DB)
  // ... db operations
})

r.Get(&quot;/user&quot;, func(w http.ResponseWriter, r *http.Request) {
  db, ok := r.Context().Value(&quot;DB&quot;).(*gorm.DB)
  // ... db operations
})
</code></pre>
<p><strong>æ³¨æ„</strong>ï¼šä½¿ç”¨WithContextè®¾ç½®ä¸Šä¸‹æ–‡æ˜¯è¿goroutineå®‰å…¨çš„ã€‚è¿™ç¡®ä¿äº†è·¨å¤šä¸ªgoroutineå®‰å…¨åœ°ç®¡ç†æ•°æ®åº“æ“ä½œã€‚è¦äº†è§£æ›´å¤šç»†èŠ‚ï¼Œè¯·å‚é˜…GORMä¸­çš„<a href="#session2">Session</a>æ–‡æ¡£ã€‚</p>
<h4 id="loggeré›†æˆ">Loggeré›†æˆ</h4>
<p>GORMçš„Loggerè¿˜æ¥å—ä¸Šä¸‹æ–‡ï¼Œå®ƒå¯ç”¨äºæ—¥å¿—è·Ÿè¸ªå’Œä¸ç°æœ‰æ—¥å¿—åŸºç¡€è®¾æ–½é›†æˆã€‚æŸ¥é˜…<a href="#logger1">Logger</a>è·å–æ›´å¤šç»†èŠ‚ã€‚</p>
<h3 id="é”™è¯¯å¤„ç†2">é”™è¯¯å¤„ç†ã€2ã€‘</h3>
<h4 id="åŸºæœ¬é”™è¯¯å¤„ç†">åŸºæœ¬é”™è¯¯å¤„ç†</h4>
<p>GORMå°†é”™è¯¯å¤„ç†é›†æˆåˆ°å…¶å¯é“¾å¼æ–¹æ³•è¯­æ³•ä¸­ã€‚ <code>*gorm.DB</code>å®ä¾‹åŒ…å«ä¸€ä¸ª<code>Error</code>å­—æ®µï¼Œå½“å‘ç”Ÿé”™è¯¯æ—¶ä¼šè¢«è®¾ç½®ã€‚ é€šå¸¸çš„åšæ³•æ˜¯åœ¨æ‰§è¡Œæ•°æ®åº“æ“ä½œåï¼Œç‰¹åˆ«æ˜¯åœ¨å®Œæˆæ–¹æ³•ï¼ˆFinisher Methodsï¼Œè§é“¾å¼æ“ä½œçš„[æ–¹æ³•ç±»åˆ«]ï¼‰åï¼Œæ£€æŸ¥è¿™ä¸ªå­—æ®µã€‚</p>
<pre><code class="language-go">if err := db.Where(&quot;name = ?&quot;, &quot;jinzhu&quot;).First(&amp;user).Error; err != nil {
  // å¤„ç†é”™è¯¯...
}
if result := db.Where(&quot;name = ?&quot;, &quot;jinzhu&quot;).First(&amp;user); result.Error != nil {
  // å¤„ç†é”™è¯¯...
}
</code></pre>
<h4 id="errrecordnotfound">ErrRecordNotFound</h4>
<p>å½“ä½¿ç”¨<code>First</code>ã€<code>Last</code>ã€<code>Take</code>ç­‰æ–¹æ³•æœªæ‰¾åˆ°è®°å½•æ—¶ï¼ŒGORMä¼šè¿”å›E<code>rrRecordNotFound</code>ã€‚</p>
<pre><code class="language-go">err := db.First(&amp;user, 100).Error
if errors.Is(err, gorm.ErrRecordNotFound) {
  // å¤„ç†æœªæ‰¾åˆ°è®°å½•çš„é”™è¯¯...
}
</code></pre>
<h4 id="å¤„ç†é”™è¯¯ä»£ç ">å¤„ç†é”™è¯¯ä»£ç </h4>
<p>è®¸å¤šæ•°æ®åº“è¿”å›å¸¦æœ‰ç‰¹å®šä»£ç çš„é”™è¯¯ï¼Œè¿™äº›ä»£ç å¯èƒ½è¡¨æ˜å„ç§é—®é¢˜ï¼Œå¦‚çº¦æŸè¿è§„ã€è¿æ¥é—®é¢˜æˆ–è¯­æ³•é”™è¯¯ã€‚ åœ¨GORMä¸­å¤„ç†è¿™äº›é”™è¯¯ä»£ç éœ€è¦è§£ææ•°æ®åº“è¿”å›çš„é”™è¯¯å¹¶æå–ç›¸å…³ä»£ç ã€‚</p>
<pre><code class="language-go">import (
    &quot;github.com/go-sql-driver/mysql&quot;
    &quot;gorm.io/gorm&quot;
)

// ...

result := db.Create(&amp;newRecord)
if result.Error != nil {
    if mysqlErr, ok := result.Error.(*mysql.MySQLError); ok {
        switch mysqlErr.Number {
        case 1062: // MySQLä¸­è¡¨ç¤ºé‡å¤æ¡ç›®çš„ä»£ç 
            // å¤„ç†é‡å¤æ¡ç›®
        // ä¸ºå…¶ä»–ç‰¹å®šé”™è¯¯ä»£ç æ·»åŠ æ¡ˆä¾‹
        default:
            // å¤„ç†å…¶ä»–é”™è¯¯
        }
    } else {
        // å¤„ç†éMySQLé”™è¯¯æˆ–æœªçŸ¥é”™è¯¯
    }
}
</code></pre>
<h4 id="æ–¹è¨€è½¬æ¢é”™è¯¯">æ–¹è¨€è½¬æ¢é”™è¯¯</h4>
<p>å½“å¯ç”¨TranslateErroræ—¶ï¼ŒGORMå¯ä»¥è¿”å›ä¸æ‰€ä½¿ç”¨çš„æ•°æ®åº“æ–¹è¨€ç›¸å…³çš„ç‰¹å®šé”™è¯¯ï¼ŒGORMå°†æ•°æ®åº“ç‰¹æœ‰çš„é”™è¯¯è½¬æ¢ä¸ºå…¶è‡ªå·±çš„é€šç”¨é”™è¯¯ã€‚</p>
<pre><code class="language-go">db, err := gorm.Open(postgres.Open(postgresDSN), &amp;gorm.Config{TranslateError: true})
</code></pre>
<ul>
<li>
<p><code>ErrDuplicatedKey</code><br>
å½“æ’å…¥æ“ä½œè¿åå”¯ä¸€çº¦æŸæ—¶ï¼Œä¼šå‘ç”Ÿæ­¤é”™è¯¯ï¼š</p>
<pre><code class="language-go">result := db.Create(&amp;newRecord)
if errors.Is(result.Error, gorm.ErrDuplicatedKey) {
    // å¤„ç†é‡å¤é”®é”™è¯¯...
}
</code></pre>
</li>
<li>
<p><code>ErrForeignKeyViolated</code><br>
å½“è¿åå¤–é”®çº¦æŸæ—¶ï¼Œä¼šé‡åˆ°æ­¤é”™è¯¯ï¼š</p>
<pre><code class="language-go">result := db.Create(&amp;newRecord)
if errors.Is(result.Error, gorm.ErrForeignKeyViolated) {
    // å¤„ç†å¤–é”®è¿è§„é”™è¯¯...
}
</code></pre>
</li>
</ul>
<p>é€šè¿‡å¯ç”¨<code>TranslateError</code>ï¼ŒGORMæä¾›äº†ä¸€ç§æ›´ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æ–¹å¼ï¼Œå°†ä¸åŒæ•°æ®åº“çš„ç‰¹å®šé”™è¯¯è½¬æ¢ä¸ºå¸¸è§çš„GORMé”™è¯¯ç±»å‹ã€‚</p>
<h4 id="errors">Errors</h4>
<p>è¦è·å–GORMå¯èƒ½è¿”å›çš„å®Œæ•´é”™è¯¯åˆ—è¡¨ï¼Œè¯·å‚è€ƒGORMæ–‡æ¡£ä¸­çš„<a href="https://github.com/go-gorm/gorm/blob/master/errors.go">é”™è¯¯åˆ—è¡¨</a>ã€‚</p>
<h3 id="é“¾å¼æ“ä½œ1">é“¾å¼æ“ä½œã€1ã€‘</h3>
<p>GORMçš„æ–¹æ³•é“¾æ¥ç‰¹æ€§æ”¯æŒæµç•…çš„ç¼–ç é£æ ¼ã€‚ä¾‹å¦‚:</p>
<pre><code class="language-go">db.Where(&quot;name = ?&quot;, &quot;jinzhu&quot;).Where(&quot;age = ?&quot;, 18).First(&amp;user)

</code></pre>
<h4 id="æ–¹æ³•ç±»åˆ«">æ–¹æ³•ç±»åˆ«</h4>
<ul>
<li>
<p><code>Chain Methods</code></p>
<p>é“¾å¼æ–¹æ³•ç”¨äºä¿®æ”¹æˆ–è¿½åŠ å­å¥åˆ°å½“å‰è¯­å¥ã€‚ä¸€äº›å¸¸è§çš„é“¾å¼æ–¹æ³•åŒ…æ‹¬:</p>
<ul>
<li><code>Where</code></li>
<li><code>Select</code></li>
<li><code>Omit</code></li>
<li><code>Joins</code></li>
<li><code>Scopes</code></li>
<li><code>Preload</code></li>
<li><code>Raw</code> (Note: <code>Raw</code> ä¸èƒ½ä¸å…¶ä»–å¯é“¾æ–¹æ³•ä¸€èµ·ä½¿ç”¨æ¥æ„å»ºSQL)</li>
</ul>
</li>
</ul>
<p>æœ‰å…³å…¨é¢çš„åˆ—è¡¨ï¼Œè¯·è®¿é—®<a href="https://github.com/go-gorm/gorm/blob/master/chainable_api.go">GORM Chainable API</a>ã€‚æ­¤å¤–ï¼Œ<a href="#%E5%8E%9F%E7%94%9Fsql%E5%92%8Csql%E7%94%9F%E6%88%90%E5%99%A8">SQL æ„å»ºå™¨</a>è¿˜æä¾›äº†å…³äºå­å¥çš„æ›´å¤šç»†èŠ‚ã€‚</p>
<ul>
<li><code>Finisher Methods</code><br>
å®Œæˆå™¨æ–¹æ³•æ˜¯å³æ—¶çš„ï¼Œæ‰§è¡Œç”Ÿæˆå’Œè¿è¡ŒSQLå‘½ä»¤çš„æ³¨å†Œå›è°ƒã€‚è¿™ç±»æ–¹æ³•åŒ…æ‹¬:
<ul>
<li><code>Create</code></li>
<li><code>First</code></li>
<li><code>Find</code></li>
<li><code>Take</code></li>
<li><code>Save</code></li>
<li><code>Update</code></li>
<li><code>Delete</code></li>
<li><code>Scan</code></li>
<li><code>Row</code></li>
<li><code>Rows</code></li>
</ul>
</li>
</ul>
<p>æœ‰å…³å…¨é¢çš„åˆ—è¡¨ï¼Œè¯·è®¿é—®<a href="https://github.com/go-gorm/gorm/blob/master/finisher_api.go">GORM Finisher API</a>ã€‚</p>
<ul>
<li><code>New Session Methods</code></li>
</ul>
<p>GORMå°†<code>Session</code>ã€<code>WithContext</code>å’Œ<code>Debug</code>ç­‰æ–¹æ³•å®šä¹‰ä¸ºæ–°ä¼šè¯æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•å¯¹äºåˆ›å»ºå¯å…±äº«å’Œå¯é‡ç”¨çš„<code>*GORM.DB</code>å®ä¾‹è‡³å…³é‡è¦ã€‚æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…<a href="#session2">Session</a>ã€‚</p>
<h4 id="å¯é‡ç”¨æ€§å’Œå®‰å…¨æ€§">å¯é‡ç”¨æ€§å’Œå®‰å…¨æ€§</h4>
<p>GORMçš„ä¸€ä¸ªå…³é”®æ–¹é¢æ˜¯ç†è§£<code>*GORM.DB</code>å®ä¾‹ä½•æ—¶å¯ä»¥å®‰å…¨é‡ç”¨ã€‚åœ¨<code>Chain Method</code>æˆ–<code>Finisher Method</code>ä¹‹åï¼ŒGORMè¿”å›ä¸€ä¸ªåˆå§‹åŒ–çš„<code>* GORM.DB</code>å®ä¾‹ã€‚æ­¤å®ä¾‹å¯¹äºé‡ç”¨æ¥è¯´æ˜¯ä¸å®‰å…¨çš„ï¼Œå› ä¸ºå®ƒå¯èƒ½ä¼šä¿ç•™ä»¥å‰æ“ä½œçš„æ¡ä»¶ï¼Œä»è€Œå¯èƒ½å¯¼è‡´å—æ±¡æŸ“çš„SQLæŸ¥è¯¢ã€‚ä¾‹å¦‚:</p>
<ul>
<li>Example of Unsafe Reuse</li>
</ul>
<pre><code class="language-go">queryDB := DB.Where(&quot;name = ?&quot;, &quot;jinzhu&quot;)

// First query
queryDB.Where(&quot;age &gt; ?&quot;, 10).First(&amp;user)
// SQL: SELECT * FROM users WHERE name = &quot;jinzhu&quot; AND age &gt; 10

// Second query with unintended compounded condition
queryDB.Where(&quot;age &gt; ?&quot;, 20).First(&amp;user2)
// SQL: SELECT * FROM users WHERE name = &quot;jinzhu&quot; AND age &gt; 10 AND age &gt; 20
</code></pre>
<ul>
<li>Example of Safe Reuse</li>
</ul>
<p>è¦å®‰å…¨åœ°é‡ç”¨<code>*gorm.DB</code>å®ä¾‹ï¼Œè¯·ä½¿ç”¨New Session Method:</p>
<pre><code class="language-go">queryDB := DB.Where(&quot;name = ?&quot;, &quot;jinzhu&quot;).Session(&amp;gorm.Session{})

// First query
queryDB.Where(&quot;age &gt; ?&quot;, 10).First(&amp;user)
// SQL: SELECT * FROM users WHERE name = &quot;jinzhu&quot; AND age &gt; 10

// Second query, safely isolated
queryDB.Where(&quot;age &gt; ?&quot;, 20).First(&amp;user2)
// SQL: SELECT * FROM users WHERE name = &quot;jinzhu&quot; AND age &gt; 20
</code></pre>
<p>åœ¨è¿™ä¸ªåœºæ™¯ä¸­ï¼Œä½¿ç”¨<code>Session(&amp;gorm.Session{})</code>å¯ä»¥ç¡®ä¿æ¯ä¸ªæŸ¥è¯¢éƒ½ä»ä¸€ä¸ªæ–°çš„ä¸Šä¸‹æ–‡å¼€å§‹ï¼Œä»è€Œé˜²æ­¢SQLæŸ¥è¯¢å—åˆ°å…ˆå‰æ“ä½œæ¡ä»¶çš„æ±¡æŸ“ã€‚è¿™å¯¹äºç»´æŠ¤æ•°æ®åº“äº¤äº’çš„å®Œæ•´æ€§å’Œå‡†ç¡®æ€§è‡³å…³é‡è¦ã€‚</p>
<h4 id="examples-for-clarity">Examples for Clarity</h4>
<p>æ²¡çœ‹æ‡‚åœ¨è®²ä»€ä¹ˆï¼Œå¥½åƒå’Œä¸Šé¢å·®ä¸å¤šï¼Œæ€»æ˜¯ç”¨Sessionå°±å¯¹äº†ã€‚</p>
<h3 id="session2">Sessionã€2ã€‘</h3>
<h4 id="dryrun">DryRun</h4>
<p>ç”Ÿæˆ SQL ä½†ä¸æ‰§è¡Œã€‚ å®ƒå¯ä»¥ç”¨äºå‡†å¤‡æˆ–æµ‹è¯•ç”Ÿæˆçš„ SQLï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-go">// æ–°å»ºä¼šè¯æ¨¡å¼
stmt := db.Session(&amp;Session{DryRun: true}).First(&amp;user, 1).Statement
stmt.SQL.String() //=&gt; SELECT * FROM `users` WHERE `id` = $1 ORDER BY `id`
stmt.Vars         //=&gt; []interface{}{1}

// å…¨å±€ DryRun æ¨¡å¼
db, err := gorm.Open(sqlite.Open(&quot;gorm.db&quot;), &amp;gorm.Config{DryRun: true})

// ä¸åŒçš„æ•°æ®åº“ç”Ÿæˆä¸åŒçš„ SQL
stmt := db.Find(&amp;user, 1).Statement
stmt.SQL.String() //=&gt; SELECT * FROM `users` WHERE `id` = $1 // PostgreSQL
stmt.SQL.String() //=&gt; SELECT * FROM `users` WHERE `id` = ?  // MySQL
stmt.Vars         //=&gt; []interface{}{1}
</code></pre>
<p>å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„ä»£ç ç”Ÿæˆæœ€ç»ˆçš„ SQLï¼š</p>
<pre><code class="language-go">// æ³¨æ„ï¼šSQL å¹¶ä¸æ€»æ˜¯èƒ½å®‰å…¨åœ°æ‰§è¡Œï¼ŒGORM ä»…å°†å…¶ç”¨äºæ—¥å¿—ï¼Œå®ƒå¯èƒ½å¯¼è‡´ä¼š SQL æ³¨å…¥
db.Dialector.Explain(stmt.SQL.String(), stmt.Vars...)
// SELECT * FROM `users` WHERE `id` = 1
</code></pre>
<h4 id="é¢„ç¼–è¯‘">é¢„ç¼–è¯‘</h4>
<p>æ²¡çœ‹æ‡‚æœ‰ä»€ä¹ˆç”¨</p>
<h4 id="newdb">NewDB</h4>
<p>é€šè¿‡ NewDB é€‰é¡¹åˆ›å»ºä¸€ä¸ªä¸å¸¦ä¹‹å‰æ¡ä»¶çš„æ–° DBï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-go">tx := db.Where(&quot;name = ?&quot;, &quot;jinzhu&quot;).Session(&amp;gorm.Session{NewDB: true})

tx.First(&amp;user)
// SELECT * FROM users ORDER BY id LIMIT 1

tx.First(&amp;user, &quot;id = ?&quot;, 10)
// SELECT * FROM users WHERE id = 10 ORDER BY id

// ä¸å¸¦ `NewDB` é€‰é¡¹
tx2 := db.Where(&quot;name = ?&quot;, &quot;jinzhu&quot;).Session(&amp;gorm.Session{})
tx2.First(&amp;user)
// SELECT * FROM users WHERE name = &quot;jinzhu&quot; ORDER BY id
</code></pre>
<h4 id="åˆå§‹åŒ–">åˆå§‹åŒ–</h4>
<p>åˆ›å»ºä¸€ä¸ªæ–°çš„æ•°æ®åº“ä¼šè¯ï¼ˆDB å¯¹è±¡ï¼‰ï¼Œè¿™ä¸ªä¼šè¯ä¸å†æ”¯æŒæ–¹æ³•é“¾å¼è°ƒç”¨å’Œ Goroutine å®‰å…¨æ€§ã€‚è¿™æ ·çš„è®¾è®¡å…è®¸å¯¹æŸ¥è¯¢è¡Œä¸ºè¿›è¡Œæ›´ç»†ç²’åº¦çš„æ§åˆ¶ï¼Œä½†ä¹Ÿæ„å‘³ç€éœ€è¦æ›´å°å¿ƒåœ°ç®¡ç†æŸ¥è¯¢çš„æ„å»ºè¿‡ç¨‹ã€‚</p>
<pre><code class="language-go">tx := db.Session(&amp;gorm.Session{Initialized: true})
</code></pre>
<h4 id="è·³è¿‡é’©å­">è·³è¿‡é’©å­</h4>
<p>å¦‚æœæƒ³è·³è¿‡ <code>Hooks</code> æ–¹æ³•ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ <code>SkipHooks</code> ä¼šè¯æ¨¡å¼ï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-go">DB.Session(&amp;gorm.Session{SkipHooks: true}).Create(&amp;user)
DB.Session(&amp;gorm.Session{SkipHooks: true}).Create(&amp;users)
DB.Session(&amp;gorm.Session{SkipHooks: true}).CreateInBatches(users, 100)
DB.Session(&amp;gorm.Session{SkipHooks: true}).Find(&amp;user)
DB.Session(&amp;gorm.Session{SkipHooks: true}).Delete(&amp;user)
DB.Session(&amp;gorm.Session{SkipHooks: true}).Model(User{}).Where(&quot;age &gt; ?&quot;, 18).Updates(&amp;user)
</code></pre>
<h4 id="ç¦ç”¨åµŒå¥—äº‹åŠ¡">ç¦ç”¨åµŒå¥—äº‹åŠ¡</h4>
<p>åœ¨ä¸€ä¸ª DB äº‹åŠ¡ä¸­ä½¿ç”¨ <code>Transaction</code> æ–¹æ³•ï¼ŒGORM ä¼šä½¿ç”¨ <code>SavePoint(savedPointName)</code>ï¼Œ<code>RollbackTo(savedPointName)</code> ä¸ºæä¾›åµŒå¥—äº‹åŠ¡æ”¯æŒã€‚ å¯ä»¥é€šè¿‡ <code>DisableNestedTransaction</code> é€‰é¡¹å…³é—­å®ƒï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-go">db.Session(&amp;gorm.Session{
  DisableNestedTransaction: true,
}).CreateInBatches(&amp;users, 100)
</code></pre>
<h4 id="allowglobalupdate">AllowGlobalUpdate</h4>
<p>GORM é»˜è®¤ä¸å…è®¸è¿›è¡Œå…¨å±€æ›´æ–°/åˆ é™¤ï¼Œè¯¥æ“ä½œä¼šè¿”å› <code>ErrMissingWhereClause</code> é”™è¯¯ã€‚ å¯ä»¥é€šè¿‡å°†ä¸€ä¸ªé€‰é¡¹è®¾ç½®ä¸º true æ¥å¯ç”¨å®ƒï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-go">db.Session(&amp;gorm.Session{
  AllowGlobalUpdate: true,
}).Model(&amp;User{}).Update(&quot;name&quot;, &quot;jinzhu&quot;)
// UPDATE users SET `name` = &quot;jinzhu&quot;
</code></pre>
<h4 id="fullsaveassociations">FullSaveAssociations</h4>
<p>åœ¨åˆ›å»ºã€æ›´æ–°è®°å½•æ—¶ï¼ŒGORM ä¼šé€šè¿‡ <code>Upsert</code> è‡ªåŠ¨ä¿å­˜å…³è”åŠå…¶å¼•ç”¨è®°å½•ã€‚ å¦‚æœæ‚¨æƒ³è¦æ›´æ–°å…³è”çš„æ•°æ®ï¼Œæ‚¨åº”è¯¥ä½¿ç”¨ <code>FullSaveAssociations</code> æ¨¡å¼ï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-go">db.Session(&amp;gorm.Session{FullSaveAssociations: true}).Updates(&amp;user)
// ...
// INSERT INTO &quot;addresses&quot; (address1) VALUES (&quot;Billing Address - Address 1&quot;), (&quot;Shipping Address - Address 1&quot;) ON DUPLICATE KEY SET address1=VALUES(address1);
// INSERT INTO &quot;users&quot; (name,billing_address_id,shipping_address_id) VALUES (&quot;jinzhu&quot;, 1, 2);
// INSERT INTO &quot;emails&quot; (user_id,email) VALUES (111, &quot;jinzhu@example.com&quot;), (111, &quot;jinzhu-2@example.com&quot;) ON DUPLICATE KEY SET email=VALUES(email);
// ...
</code></pre>
<h4 id="context">Context</h4>
<p>é€šè¿‡ <code>Context</code> é€‰é¡¹ï¼Œæ‚¨å¯ä»¥ä¼ å…¥ <code>Context</code> æ¥è¿½è¸ª SQL æ“ä½œï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-go">timeoutCtx, _ := context.WithTimeout(context.Background(), time.Second)
tx := db.Session(&amp;Session{Context: timeoutCtx})

tx.First(&amp;user) // å¸¦æœ‰ context timeoutCtx çš„æŸ¥è¯¢æ“ä½œ
tx.Model(&amp;user).Update(&quot;role&quot;, &quot;admin&quot;) // å¸¦æœ‰ context timeoutCtx çš„æ›´æ–°æ“ä½œ
</code></pre>
<p>GORM ä¹Ÿæä¾›äº†ç®€å†™å½¢å¼çš„æ–¹æ³• <code>WithContext</code>ï¼Œå…¶å®ç°å¦‚ä¸‹ï¼š</p>
<pre><code class="language-go">func (db *DB) WithContext(ctx context.Context) *DB {
  return db.Session(&amp;Session{Context: ctx})
}
</code></pre>
<h4 id="è‡ªå®šä¹‰-logger">è‡ªå®šä¹‰ Logger</h4>
<p>Gorm å…è®¸ä½¿ç”¨ <code>Logger</code> é€‰é¡¹è‡ªå®šä¹‰å†…å»º Loggerï¼ŒæŸ¥çœ‹ <a href="#logger1">Logger</a> è·å–æ›´å¤šä¿¡æ¯ã€‚</p>
<pre><code class="language-go">newLogger := logger.New(log.New(os.Stdout, &quot;\r\n&quot;, log.LstdFlags),
              logger.Config{
                SlowThreshold: time.Second,
                LogLevel:      logger.Silent,
                Colorful:      false,
              })
db.Session(&amp;Session{Logger: newLogger})

db.Session(&amp;Session{Logger: logger.Default.LogMode(logger.Silent)})
</code></pre>
<h4 id="nowfunc">NowFunc</h4>
<p><code>NowFunc</code> å…è®¸æ”¹å˜ GORM è·å–å½“å‰æ—¶é—´çš„å®ç°ï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-go">db.Session(&amp;Session{
  NowFunc: func() time.Time {
    return time.Now().Local()
  },
})
</code></pre>
<h4 id="è°ƒè¯•">è°ƒè¯•</h4>
<p><code>Debug</code> åªæ˜¯å°†ä¼šè¯çš„ Logger ä¿®æ”¹ä¸ºè°ƒè¯•æ¨¡å¼çš„ç®€å†™å½¢å¼ï¼Œå…¶å®ç°å¦‚ä¸‹ï¼š</p>
<pre><code class="language-go">func (db *DB) Debug() (tx *DB) {
  return db.Session(&amp;Session{
    Logger:         db.Logger.LogMode(logger.Info),
  })
}
</code></pre>
<h4 id="æŸ¥è¯¢å­—æ®µ">æŸ¥è¯¢å­—æ®µ</h4>
<p>å£°æ˜æŸ¥è¯¢å­—æ®µ,ä»…è¿”å›é‚£äº›åœ¨æŸ¥è¯¢æ¡ä»¶ä¸­è¢«æ˜ç¡®è®¾ç½®ä¸ºéé›¶å€¼çš„å­—æ®µã€‚</p>
<pre><code class="language-go">db.Session(&amp;gorm.Session{QueryFields: true}).Find(&amp;user)
// SELECT `users`.`name`, `users`.`age`, ... FROM `users` // æœ‰è¯¥é€‰é¡¹
// SELECT * FROM `users` // æ²¡æœ‰è¯¥é€‰é¡¹
</code></pre>
<h4 id="createbatchsize">CreateBatchSize</h4>
<p>é»˜è®¤æ‰¹é‡å¤§å°</p>
<pre><code class="language-go">users = [5000]User{{Name: &quot;jinzhu&quot;, Pets: []Pet{pet1, pet2, pet3}}...}

db.Session(&amp;gorm.Session{CreateBatchSize: 1000}).Create(&amp;users)
// INSERT INTO users xxx (éœ€ 5 æ¬¡)
// INSERT INTO pets xxx (éœ€ 15 æ¬¡)
</code></pre>
<h3 id="é’©å­2">é’©å­ã€2ã€‘</h3>
<h4 id="å¯¹è±¡ç”Ÿå‘½å‘¨æœŸ">å¯¹è±¡ç”Ÿå‘½å‘¨æœŸ</h4>
<p>Hook æ˜¯åœ¨åˆ›å»ºã€æŸ¥è¯¢ã€æ›´æ–°ã€åˆ é™¤ç­‰æ“ä½œä¹‹å‰ã€ä¹‹åè°ƒç”¨çš„å‡½æ•°ã€‚</p>
<p>å¦‚æœå·²ç»ä¸ºæ¨¡å‹å®šä¹‰äº†æŒ‡å®šçš„æ–¹æ³•ï¼Œå®ƒä¼šåœ¨åˆ›å»ºã€æ›´æ–°ã€æŸ¥è¯¢ã€åˆ é™¤æ—¶è‡ªåŠ¨è¢«è°ƒç”¨ã€‚å¦‚æœä»»ä½•å›è°ƒè¿”å›é”™è¯¯ï¼ŒGORM å°†åœæ­¢åç»­çš„æ“ä½œå¹¶å›æ»šäº‹åŠ¡ã€‚</p>
<p>é’©å­æ–¹æ³•çš„å‡½æ•°ç±»å‹åº”è¯¥æ˜¯ <code>func(*gorm.DB) error</code></p>
<h4 id="hook">Hook</h4>
<ul>
<li>
<p>åˆ›å»ºå¯¹è±¡</p>
<p>åˆ›å»ºæ—¶å¯ç”¨çš„ hook</p>
<pre><code class="language-text">// å¼€å§‹äº‹åŠ¡
BeforeSave
BeforeCreate
// å…³è”å‰çš„ save
// æ’å…¥è®°å½•è‡³ db
// å…³è”åçš„ save
AfterCreate
AfterSave
// æäº¤æˆ–å›æ»šäº‹åŠ¡
</code></pre>
<p>ä»£ç ç¤ºä¾‹ï¼š</p>
<pre><code class="language-go">func (u *User) BeforeCreate(tx *gorm.DB) (err error) {
u.UUID = uuid.New()

if !u.IsValid() {
  err = errors.New(&quot;can't save invalid data&quot;)
}
return
}

func (u *User) AfterCreate(tx*gorm.DB) (err error) {
  if u.ID == 1 {
    tx.Model(u).Update(&quot;role&quot;, &quot;admin&quot;)
  }
  return
}
</code></pre>
<p><strong>æ³¨æ„</strong>: åœ¨ GORM ä¸­ä¿å­˜ã€åˆ é™¤æ“ä½œä¼šé»˜è®¤è¿è¡Œåœ¨äº‹åŠ¡ä¸Šï¼Œ å› æ­¤åœ¨äº‹åŠ¡å®Œæˆä¹‹å‰è¯¥äº‹åŠ¡ä¸­æ‰€ä½œçš„æ›´æ”¹æ˜¯ä¸å¯è§çš„ï¼Œå¦‚æœé’©å­è¿”å›äº†ä»»ä½•é”™è¯¯ï¼Œåˆ™ä¿®æ”¹å°†è¢«å›æ»šã€‚</p>
</li>
<li>
<p>æ›´æ–°å¯¹è±¡</p>
<p>æ›´æ–°æ—¶å¯ç”¨çš„ hook</p>
<pre><code class="language-text">// å¼€å§‹äº‹åŠ¡
BeforeSave
BeforeUpdate
// å…³è”å‰çš„ save
// æ›´æ–° db
// å…³è”åçš„ save
AfterUpdate
AfterSave
// æäº¤æˆ–å›æ»šäº‹åŠ¡
</code></pre>
<p>ä»£ç ç¤ºä¾‹ï¼š</p>
<pre><code class="language-go">func (u *User) BeforeUpdate(tx *gorm.DB) (err error) {
  if u.readonly() {
    err = errors.New(&quot;read only user&quot;)
  }
  return
}

// åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­æ›´æ–°æ•°æ®
func (u *User) AfterUpdate(tx *gorm.DB) (err error) {
  if u.Confirmed {
    tx.Model(&amp;Address{}).Where(&quot;user_id = ?&quot;, u.ID).Update(&quot;verfied&quot;, true)
  }
  return
}
</code></pre>
</li>
<li>
<p>åˆ é™¤å¯¹è±¡</p>
<p>åˆ é™¤æ—¶å¯ç”¨çš„ hook</p>
<pre><code class="language-text">// å¼€å§‹äº‹åŠ¡
BeforeDelete
// åˆ é™¤ db ä¸­çš„æ•°æ®
AfterDelete
// æäº¤æˆ–å›æ»šäº‹åŠ¡
ä»£ç ç¤ºä¾‹ï¼š
</code></pre>
<pre><code class="language-go">// åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­æ›´æ–°æ•°æ®
func (u *User) AfterDelete(tx *gorm.DB) (err error) {
  if u.Confirmed {
    tx.Model(&amp;Address{}).Where(&quot;user_id = ?&quot;, u.ID).Update(&quot;invalid&quot;, false)
  }
  return
}
</code></pre>
</li>
<li>
<p>æŸ¥è¯¢å¯¹è±¡</p>
<pre><code class="language-text">æŸ¥è¯¢æ—¶å¯ç”¨çš„ hook

// ä» db ä¸­åŠ è½½æ•°æ®
// Preloading (eager loading)
AfterFind
</code></pre>
<pre><code class="language-go">ä»£ç ç¤ºä¾‹ï¼š

func (u *User) AfterFind(tx *gorm.DB) (err error) {
  if u.MemberShip == &quot;&quot; {
    u.MemberShip = &quot;user&quot;
  }
  return
}
</code></pre>
</li>
</ul>
<h4 id="ä¿®æ”¹å½“å‰æ“ä½œ">ä¿®æ”¹å½“å‰æ“ä½œ</h4>
<pre><code class="language-go">func (u *User) BeforeCreate(tx *gorm.DB) error {
  // é€šè¿‡ tx.Statement ä¿®æ”¹å½“å‰æ“ä½œï¼Œä¾‹å¦‚ï¼š
  tx.Statement.Select(&quot;Name&quot;, &quot;Age&quot;)
  tx.Statement.AddClause(clause.OnConflict{DoNothing: true})

  // tx æ˜¯å¸¦æœ‰ `NewDB` é€‰é¡¹çš„æ–°ä¼šè¯æ¨¡å¼ 
  // åŸºäº tx çš„æ“ä½œä¼šåœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œä½†ä¸ä¼šå¸¦ä¸Šä»»ä½•å½“å‰çš„æ¡ä»¶
  err := tx.First(&amp;role, &quot;name = ?&quot;, user.Role).Error
  // SELECT * FROM roles WHERE name = &quot;admin&quot;
  // ...
  return err
}
</code></pre>
<h3 id="äº‹åŠ¡3">äº‹åŠ¡ã€3ã€‘</h3>
<h4 id="ç¦ç”¨é»˜è®¤äº‹åŠ¡">ç¦ç”¨é»˜è®¤äº‹åŠ¡</h4>
<p>ä¸ºäº†ç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼ŒGORM ä¼šåœ¨äº‹åŠ¡é‡Œæ‰§è¡Œå†™å…¥æ“ä½œï¼ˆåˆ›å»ºã€æ›´æ–°ã€åˆ é™¤ï¼‰ã€‚å¦‚æœæ²¡æœ‰è¿™æ–¹é¢çš„è¦æ±‚ï¼Œå¯ä»¥åœ¨åˆå§‹åŒ–æ—¶ç¦ç”¨å®ƒï¼Œè¿™å°†è·å¾—å¤§çº¦ 30%+ æ€§èƒ½æå‡ã€‚</p>
<pre><code class="language-go">// å…¨å±€ç¦ç”¨
db, err := gorm.Open(sqlite.Open(&quot;gorm.db&quot;), &amp;gorm.Config{
  SkipDefaultTransaction: true,
})

// æŒç»­ä¼šè¯æ¨¡å¼
tx := db.Session(&amp;Session{SkipDefaultTransaction: true})
tx.First(&amp;user, 1)
tx.Find(&amp;users)
tx.Model(&amp;user).Update(&quot;Age&quot;, 18)
</code></pre>
<h4 id="äº‹åŠ¡ç¤ºä¾‹">äº‹åŠ¡ç¤ºä¾‹</h4>
<pre><code class="language-go">db.Transaction(func(tx *gorm.DB) error {
  // åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œä¸€äº› db æ“ä½œï¼ˆä»è¿™é‡Œå¼€å§‹ï¼Œåº”è¯¥ä½¿ç”¨ 'tx' è€Œä¸æ˜¯ 'db'ï¼‰
  if err := tx.Create(&amp;Animal{Name: &quot;Giraffe&quot;}).Error; err != nil {
    // è¿”å›ä»»ä½•é”™è¯¯éƒ½ä¼šå›æ»šäº‹åŠ¡
    return err
  }

  if err := tx.Create(&amp;Animal{Name: &quot;Lion&quot;}).Error; err != nil {
    return err
  }

  // è¿”å› nil æäº¤äº‹åŠ¡
  return nil
})
</code></pre>
<ul>
<li>åµŒå¥—äº‹åŠ¡</li>
</ul>
<p>GORM æ”¯æŒåµŒå¥—äº‹åŠ¡ï¼Œå¯ä»¥å›æ»šè¾ƒå¤§äº‹åŠ¡å†…æ‰§è¡Œçš„ä¸€éƒ¨åˆ†æ“ä½œï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-go">db.Transaction(func(tx *gorm.DB) error {
  tx.Create(&amp;user1)

  tx.Transaction(func(tx2 *gorm.DB) error {
    tx2.Create(&amp;user2)
    return errors.New(&quot;rollback user2&quot;) // Rollback user2
  })

  tx.Transaction(func(tx3 *gorm.DB) error {
    tx3.Create(&amp;user3)
    return nil
  })

  return nil
})

// Commit user1, user3
</code></pre>
<h4 id="æ‰‹åŠ¨äº‹åŠ¡">æ‰‹åŠ¨äº‹åŠ¡</h4>
<p>Gorm æ”¯æŒç›´æ¥è°ƒç”¨äº‹åŠ¡æ§åˆ¶æ–¹æ³•ï¼ˆcommitã€rollbackï¼‰ï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-go">// å¼€å§‹äº‹åŠ¡
tx := db.Begin()

// åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œä¸€äº› db æ“ä½œï¼ˆä»è¿™é‡Œå¼€å§‹ï¼Œæ‚¨åº”è¯¥ä½¿ç”¨ 'tx' è€Œä¸æ˜¯ 'db'ï¼‰
tx.Create(...)

// ...

// é‡åˆ°é”™è¯¯æ—¶å›æ»šäº‹åŠ¡
tx.Rollback()

// å¦åˆ™ï¼Œæäº¤äº‹åŠ¡
tx.Commit()
</code></pre>
<ul>
<li>ä¸€ä¸ªç‰¹æ®Šçš„ç¤ºä¾‹</li>
</ul>
<pre><code class="language-go">func CreateAnimals(db *gorm.DB) error {
  // å†å” å¨ä¸€ä¸‹ï¼Œäº‹åŠ¡ä¸€æ—¦å¼€å§‹ï¼Œä½ å°±åº”è¯¥ä½¿ç”¨ tx å¤„ç†æ•°æ®
  tx := db.Begin()
  defer func() {
    if r := recover(); r != nil {
      tx.Rollback()
    }
  }()

  if err := tx.Error; err != nil {
    return err
  }

  if err := tx.Create(&amp;Animal{Name: &quot;Giraffe&quot;}).Error; err != nil {
     tx.Rollback()
     return err
  }

  if err := tx.Create(&amp;Animal{Name: &quot;Lion&quot;}).Error; err != nil {
     tx.Rollback()
     return err
  }

  return tx.Commit().Error
}
</code></pre>
<h3 id="è¿ç§»2">è¿ç§»ã€2ã€‘</h3>
<p>AutoMigrate ä¼šåˆ›å»ºè¡¨ã€ç¼ºå¤±çš„å¤–é”®ã€çº¦æŸã€åˆ—å’Œç´¢å¼•ã€‚ å¦‚æœå¤§å°ã€ç²¾åº¦ã€æ˜¯å¦ä¸ºç©ºå¯ä»¥æ›´æ”¹ï¼Œåˆ™AutoMigrate ä¼šæ”¹å˜åˆ—çš„ç±»å‹ã€‚ å‡ºäºä¿æŠ¤æ•°æ®çš„ç›®çš„ï¼Œå®ƒ <strong>ä¸ä¼š</strong> åˆ é™¤æœªä½¿ç”¨çš„åˆ—</p>
<h4 id="automigrate">AutoMigrate</h4>
<pre><code class="language-go">db.AutoMigrate(&amp;User{})

db.AutoMigrate(&amp;User{}, &amp;Product{}, &amp;Order{})

// åˆ›å»ºè¡¨æ—¶æ·»åŠ åç¼€
db.Set(&quot;gorm:table_options&quot;, &quot;ENGINE=InnoDB&quot;).AutoMigrate(&amp;User{})
</code></pre>
<p>AutoMigrate ä¼šè‡ªåŠ¨åˆ›å»ºæ•°æ®åº“å¤–é”®çº¦æŸï¼Œå¯ä»¥åœ¨åˆå§‹åŒ–æ—¶ç¦ç”¨æ­¤åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-go">db, err := gorm.Open(sqlite.Open(&quot;gorm.db&quot;), &amp;gorm.Config{
  DisableForeignKeyConstraintWhenMigrating: true,
})
</code></pre>
<h4 id="migrator-æ¥å£">Migrator æ¥å£</h4>
<p>GORM æä¾›äº† Migrator æ¥å£ï¼Œè¯¥æ¥å£ä¸ºæ¯ä¸ªæ•°æ®åº“æä¾›äº†ç»Ÿä¸€çš„ API æ¥å£ï¼Œå¯ç”¨æ¥ä¸ºçš„æ•°æ®åº“æ„å»ºç‹¬ç«‹è¿ç§».</p>
<pre><code class="language-go">type Migrator interface {
  // AutoMigrate
  AutoMigrate(dst ...interface{}) error

  // Database
  CurrentDatabase() string
  FullDataTypeOf(*schema.Field) clause.Expr

  // Tables
  CreateTable(dst ...interface{}) error
  DropTable(dst ...interface{}) error
  HasTable(dst interface{}) bool
  RenameTable(oldName, newName interface{}) error
  GetTables() (tableList []string, err error)

  // Columns
  AddColumn(dst interface{}, field string) error
  DropColumn(dst interface{}, field string) error
  AlterColumn(dst interface{}, field string) error
  MigrateColumn(dst interface{}, field *schema.Field, columnType ColumnType) error
  HasColumn(dst interface{}, field string) bool
  RenameColumn(dst interface{}, oldName, field string) error
  ColumnTypes(dst interface{}) ([]ColumnType, error)

  // Views
  CreateView(name string, option ViewOption) error
  DropView(name string) error

  // Constraints
  CreateConstraint(dst interface{}, name string) error
  DropConstraint(dst interface{}, name string) error
  HasConstraint(dst interface{}, name string) bool

  // Indexes
  CreateIndex(dst interface{}, name string) error
  DropIndex(dst interface{}, name string) error
  HasIndex(dst interface{}, name string) bool
  RenameIndex(dst interface{}, oldName, newName string) error
}
</code></pre>
<ul>
<li>
<p><strong>å½“å‰æ•°æ®åº“</strong><br>
è¿”å›å½“å‰ä½¿ç”¨çš„æ•°æ®åº“å</p>
<pre><code class="language-go">db.Migrator().CurrentDatabase()
</code></pre>
</li>
<li>
<p>è¡¨</p>
<pre><code class="language-go">// ä¸º `User` åˆ›å»ºè¡¨
db.Migrator().CreateTable(&amp;User{})

// å°† &quot;ENGINE=InnoDB&quot; æ·»åŠ åˆ°åˆ›å»º `User` çš„ SQL é‡Œå»
db.Set(&quot;gorm:table_options&quot;, &quot;ENGINE=InnoDB&quot;).Migrator().CreateTable(&amp;User{})

// æ£€æŸ¥ `User` å¯¹åº”çš„è¡¨æ˜¯å¦å­˜åœ¨
db.Migrator().HasTable(&amp;User{})
db.Migrator().HasTable(&quot;users&quot;)

// å¦‚æœå­˜åœ¨è¡¨åˆ™åˆ é™¤ï¼ˆåˆ é™¤æ—¶ä¼šå¿½ç•¥ã€åˆ é™¤å¤–é”®çº¦æŸ)
db.Migrator().DropTable(&amp;User{})
db.Migrator().DropTable(&quot;users&quot;)

// é‡å‘½åè¡¨
db.Migrator().RenameTable(&amp;User{}, &amp;UserInfo{})
db.Migrator().RenameTable(&quot;users&quot;, &quot;user_infos&quot;)
</code></pre>
</li>
<li>
<p>åˆ—</p>
<pre><code class="language-go">type User struct {
 Name string   
}

// æ·»åŠ  name å­—æ®µ
db.Migrator().AddColumn(&amp;User{}, &quot;Name&quot;)
// åˆ é™¤ name å­—æ®µ
db.Migrator().DropColumn(&amp;User{}, &quot;Name&quot;)
// ä¿®æ”¹ name å­—æ®µ
db.Migrator().AlterColumn(&amp;User{}, &quot;Name&quot;)
// æ£€æŸ¥ name å­—æ®µæ˜¯å¦å­˜åœ¨
db.Migrator().HasColumn(&amp;User{}, &quot;Name&quot;)

type User struct {
  Name    string 
  NewName string
}

// å­—æ®µé‡å‘½å
db.Migrator().RenameColumn(&amp;User{}, &quot;Name&quot;, &quot;NewName&quot;)
db.Migrator().RenameColumn(&amp;User{}, &quot;name&quot;, &quot;new_name&quot;)

// å­—æ®µç±»å‹
db.Migrator().ColumnTypes(&amp;User{}) ([]gorm.ColumnType, error)

type ColumnType interface {
    Name() string
    DatabaseTypeName() string                 // varchar
    ColumnType() (columnType string, ok bool) // varchar(64)
    PrimaryKey() (isPrimaryKey bool, ok bool)
    AutoIncrement() (isAutoIncrement bool, ok bool)
    Length() (length int64, ok bool)
    DecimalSize() (precision int64, scale int64, ok bool)
    Nullable() (nullable bool, ok bool)
    Unique() (unique bool, ok bool)
    ScanType() reflect.Type
    Comment() (value string, ok bool)
    DefaultValue() (value string, ok bool)
}
</code></pre>
</li>
<li>
<p>Views</p>
<p>é€šè¿‡<code>ViewOption</code>åˆ›å»ºè§†å›¾ã€‚å…³äºViewOption:</p>
<ul>
<li><code>Query</code>æ˜¯ä¸€ä¸ªå­æŸ¥è¯¢ï¼Œè¿™æ˜¯å¿…éœ€çš„ã€‚</li>
<li>å¦‚æœ<code>Replace</code>ä¸ºtrueï¼Œæ‰§è¡ŒCREATEæˆ–Replaceï¼Œå¦åˆ™æ‰§è¡ŒCREATEã€‚</li>
<li>å¦‚æœ<code>CheckOption</code>ä¸ä¸ºç©ºï¼Œåˆ™è¿½åŠ åˆ°sqlï¼Œä¾‹å¦‚<code>WITH LOCAL CHECK OPTION</code>ã€‚</li>
</ul>
</li>
</ul>
<pre><code class="language-go">query := db.Model(&amp;User{}).Where(&quot;age &gt; ?&quot;, 20)

// Create View
db.Migrator().CreateView(&quot;users_pets&quot;, gorm.ViewOption{Query: query})
// CREATE VIEW `users_view` AS SELECT * FROM `users` WHERE age &gt; 20

// Create or Replace View
db.Migrator().CreateView(&quot;users_pets&quot;, gorm.ViewOption{Query: query, Replace: true})
// CREATE OR REPLACE VIEW `users_pets` AS SELECT * FROM `users` WHERE age &gt; 20

// Create View With Check Option
db.Migrator().CreateView(&quot;users_pets&quot;, gorm.ViewOption{Query: query, CheckOption: &quot;WITH CHECK OPTION&quot;})
// CREATE VIEW `users_pets` AS SELECT * FROM `users` WHERE age &gt; 20 WITH CHECK OPTION

// Drop View
db.Migrator().DropView(&quot;users_pets&quot;)
// DROP VIEW IF EXISTS &quot;users_pets&quot;
</code></pre>
<ul>
<li>Constraints</li>
</ul>
<pre><code class="language-go">type UserIndex struct {
  Name  string `gorm:&quot;check:name_checker,name &lt;&gt; 'jinzhu'&quot;`
}

// Create constraint
db.Migrator().CreateConstraint(&amp;User{}, &quot;name_checker&quot;)

// Drop constraint
db.Migrator().DropConstraint(&amp;User{}, &quot;name_checker&quot;)

// Check constraint exists
db.Migrator().HasConstraint(&amp;User{}, &quot;name_checker&quot;)
</code></pre>
<p>ä¸ºå…³ç³»åˆ›å»ºå¤–é”®ï¼š</p>
<pre><code class="language-go">type User struct {
  gorm.Model
  CreditCards []CreditCard
}

type CreditCard struct {
  gorm.Model
  Number string
  UserID uint
}

// create database foreign key for user &amp; credit_cards
db.Migrator().CreateConstraint(&amp;User{}, &quot;CreditCards&quot;)
db.Migrator().CreateConstraint(&amp;User{}, &quot;fk_users_credit_cards&quot;)
// ALTER TABLE `credit_cards` ADD CONSTRAINT `fk_users_credit_cards` FOREIGN KEY (`user_id`) REFERENCES `users`(`id`)

// check database foreign key for user &amp; credit_cards exists or not
db.Migrator().HasConstraint(&amp;User{}, &quot;CreditCards&quot;)
db.Migrator().HasConstraint(&amp;User{}, &quot;fk_users_credit_cards&quot;)

// drop database foreign key for user &amp; credit_cards
db.Migrator().DropConstraint(&amp;User{}, &quot;CreditCards&quot;)
db.Migrator().DropConstraint(&amp;User{}, &quot;fk_users_credit_cards&quot;)
</code></pre>
<ul>
<li>Indexes</li>
</ul>
<pre><code class="language-go">type User struct {
  gorm.Model
  Name string `gorm:&quot;size:255;index:idx_name,unique&quot;`
}

// Create index for Name field
db.Migrator().CreateIndex(&amp;User{}, &quot;Name&quot;)
db.Migrator().CreateIndex(&amp;User{}, &quot;idx_name&quot;)

// Drop index for Name field
db.Migrator().DropIndex(&amp;User{}, &quot;Name&quot;)
db.Migrator().DropIndex(&amp;User{}, &quot;idx_name&quot;)

// Check Index exists
db.Migrator().HasIndex(&amp;User{}, &quot;Name&quot;)
db.Migrator().HasIndex(&amp;User{}, &quot;idx_name&quot;)

type User struct {
  gorm.Model
  Name  string `gorm:&quot;size:255;index:idx_name,unique&quot;`
  Name2 string `gorm:&quot;size:255;index:idx_name_2,unique&quot;`
}
// Rename index name
db.Migrator().RenameIndex(&amp;User{}, &quot;Name&quot;, &quot;Name2&quot;)
db.Migrator().RenameIndex(&amp;User{}, &quot;idx_name&quot;, &quot;idx_name_2&quot;)
</code></pre>
<h4 id="çº¦æŸ">çº¦æŸ</h4>
<p>GORMåœ¨è‡ªåŠ¨è¿ç§»æˆ–åˆ›å»ºè¡¨æ—¶åˆ›å»ºçº¦æŸï¼Œè¯¦ç»†ä¿¡æ¯è¯·å‚è§<a href="#%E7%BA%A6%E6%9D%9F1">çº¦æŸ</a>æˆ–<a href="#%E7%B4%A2%E5%BC%951">æ•°æ®åº“ç´¢å¼•</a>ã€‚</p>
<h4 id="atlas-integration">Atlas Integration</h4>
<p><a href="https://atlasgo.io/">Atlas</a>æ˜¯ä¸€ä¸ªä¸GORMæ­£å¼é›†æˆçš„å¼€æºæ•°æ®åº“è¿ç§»å·¥å…·ã€‚<br>
è™½ç„¶GORMçš„<code>AutoMigrate</code>ç‰¹æ€§åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹éƒ½å¯ä»¥å·¥ä½œï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ‚¨å¯èƒ½éœ€è¦åˆ‡æ¢åˆ°ç‰ˆæœ¬åŒ–çš„è¿ç§»ç­–ç•¥ã€‚<br>
ä¸€æ—¦å‘ç”Ÿè¿™ç§æƒ…å†µï¼Œè§„åˆ’è¿ç§»è„šæœ¬å¹¶ç¡®ä¿å®ƒä»¬åœ¨è¿è¡Œæ—¶ç¬¦åˆGORMæœŸæœ›çš„è´£ä»»å°±è½¬ç§»ç»™äº†å¼€å‘äººå‘˜ã€‚<br>
Atlaså¯ä»¥ä½¿ç”¨å®˜æ–¹çš„GORM Providerä¸ºå¼€å‘äººå‘˜è‡ªåŠ¨è§„åˆ’æ•°æ®åº“æ¨¡å¼è¿ç§»ã€‚é…ç½®æä¾›ç¨‹åºåï¼Œæ‚¨å¯ä»¥é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤è‡ªåŠ¨è§„åˆ’è¿ç§»:</p>
<p><code>atlas migrate diff --env gorm</code></p>
<p>è¦äº†è§£å¦‚ä½•å°†Atlasä¸GORMä¸€èµ·ä½¿ç”¨ï¼Œè¯·æŸ¥çœ‹<a href="https://atlasgo.io/guides/orms/gorm">å®˜æ–¹æ–‡æ¡£</a>ã€‚</p>
<h4 id="other-migration-tools">Other Migration Tools</h4>
<p>è¦å°†GORMä¸å…¶ä»–åŸºäºgoçš„è¿ç§»å·¥å…·ä¸€èµ·ä½¿ç”¨ï¼ŒGORMæä¾›äº†ä¸€ä¸ªå¯èƒ½å¯¹æ‚¨æœ‰æ‰€å¸®åŠ©çš„é€šç”¨DBæ¥å£ã€‚</p>
<pre><code class="language-go">// returns `*sql.DB`
db.DB()
</code></pre>
<h3 id="logger1">Loggerã€1ã€‘</h3>
<h4 id="æ—¥å¿—">æ—¥å¿—</h4>
<p>Gorm æœ‰ä¸€ä¸ª é»˜è®¤ logger å®ç°ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒä¼šæ‰“å°æ…¢ SQL å’Œé”™è¯¯</p>
<p>Logger æ¥å—çš„é€‰é¡¹ä¸å¤šï¼Œæ‚¨å¯ä»¥åœ¨åˆå§‹åŒ–æ—¶è‡ªå®šä¹‰å®ƒï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-go">newLogger := logger.New(
  log.New(os.Stdout, &quot;\r\n&quot;, log.LstdFlags), // io writer
  logger.Config{
    SlowThreshold:              time.Second,   // Slow SQL threshold
    LogLevel:                   logger.Silent, // Log level
    IgnoreRecordNotFoundError: true,           // Ignore ErrRecordNotFound error for logger
    ParameterizedQueries:      true,           // Don't include params in the SQL log
    Colorful:                  false,          // Disable color
  },
)

// Globally mode
db, err := gorm.Open(sqlite.Open(&quot;test.db&quot;), &amp;gorm.Config{
  Logger: newLogger,
})

// Continuous session mode
tx := db.Session(&amp;Session{Logger: newLogger})
tx.First(&amp;user)
tx.Model(&amp;user).Update(&quot;Age&quot;, 18)
</code></pre>
<p><strong>æ—¥å¿—çº§åˆ«</strong><br>
GORM å®šä¹‰äº†è¿™äº›æ—¥å¿—çº§åˆ«ï¼š<code>Silent</code>ã€<code>Error</code>ã€<code>Warn</code>ã€<code>Info</code></p>
<pre><code class="language-go">db, err := gorm.Open(sqlite.Open(&quot;test.db&quot;), &amp;gorm.Config{
  Logger: logger.Default.LogMode(logger.Silent),
})
</code></pre>
<p><strong>Debug</strong><br>
Debug å•ä¸ªæ“ä½œï¼Œå°†å½“å‰æ“ä½œçš„ log çº§åˆ«è°ƒæ•´ä¸º logger.Info<br>
<code>db.Debug().Where(&quot;name = ?&quot;, &quot;jinzhu&quot;).First(&amp;User{})</code></p>
<h4 id="è‡ªå®šä¹‰logger">è‡ªå®šä¹‰Logger</h4>
<p>å‚è€ƒ GORM çš„ é»˜è®¤ logger æ¥å®šä¹‰æ‚¨è‡ªå·±çš„ logger</p>
<p>Logger éœ€è¦å®ç°ä»¥ä¸‹æ¥å£ï¼Œå®ƒæ¥å— contextï¼Œæ‰€ä»¥ä½ å¯ä»¥ç”¨å®ƒæ¥è¿½è¸ªæ—¥å¿—</p>
<pre><code class="language-GO">type Interface interface {
    LogMode(LogLevel) Interface
    Info(context.Context, string, ...interface{})
    Warn(context.Context, string, ...interface{})
    Error(context.Context, string, ...interface{})
    Trace(ctx context.Context, begin time.Time, fc func() (sql string, rowsAffected int64), err error)
}
</code></pre>
<h3 id="æ€§èƒ½2">æ€§èƒ½ã€2ã€‘</h3>
<h4 id="æ€§èƒ½-ç¦ç”¨é»˜è®¤äº‹åŠ¡">æ€§èƒ½-ç¦ç”¨é»˜è®¤äº‹åŠ¡</h4>
<p>å¯¹äºå†™æ“ä½œï¼ˆåˆ›å»ºã€æ›´æ–°ã€åˆ é™¤ï¼‰ï¼Œä¸ºäº†ç¡®ä¿æ•°æ®çš„å®Œæ•´æ€§ï¼ŒGORM ä¼šå°†å®ƒä»¬å°è£…åœ¨ä¸€ä¸ªäº‹åŠ¡é‡Œã€‚ä½†è¿™ä¼šé™ä½æ€§èƒ½ï¼Œå¯ä»¥åœ¨åˆå§‹åŒ–æ—¶ç¦ç”¨è¿™ç§æ–¹å¼</p>
<pre><code class="language-go">db, err := gorm.Open(sqlite.Open(&quot;gorm.db&quot;), &amp;gorm.Config{
  SkipDefaultTransaction: true,
})
</code></pre>
<h4 id="ç¼“å­˜é¢„ç¼–è¯‘è¯­å¥">ç¼“å­˜é¢„ç¼–è¯‘è¯­å¥</h4>
<p>æ‰§è¡Œä»»ä½• SQL æ—¶éƒ½åˆ›å»ºå¹¶ç¼“å­˜é¢„ç¼–è¯‘è¯­å¥ï¼Œå¯ä»¥æé«˜åç»­çš„è°ƒç”¨é€Ÿåº¦</p>
<pre><code class="language-go">// å…¨å±€æ¨¡å¼
db, err := gorm.Open(sqlite.Open(&quot;gorm.db&quot;), &amp;gorm.Config{
  PrepareStmt: true,
})

// ä¼šè¯æ¨¡å¼
tx := db.Session(&amp;Session{PrepareStmt: true})
tx.First(&amp;user, 1)
tx.Find(&amp;users)
tx.Model(&amp;user).Update(&quot;Age&quot;, 18)
</code></pre>
<p><strong>æ³¨æ„</strong> ä¹Ÿå¯ä»¥å‚è€ƒå¦‚ä½•ä¸º MySQL å¼€å¯ interpolateparams ä»¥å‡å°‘ roundtrip <a href="https://github.com/go-sql-driver/mysql#interpolateparams">https://github.com/go-sql-driver/mysql#interpolateparams</a></p>
<p><strong>å¸¦ PreparedStmt çš„ SQL ç”Ÿæˆå™¨</strong>:</p>
<p>Prepared Statement ä¹Ÿå¯ä»¥å’ŒåŸç”Ÿ SQL ä¸€èµ·ä½¿ç”¨ï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-go">db, err := gorm.Open(sqlite.Open(&quot;gorm.db&quot;), &amp;gorm.Config{
  PrepareStmt: true,
})

db.Raw(&quot;select sum(age) from users where role = ?&quot;, &quot;admin&quot;).Scan(&amp;age)
</code></pre>
<p>ä¹Ÿå¯ä»¥ä½¿ç”¨ GORM çš„ API <a href="#dryrun">DryRun</a> æ¨¡å¼ ç¼–å†™ SQL å¹¶æ‰§è¡Œ prepared statement ï¼ŒæŸ¥çœ‹ <a href="#session2">ä¼šè¯æ¨¡å¼</a> è·å–è¯¦æƒ…</p>
<h4 id="é€‰æ‹©å­—æ®µ">é€‰æ‹©å­—æ®µ</h4>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒGORM åœ¨æŸ¥è¯¢æ—¶ä¼šé€‰æ‹©æ‰€æœ‰çš„å­—æ®µï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ Select æ¥æŒ‡å®šæ‚¨æƒ³è¦çš„å­—æ®µ<br>
<code>db.Select(&quot;Name&quot;, &quot;Age&quot;).Find(&amp;Users{})</code></p>
<p>æˆ–è€…å®šä¹‰ä¸€ä¸ªè¾ƒå°çš„ API ç»“æ„ä½“ï¼Œä½¿ç”¨ <a href="#%E6%99%BA%E8%83%BD%E9%80%89%E6%8B%A9%E5%AD%97%E6%AE%B5">æ™ºèƒ½é€‰æ‹©å­—æ®µ</a>åŠŸèƒ½</p>
<pre><code class="language-go">type User struct {
  ID     uint
  Name   string
  Age    int
  Gender string
  // å‡è®¾åé¢è¿˜æœ‰å‡ ç™¾ä¸ªå­—æ®µ...
}

type APIUser struct {
  ID   uint
  Name string
}

// æŸ¥è¯¢æ—¶ä¼šè‡ªåŠ¨é€‰æ‹© `id`ã€`name` å­—æ®µ
db.Model(&amp;User{}).Limit(10).Find(&amp;APIUser{})
// SELECT `id`, `name` FROM `users` LIMIT 10
</code></pre>
<h4 id="è¿­ä»£-findinbatches">è¿­ä»£ã€FindInBatches</h4>
<p>ç”¨è¿­ä»£æˆ– in batches æŸ¥è¯¢å¹¶å¤„ç†è®°å½•</p>
<h4 id="index-hints">Index Hints</h4>
<p><a href="#%E7%B4%A2%E5%BC%951">Index</a> ç”¨äºæé«˜æ•°æ®æ£€ç´¢å’Œ SQL æŸ¥è¯¢æ€§èƒ½ã€‚ Index Hints å‘ä¼˜åŒ–å™¨æä¾›äº†åœ¨æŸ¥è¯¢å¤„ç†è¿‡ç¨‹ä¸­å¦‚ä½•é€‰æ‹©ç´¢å¼•çš„ä¿¡æ¯ã€‚ä¸ optimizer ç›¸æ¯”ï¼Œå®ƒå¯ä»¥æ›´çµæ´»åœ°é€‰æ‹©æ›´æœ‰æ•ˆçš„æ‰§è¡Œè®¡åˆ’</p>
<pre><code class="language-go">import &quot;gorm.io/hints&quot;

db.Clauses(hints.UseIndex(&quot;idx_user_name&quot;)).Find(&amp;User{})
// SELECT * FROM `users` USE INDEX (`idx_user_name`)

db.Clauses(hints.ForceIndex(&quot;idx_user_name&quot;, &quot;idx_user_id&quot;).ForJoin()).Find(&amp;User{})
// SELECT * FROM `users` FORCE INDEX FOR JOIN (`idx_user_name`,`idx_user_id`)&quot;

db.Clauses(
    hints.ForceIndex(&quot;idx_user_name&quot;, &quot;idx_user_id&quot;).ForOrderBy(),
    hints.IgnoreIndex(&quot;idx_user_name&quot;).ForGroupBy(),
).Find(&amp;User{})
// SELECT * FROM `users` FORCE INDEX FOR ORDER BY (`idx_user_name`,`idx_user_id`) IGNORE INDEX FOR GROUP BY (`idx_user_name`)&quot;
</code></pre>
<h4 id="è¯»å†™åˆ†ç¦»">è¯»å†™åˆ†ç¦»</h4>
<p>é€šè¿‡è¯»å†™åˆ†ç¦»æé«˜æ•°æ®ååé‡ï¼ŒæŸ¥çœ‹ <a href="#database-resolver">Database Resolver</a> è·å–è¯¦æƒ…</p>
<h3 id="è‡ªå®šä¹‰æ•°æ®ç±»å‹4">è‡ªå®šä¹‰æ•°æ®ç±»å‹ã€4ã€‘</h3>
<h4 id="å®ç°è‡ªå®šä¹‰æ•°æ®ç±»å‹">å®ç°è‡ªå®šä¹‰æ•°æ®ç±»å‹</h4>
<p><strong>Scanner / Valuer</strong><br>
è‡ªå®šä¹‰çš„æ•°æ®ç±»å‹å¿…é¡»å®ç° Scanner å’Œ Valuer æ¥å£ï¼Œä»¥ä¾¿è®© GORM çŸ¥é“å¦‚ä½•å°†è¯¥ç±»å‹æ¥æ”¶ã€ä¿å­˜åˆ°æ•°æ®åº“</p>
<pre><code class="language-go">type JSON json.RawMessage

// å®ç° sql.Scanner æ¥å£ï¼ŒScan å°† value æ‰«æè‡³ Jsonb ååºåˆ—åŒ–
func (j *JSON) Scan(value interface{}) error {
  bytes, ok := value.([]byte)
  if !ok {
    return errors.New(fmt.Sprint(&quot;Failed to unmarshal JSONB value:&quot;, value))
  }

  result := json.RawMessage{}
  err := json.Unmarshal(bytes, &amp;result)
  *j = JSON(result)
  return err
}

// å®ç° driver.Valuer æ¥å£ï¼ŒValue è¿”å› json value åºåˆ—åŒ–
func (j JSON) Value() (driver.Value, error) {
  if len(j) == 0 {
    return nil, nil
  }
  return json.RawMessage(j).MarshalJSON()
}
</code></pre>
<p><strong>GormDataTypeInterface</strong><br>
GORM ä¼šä» type æ ‡ç­¾ ä¸­è¯»å–å­—æ®µçš„æ•°æ®åº“ç±»å‹ï¼Œå¦‚æœæ‰¾ä¸åˆ°ï¼Œåˆ™ä¼šæ£€æŸ¥è¯¥ç»“æ„ä½“æ˜¯å¦å®ç°äº† <code>GormDBDataTypeInterface</code> æˆ– <code>GormDataTypeInterface</code> æ¥å£ï¼Œç„¶åä½¿ç”¨æ¥å£è¿”å›å€¼ä½œä¸ºæ•°æ®ç±»å‹</p>
<pre><code class="language-go">type GormDataTypeInterface interface {
  GormDataType() string
}

type GormDBDataTypeInterface interface {
  GormDBDataType(*gorm.DB, *schema.Field) string
}
</code></pre>
<p>GormDataType çš„ç»“æœç”¨äºç”Ÿæˆé€šç”¨æ•°æ®ç±»å‹ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ schema.Field çš„ DataType å­—æ®µå¾—åˆ°ã€‚è¿™åœ¨ ç¼–å†™æ’ä»¶ æˆ–è€… hook æ—¶å¯èƒ½ä¼šæœ‰ç”¨.<br>
åœ¨è¿ç§»æ—¶ï¼ŒGormDBDataType é€šå¸¸ä¼šä¸ºå½“å‰é©±åŠ¨è¿”å›æ°å½“çš„æ•°æ®ç±»å‹<br>
å¦‚æœ struct æ²¡æœ‰å®ç° GormDBDataTypeInterface æˆ– GormDataTypeInterface æ¥å£ï¼ŒGORM ä¼šæ ¹æ® struct ç¬¬ä¸€ä¸ªå­—æ®µæ¨æµ‹å…¶æ•°æ®ç±»å‹</p>
<p>GormValuerInterface<br>
æ¡ä»¶è¡¨è¾¾å¼</p>
<p>çœ‹ä¸æ‡‚ï¼Œæ•´çš„æˆ‘æœ‰ç‚¹æƒ³åï¼Œç”Ÿç†æ€§éš¾å—ã€‚</p>
<h4 id="è‡ªå®šä¹‰æ•°æ®ç±»å‹é›†åˆ">è‡ªå®šä¹‰æ•°æ®ç±»å‹é›†åˆ</h4>
<p>æŒ‚äº†ä¸ªç½‘ç«™çœ‹ç¤ºä¾‹ï¼Œç•¥</p>
<h3 id="scope3">Scopeã€3ã€‘</h3>
<p>ä½œç”¨åŸŸå…è®¸ä½ å¤ç”¨é€šç”¨çš„é€»è¾‘ï¼Œè¿™ç§å…±äº«é€»è¾‘éœ€è¦å®šä¹‰ä¸ºç±»å‹<code>func(*gorm.DB) *gorm.DB</code>ã€‚</p>
<p>æ„Ÿè§‰æ‹¿åˆ«çš„å‡½æ•°å­æŸ¥è¯¢ä»€ä¹ˆçš„ä¹Ÿèƒ½åšåˆ°ç›¸åŒæ•ˆæœã€‚</p>
<h4 id="scopeæŸ¥è¯¢">ScopeæŸ¥è¯¢</h4>
<pre><code class="language-go">func AmountGreaterThan1000(db *gorm.DB) *gorm.DB {
  return db.Where(&quot;amount &gt; ?&quot;, 1000)
}

func PaidWithCreditCard(db *gorm.DB) *gorm.DB {
  return db.Where(&quot;pay_mode_sign = ?&quot;, &quot;C&quot;)
}

func PaidWithCod(db *gorm.DB) *gorm.DB {
  return db.Where(&quot;pay_mode_sign = ?&quot;, &quot;C&quot;)
}

func OrderStatus(status []string) func (db *gorm.DB) *gorm.DB {
  return func (db *gorm.DB) *gorm.DB {
    return db.Where(&quot;status IN (?)&quot;, status)
  }
}

db.Scopes(AmountGreaterThan1000, PaidWithCreditCard).Find(&amp;orders)
// æŸ¥æ‰¾æ‰€æœ‰é‡‘é¢å¤§äº 1000 çš„ä¿¡ç”¨å¡è®¢å•

db.Scopes(AmountGreaterThan1000, PaidWithCod).Find(&amp;orders)
// æŸ¥æ‰¾æ‰€æœ‰é‡‘é¢å¤§äº 1000 çš„ COD è®¢å•

db.Scopes(AmountGreaterThan1000, OrderStatus([]string{&quot;paid&quot;, &quot;shipped&quot;})).Find(&amp;orders)
// æŸ¥æ‰¾æ‰€æœ‰é‡‘é¢å¤§äº1000 çš„å·²ä»˜æ¬¾æˆ–å·²å‘è´§è®¢å•
</code></pre>
<p><strong>åˆ†é¡µ</strong>ï¼š</p>
<pre><code class="language-go">func Paginate(r *http.Request) func(db *gorm.DB) *gorm.DB {
  return func (db *gorm.DB) *gorm.DB {
    q := r.URL.Query()
    page, _ := strconv.Atoi(q.Get(&quot;page&quot;))
    if page &lt;= 0 {
      page = 1
    }

    pageSize, _ := strconv.Atoi(q.Get(&quot;page_size&quot;))
    switch {
    case pageSize &gt; 100:
      pageSize = 100
    case pageSize &lt;= 0:
      pageSize = 10
    }

    offset := (page - 1) * pageSize
    return db.Offset(offset).Limit(pageSize)
  }
}

db.Scopes(Paginate(r)).Find(&amp;users)
db.Scopes(Paginate(r)).Find(&amp;articles)
</code></pre>
<h4 id="scopeåŠ¨æ€è¡¨">scopeåŠ¨æ€è¡¨</h4>
<p>ä½¿ç”¨ <code>Scopes</code> æ¥åŠ¨æ€æŒ‡å®šæŸ¥è¯¢çš„è¡¨</p>
<pre><code class="language-go">func TableOfYear(user *User, year int) func(db *gorm.DB) *gorm.DB {
  return func(db *gorm.DB) *gorm.DB {
        tableName := user.TableName() + strconv.Itoa(year)
        return db.Table(tableName)
  }
}

DB.Scopes(TableOfYear(user, 2019)).Find(&amp;users)
// SELECT * FROM users_2019;

DB.Scopes(TableOfYear(user, 2020)).Find(&amp;users)
// SELECT * FROM users_2020;

// Table form different database
func TableOfOrg(user *User, dbName string) func(db *gorm.DB) *gorm.DB {
  return func(db *gorm.DB) *gorm.DB {
        tableName := dbName + &quot;.&quot; + user.TableName()
        return db.Table(tableName)
  }
}

DB.Scopes(TableOfOrg(user, &quot;org1&quot;)).Find(&amp;users)
// SELECT * FROM org1.users;

DB.Scopes(TableOfOrg(user, &quot;org2&quot;)).Find(&amp;users)
// SELECT * FROM org2.users;
</code></pre>
<h4 id="scopeæ›´æ–°">scopeæ›´æ–°</h4>
<pre><code class="language-go">func CurOrganization(r *http.Request) func(db *gorm.DB) *gorm.DB {
  return func (db *gorm.DB) *gorm.DB {
    org := r.Query(&quot;org&quot;)

    if org != &quot;&quot; {
      var organization Organization
      if db.Session(&amp;Session{}).First(&amp;organization, &quot;name = ?&quot;, org).Error == nil {
        return db.Where(&quot;org_id = ?&quot;, organization.ID)
      }
    }

    db.AddError(&quot;invalid organization&quot;)
    return db
  }
}

db.Model(&amp;article).Scopes(CurOrganization(r)).Update(&quot;Name&quot;, &quot;name 1&quot;)
// UPDATE articles SET name = &quot;name 1&quot; WHERE org_id = 111
db.Scopes(CurOrganization(r)).Delete(&amp;Article{})
// DELETE FROM articles WHERE org_id = 111
</code></pre>
<h3 id="çº¦å®š">çº¦å®š</h3>
<h4 id="ä½¿ç”¨-id-ä½œä¸ºä¸»é”®">ä½¿ç”¨ ID ä½œä¸ºä¸»é”®</h4>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒGORM ä¼šä½¿ç”¨ <code>ID</code> ä½œä¸ºè¡¨çš„ä¸»é”®ã€‚ä½ ä¹Ÿå¯ä»¥é€šè¿‡æ ‡ç­¾ <code>primaryKey</code> å°†å…¶å®ƒå­—æ®µè®¾ä¸ºä¸»é”®ã€‚<a href="#%E5%A4%8D%E5%90%88%E4%B8%BB%E9%94%AE1">å¤åˆä¸»é”®</a></p>
<h4 id="å¤æ•°è¡¨å">å¤æ•°è¡¨å</h4>
<p>GORM ä½¿ç”¨ç»“æ„ä½“åçš„ <code>è›‡å½¢å‘½å</code> ä½œä¸ºè¡¨åã€‚å¯¹äºç»“æ„ä½“ Userï¼Œæ ¹æ®çº¦å®šï¼Œå…¶è¡¨åä¸º users</p>
<p><strong>TableName</strong><br>
å¯ä»¥å®ç° <code>Tabler</code> æ¥å£æ¥æ›´æ”¹é»˜è®¤è¡¨åï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-go">type Tabler interface {
    TableName() string
}

// TableName ä¼šå°† User çš„è¡¨åé‡å†™ä¸º `profiles`
func (User) TableName() string {
  return &quot;profiles&quot;
}
</code></pre>
<p><strong>æ³¨æ„</strong>ï¼š TableName ä¸æ”¯æŒåŠ¨æ€å˜åŒ–ï¼Œå®ƒä¼šè¢«ç¼“å­˜ä¸‹æ¥ä»¥ä¾¿åç»­ä½¿ç”¨ã€‚æƒ³è¦ä½¿ç”¨åŠ¨æ€è¡¨åï¼Œå¯ä»¥ä½¿ç”¨ <code>Scopes</code>ï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-go">func UserTable(user User) func (tx *gorm.DB)*gorm.DB {
  return func (tx *gorm.DB)*gorm.DB {
    if user.Admin {
      return tx.Table(&quot;admin_users&quot;)
    }

    return tx.Table(&quot;users&quot;)
  }
}

db.Scopes(UserTable(user)).Create(&amp;user)
</code></pre>
<p><strong>ä¸´æ—¶æŒ‡å®šè¡¨å</strong><br>
æ‚¨å¯ä»¥ä½¿ç”¨ Table æ–¹æ³•ä¸´æ—¶æŒ‡å®šè¡¨åï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-go">// æ ¹æ® User çš„å­—æ®µåˆ›å»º `deleted_users` è¡¨
db.Table(&quot;deleted_users&quot;).AutoMigrate(&amp;User{})

// ä»å¦ä¸€å¼ è¡¨æŸ¥è¯¢æ•°æ®
var deletedUsers []User
db.Table(&quot;deleted_users&quot;).Find(&amp;deletedUsers)
// SELECT * FROM deleted_users;

db.Table(&quot;deleted_users&quot;).Where(&quot;name = ?&quot;, &quot;jinzhu&quot;).Delete(&amp;User{})
// DELETE FROM deleted_users WHERE name = 'jinzhu';
</code></pre>
<p>æŸ¥çœ‹ <a href="#%E5%AD%90%E6%9F%A5%E8%AF%A2">from å­æŸ¥è¯¢</a> äº†è§£å¦‚ä½•åœ¨ FROM å­å¥ä¸­ä½¿ç”¨å­æŸ¥è¯¢</p>
<p><strong>å‘½åç­–ç•¥</strong><br>
GORMå…è®¸ç”¨æˆ·é€šè¿‡è¦†ç›–é»˜è®¤çš„<code>NamingStrategy</code>æ¥æ›´æ”¹é»˜è®¤çš„å‘½åçº¦å®šï¼Œè¯¥ç­–ç•¥ç”¨äºæ„å»º<code>TableName</code>, <code>ColumnName</code>, <code>JoinTableName</code>, <code>RelationshipFKName</code>, <code>CheckerName</code>, <code>IndexName</code>ï¼ŒæŸ¥çœ‹<a href="#gorm%E9%85%8D%E7%BD%AE2">GORM Config</a>äº†è§£è¯¦ç»†ä¿¡æ¯</p>
<h4 id="åˆ—å">åˆ—å</h4>
<p>æ ¹æ®çº¦å®šï¼Œæ•°æ®è¡¨çš„åˆ—åä½¿ç”¨çš„æ˜¯ <code>struct</code> å­—æ®µåçš„ <code>è›‡å½¢å‘½å</code><br>
æ‚¨å¯ä»¥ä½¿ç”¨ <code>column</code> æ ‡ç­¾æˆ– <code>å‘½åç­–ç•¥</code> æ¥è¦†ç›–åˆ—å</p>
<h4 id="æ—¶é—´æˆ³è¿½è¸ª">æ—¶é—´æˆ³è¿½è¸ª</h4>
<p>å¯¹äºæœ‰ <code>CreatedAt</code> å­—æ®µçš„æ¨¡å‹ï¼Œåˆ›å»ºè®°å½•æ—¶ï¼Œå¦‚æœè¯¥å­—æ®µå€¼ä¸ºé›¶å€¼ï¼Œåˆ™å°†è¯¥å­—æ®µçš„å€¼è®¾ä¸ºå½“å‰æ—¶é—´<br>
å¯¹äºæœ‰ <code>UpdatedAt</code> å­—æ®µçš„æ¨¡å‹ï¼Œæ›´æ–°è®°å½•æ—¶ï¼Œå°†è¯¥å­—æ®µçš„å€¼è®¾ä¸ºå½“å‰æ—¶é—´ã€‚åˆ›å»ºè®°å½•æ—¶ï¼Œå¦‚æœè¯¥å­—æ®µå€¼ä¸ºé›¶å€¼ï¼Œåˆ™å°†è¯¥å­—æ®µçš„å€¼è®¾ä¸ºå½“å‰æ—¶é—´<br>
ä½ å¯ä»¥é€šè¿‡å°† <code>autoUpdateTime</code> æ ‡ç­¾ç½®ä¸º <code>false</code> æ¥ç¦ç”¨æ—¶é—´æˆ³</p>
<pre><code class="language-go">type User struct {
  CreatedAt time.Time `gorm:&quot;autoCreateTime:false&quot;`
  UpdatedAt time.Time `gorm:&quot;autoUpdateTime:false&quot;`
}
</code></pre>
<h3 id="è®¾ç½®">è®¾ç½®</h3>
<h2 id="é«˜çº§ä¸»é¢˜">é«˜çº§ä¸»é¢˜</h2>
<h3 id="database-resolver">Database Resolver</h3>
<h3 id="sharding">Sharding</h3>
<h3 id="serializer4">Serializerã€4ã€‘</h3>
<p>åºåˆ—åŒ–å™¨æ˜¯ä¸€ä¸ªå¯æ‰©å±•çš„æ¥å£ï¼Œå…è®¸è‡ªå®šä¹‰å¦‚ä½•ä½¿ç”¨æ•°æ®åº“åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ•°æ®ã€‚</p>
<p>GORM æä¾›äº†ä¸€äº›é»˜è®¤çš„åºåˆ—åŒ–å™¨ï¼šjsonã€gobã€unixtimeï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªå¦‚ä½•ä½¿ç”¨å®ƒçš„å¿«é€Ÿç¤ºä¾‹</p>
<pre><code class="language-go">type User struct {
    Name        []byte                 `gorm:&quot;serializer:json&quot;`
    Roles       Roles                  `gorm:&quot;serializer:json&quot;`
    Contracts   map[string]interface{} `gorm:&quot;serializer:json&quot;`
    JobInfo     Job                    `gorm:&quot;type:bytes;serializer:gob&quot;`
    CreatedTime int64                  `gorm:&quot;serializer:unixtime;type:time&quot;` // å°† int ä½œä¸ºæ—¥æœŸæ—¶é—´å­˜å‚¨åˆ°æ•°æ®åº“ä¸­
}

type Roles []string

type Job struct {
    Title    string
    Location string
    IsIntern bool
}
</code></pre>
<h4 id="æ³¨å†Œåºåˆ—åŒ–å™¨">æ³¨å†Œåºåˆ—åŒ–å™¨</h4>
<p>ä¸€ä¸ªSerializeréœ€è¦å®ç°å¦‚ä½•å¯¹æ•°æ®è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œæ‰€ä»¥éœ€è¦å®ç°å¦‚ä¸‹æ¥å£</p>
<pre><code class="language-go">import &quot;gorm.io/gorm/schema&quot;

type SerializerInterface interface {
    Scan(ctx context.Context, field *schema.Field, dst reflect.Value, dbValue interface{}) error
    SerializerValuerInterface
}

type SerializerValuerInterface interface {
    Value(ctx context.Context, field *schema.Field, dst reflect.Value, fieldValue interface{}) (interface{}, error)
}
</code></pre>
<p>ä¾‹å¦‚ï¼Œé»˜è®¤ <code>JSONSerializer</code> çš„å®ç°å¦‚ä¸‹ï¼š</p>
<pre><code class="language-go">// JSONSerializer jsonåºåˆ—åŒ–å™¨
type JSONSerializer struct {
}

// å®ç° Scan æ–¹æ³•
func (JSONSerializer) Scan(ctx context.Context, field *Field, dst reflect.Value, dbValue interface{}) (err error) {
    fieldValue := reflect.New(field.FieldType)

    if dbValue != nil {
        var bytes []byte
        switch v := dbValue.(type) {
        case []byte:
            bytes = v
        case string:
            bytes = []byte(v)
        default:
            return fmt.Errorf(&quot;failed to unmarshal JSONB value: %#v&quot;, dbValue)
        }

        err = json.Unmarshal(bytes, fieldValue.Interface())
    }

    field.ReflectValueOf(ctx, dst).Set(fieldValue.Elem())
    return
}

// å®ç° Value æ–¹æ³•
func (JSONSerializer) Value(ctx context.Context, field *Field, dst reflect.Value, fieldValue interface{}) (interface{}, error) {
    return json.Marshal(fieldValue)
}
</code></pre>
<p>å¹¶ä½¿ç”¨ä»¥ä¸‹ä»£ç æ³¨å†Œï¼š<br>
<code>schema.RegisterSerializer(&quot;json&quot;, JSONSerializer{})</code></p>
<p>æ³¨å†Œåºåˆ—åŒ–å™¨åï¼Œå¯ä»¥å°†å…¶ä¸ serializer æ ‡ç­¾ä¸€èµ·ä½¿ç”¨ï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-go">type User struct {
    Name []byte `gorm:&quot;serializer:json&quot;`
}
</code></pre>
<h4 id="è‡ªå®šä¹‰åºåˆ—åŒ–å™¨ç±»å‹">è‡ªå®šä¹‰åºåˆ—åŒ–å™¨ç±»å‹</h4>
<p>ä½ å¯ä»¥é€šè¿‡æ ‡ç­¾ä½¿ç”¨å·²æ³¨å†Œçš„åºåˆ—åŒ–å™¨ï¼Œä½ ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ structï¼Œå®ç°ä¸Šè¿°çš„ <code>SerializerInterface</code> æ¥å£ï¼Œéšåä¾¿å¯ä»¥ç›´æ¥å°†å…¶ä½œä¸ºå­—æ®µç±»å‹ä½¿ç”¨ï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-go">type EncryptedString string

// ctx: contains request-scoped values
// field: the field using the serializer, contains GORM settings, struct tags
// dst: current model value, `user` in the below example
// dbValue: current field's value in database
func (es *EncryptedString) Scan(ctx context.Context, field*schema.Field, dst reflect.Value, dbValue interface{}) (err error) {
    switch value := dbValue.(type) {
    case []byte:
        *es = EncryptedString(bytes.TrimPrefix(value, []byte(&quot;hello&quot;)))
    case string:
        *es = EncryptedString(strings.TrimPrefix(value, &quot;hello&quot;))
    default:
        return fmt.Errorf(&quot;unsupported data %#v&quot;, dbValue)
    }
    return nil
}

// ctx: contains request-scoped values
// field: the field using the serializer, contains GORM settings, struct tags
// dst: current model value, `user` in the below example
// fieldValue: current field's value of the dst
func (es EncryptedString) Value(ctx context.Context, field *schema.Field, dst reflect.Value, fieldValue interface{}) (interface{}, error) {
    return &quot;hello&quot; + string(es), nil
}

type User struct {
    gorm.Model
    Password EncryptedString
}

data := User{
    Password: EncryptedString(&quot;pass&quot;),
}

DB.Create(&amp;data)
// INSERT INTO `serializer_structs` (`password`) VALUES (&quot;hellopass&quot;)

var result User
DB.First(&amp;result, &quot;id = ?&quot;, data.ID)
// result =&gt; User{
//   Password: EncryptedString(&quot;pass&quot;),
// }

DB.Where(User{Password: EncryptedString(&quot;pass&quot;)}).Take(&amp;result)
// SELECT * FROM `users` WHERE `users`.`password` = &quot;hellopass&quot;
</code></pre>
<h3 id="ç´¢å¼•1">ç´¢å¼•ã€1ã€‘</h3>
<p>GORM å…è®¸é€šè¿‡ indexã€uniqueIndex æ ‡ç­¾åˆ›å»ºç´¢å¼•ï¼Œè¿™äº›ç´¢å¼•å°†åœ¨ä½¿ç”¨ GORM è¿›è¡Œ <code>AutoMigrate</code> æˆ– <code>Createtable</code> æ—¶åˆ›å»º</p>
<h4 id="ç´¢å¼•æ ‡ç­¾">ç´¢å¼•æ ‡ç­¾</h4>
<p>GORM å¯ä»¥æ¥å—å¾ˆå¤šç´¢å¼•è®¾ç½®ï¼Œä¾‹å¦‚<code>class</code>ã€<code>type</code>ã€<code>where</code>ã€<code>comment</code>ã€e<code>xpression</code>ã€<code>sort</code>ã€<code>collate</code>ã€<code>option</code></p>
<pre><code class="language-go">type User struct {
    Name  string `gorm:&quot;index&quot;`
    Name2 string `gorm:&quot;index:idx_name,unique&quot;`
    Name3 string `gorm:&quot;index:,sort:desc,collate:utf8,type:btree,length:10,where:name3 != 'jinzhu'&quot;`
    Name4 string `gorm:&quot;uniqueIndex&quot;`
    Age   int64  `gorm:&quot;index:,class:FULLTEXT,comment:hello \\, world,where:age &gt; 10&quot;`
    Age2  int64  `gorm:&quot;index:,expression:ABS(age)&quot;`
}

// MySQL é€‰é¡¹
type User struct {
    Name string `gorm:&quot;index:,class:FULLTEXT,option:WITH PARSER ngram INVISIBLE&quot;`
}
</code></pre>
<p><strong>å”¯ä¸€ç´¢å¼•</strong><br>
<code>uniqueIndex</code> æ ‡ç­¾çš„ä½œç”¨ä¸ <code>index</code> ç±»ä¼¼ï¼Œå®ƒç­‰æ•ˆäº <code>index:,unique</code></p>
<pre><code class="language-go">type User struct {
    Name1 string `gorm:&quot;uniqueIndex&quot;`
    Name2 string `gorm:&quot;uniqueIndex:idx_name,sort:desc&quot;`
}
</code></pre>
<h4 id="å¤åˆç´¢å¼•">å¤åˆç´¢å¼•</h4>
<p>ä¸¤ä¸ªå­—æ®µä½¿ç”¨åŒä¸€ä¸ªç´¢å¼•åå°†åˆ›å»ºå¤åˆç´¢å¼•</p>
<pre><code class="language-go">// create composite index `idx_member` with columns `name`, `number`
type User struct {
    Name   string `gorm:&quot;index:idx_member&quot;`
    Number string `gorm:&quot;index:idx_member&quot;`
}
</code></pre>
<p><strong>å­—æ®µä¼˜å…ˆçº§</strong><br>
å¤åˆç´¢å¼•åˆ—çš„é¡ºåºä¼šå½±å“å…¶æ€§èƒ½ï¼Œå¯ä»¥ä½¿ç”¨ priority æŒ‡å®šé¡ºåºï¼Œé»˜è®¤ä¼˜å…ˆçº§å€¼æ˜¯ 10ã€‚å¦‚æœä¼˜å…ˆçº§å€¼ç›¸åŒï¼Œåˆ™é¡ºåºå–å†³äºæ¨¡å‹ç»“æ„ä½“å­—æ®µçš„é¡ºåº</p>
<pre><code class="language-go">type User struct {
    Name   string `gorm:&quot;index:idx_member&quot;`
    Number string `gorm:&quot;index:idx_member&quot;`
}
// column order: name, number

type User struct {
    Name   string `gorm:&quot;index:idx_member,priority:2&quot;`
    Number string `gorm:&quot;index:idx_member,priority:1&quot;`
}
// column order: number, name

type User struct {
    Name   string `gorm:&quot;index:idx_member,priority:12&quot;`
    Number string `gorm:&quot;index:idx_member&quot;`
}
// column order: number, name
</code></pre>
<p><strong>å…±äº«å¤åˆç´¢å¼•</strong><br>
MARK æ²¡çœ‹æ‡‚</p>
<h4 id="å¤šç´¢å¼•">å¤šç´¢å¼•</h4>
<p>ä¸€ä¸ªå­—æ®µæ¥å—å¤šä¸ª <code>index</code>ã€<code>uniqueIndex</code> æ ‡ç­¾ï¼Œè¿™ä¼šåœ¨ä¸€ä¸ªå­—æ®µä¸Šåˆ›å»ºå¤šä¸ªç´¢</p>
<pre><code class="language-go">type UserIndex struct {
    OID          int64  `gorm:&quot;index:idx_id;index:idx_oid,unique&quot;`
    MemberNumber string `gorm:&quot;index:idx_id&quot;`
}
</code></pre>
<h3 id="çº¦æŸ1">çº¦æŸã€1ã€‘</h3>
<p>GORM å…è®¸é€šè¿‡æ ‡ç­¾åˆ›å»ºæ•°æ®åº“çº¦æŸï¼Œçº¦æŸä¼šåœ¨é€šè¿‡ GORM è¿›è¡Œ AutoMigrate æˆ–åˆ›å»ºæ•°æ®è¡¨æ—¶è¢«åˆ›å»ºã€‚</p>
<h4 id="æ£€æŸ¥çº¦æŸ">æ£€æŸ¥çº¦æŸ</h4>
<p>é€šè¿‡ check æ ‡ç­¾åˆ›å»ºæ£€æŸ¥çº¦æŸ</p>
<pre><code class="language-go">type UserIndex struct {
    Name  string `gorm:&quot;check:name_checker,name &lt;&gt; 'jinzhu'&quot;`
    Name2 string `gorm:&quot;check:name &lt;&gt; 'jinzhu'&quot;`
    Name3 string `gorm:&quot;check:,name &lt;&gt; 'jinzhu'&quot;`
}
</code></pre>
<h4 id="ç´¢å¼•-çº¦æŸ">ç´¢å¼• çº¦æŸ</h4>
<p>è§<a href="#%E7%B4%A2%E5%BC%951">æ•°æ®åº“ç´¢å¼•</a></p>
<h4 id="å¤–é”®-çº¦æŸ">å¤–é”® çº¦æŸ</h4>
<p>GORM ä¼šä¸ºå…³è”åˆ›å»ºå¤–é”®çº¦æŸï¼Œå¯ä»¥åœ¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­ç¦ç”¨æ­¤åŠŸèƒ½ï¼š</p>
<pre><code class="language-go">db, err := gorm.Open(sqlite.Open(&quot;gorm.db&quot;), &amp;gorm.Config{
  DisableForeignKeyConstraintWhenMigrating: true,
})
</code></pre>
<p>GORM å…è®¸é€šè¿‡ <code>constraint</code> æ ‡ç­¾çš„ <code>OnDelete</code>ã€<code>OnUpdate</code> é€‰é¡¹è®¾ç½®å¤–é”®çº¦æŸï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-go">type User struct {
  gorm.Model
  CompanyID  int
  Company    Company    `gorm:&quot;constraint:OnUpdate:CASCADE,OnDelete:SET NULL;&quot;`
  CreditCard CreditCard `gorm:&quot;constraint:OnUpdate:CASCADE,OnDelete:SET NULL;&quot;`
  //çº§è”æ›´æ–°,çº§è”åˆ é™¤
}

type CreditCard struct {
  gorm.Model
  Number string
  UserID uint
}

type Company struct {
  ID   int
  Name string
}
</code></pre>
<h3 id="å¤åˆä¸»é”®1">å¤åˆä¸»é”®ã€1ã€‘</h3>
<p>é€šè¿‡å°†å¤šä¸ªå­—æ®µè®¾ä¸ºä¸»é”®ï¼Œä»¥åˆ›å»ºå¤åˆä¸»é”®ï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-go">type Product struct {
  ID           string `gorm:&quot;primaryKey&quot;`
  LanguageCode string `gorm:&quot;primaryKey&quot;`
  Code         string
  Name         string
}
</code></pre>
<p><strong>æ³¨æ„</strong>ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼Œæ•´å‹ <code>PrioritizedPrimaryField</code> å¯ç”¨äº† <code>AutoIncrement</code>ï¼Œè¦ç¦ç”¨å®ƒï¼Œæ‚¨éœ€è¦ä¸ºæ•´å‹å­—æ®µå…³é—­ <code>autoIncrement</code>ï¼š</p>
<pre><code class="language-go">type Product struct {
  CategoryID uint64 `gorm:&quot;primaryKey;autoIncrement:false&quot;`
  TypeID     uint64 `gorm:&quot;primaryKey;autoIncrement:false&quot;`
}
</code></pre>
<h3 id="å®‰å…¨">å®‰å…¨</h3>
<p>GORM ä½¿ç”¨ database/sql çš„å‚æ•°å ä½ç¬¦æ¥æ„é€  SQL è¯­å¥ï¼Œè¿™å¯ä»¥è‡ªåŠ¨è½¬ä¹‰å‚æ•°ï¼Œé¿å… SQL æ³¨å…¥æ•°æ®</p>
<p><strong>æ³¨æ„</strong> Logger æ‰“å°çš„ SQL å¹¶ä¸åƒæœ€ç»ˆæ‰§è¡Œçš„ SQL é‚£æ ·å·²ç»è½¬ä¹‰ï¼Œå¤åˆ¶å’Œè¿è¡Œè¿™äº› SQL æ—¶åº”å½“æ³¨æ„ã€‚</p>
<p><strong>æŸ¥è¯¢æ¡ä»¶</strong><br>
ç”¨æˆ·çš„è¾“å…¥åªèƒ½ä½œä¸ºå‚æ•°ï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-go">userInput := &quot;jinzhu;drop table users;&quot;

// å®‰å…¨çš„ï¼Œä¼šè¢«è½¬ä¹‰
db.Where(&quot;name = ?&quot;, userInput).First(&amp;user)

// SQL æ³¨å…¥
db.Where(fmt.Sprintf(&quot;name = %v&quot;, userInput)).First(&amp;user)
</code></pre>
<p><strong>å†…è”æ¡ä»¶</strong>.</p>
<pre><code class="language-go">// ä¼šè¢«è½¬ä¹‰
db.First(&amp;user, &quot;name = ?&quot;, userInput)

// SQL æ³¨å…¥
db.First(&amp;user, fmt.Sprintf(&quot;name = %v&quot;, userInput))
</code></pre>
<p>å½“é€šè¿‡ç”¨æˆ·è¾“å…¥çš„æ•´å½¢ä¸»é”®æ£€ç´¢è®°å½•æ—¶ï¼Œä½ åº”è¯¥å¯¹å˜é‡è¿›è¡Œç±»å‹æ£€æŸ¥ã€‚</p>
<pre><code class="language-go">userInputID := &quot;1=1;drop table users;&quot;
// safe, return error
id, err := strconv.Atoi(userInputID)
if err != nil {
    return err
}
db.First(&amp;user, id)

// SQL injection
db.First(&amp;user, userInputID)
// SELECT * FROM users WHERE 1=1;drop table users;
</code></pre>
<p><strong>SQL æ³¨å…¥æ–¹æ³•</strong><br>
ä¸ºäº†æ”¯æŒæŸäº›åŠŸèƒ½ï¼Œä¸€äº›è¾“å…¥ä¸ä¼šè¢«è½¬ä¹‰ï¼Œè°ƒç”¨æ–¹æ³•æ—¶è¦å°å¿ƒç”¨æˆ·è¾“å…¥çš„å‚æ•°ã€‚</p>
<pre><code class="language-go">db.Select(&quot;name; drop table users;&quot;).First(&amp;user)
db.Distinct(&quot;name; drop table users;&quot;).First(&amp;user)

db.Model(&amp;user).Pluck(&quot;name; drop table users;&quot;, &amp;names)

db.Group(&quot;name; drop table users;&quot;).First(&amp;user)

db.Group(&quot;name&quot;).Having(&quot;1 = 1;drop table users;&quot;).First(&amp;user)

db.Raw(&quot;select name from users; drop table users;&quot;).First(&amp;user)

db.Exec(&quot;select name from users; drop table users;&quot;)

db.Order(&quot;name; drop table users;&quot;).First(&amp;user)
</code></pre>
<p>é¿å… SQL æ³¨å…¥çš„ä¸€èˆ¬åŸåˆ™æ˜¯ï¼Œä¸ä¿¡ä»»ç”¨æˆ·æäº¤çš„æ•°æ®ã€‚å¯ä»¥è¿›è¡Œç™½åå•éªŒè¯æ¥æµ‹è¯•ç”¨æˆ·çš„è¾“å…¥æ˜¯å¦ä¸ºå·²çŸ¥å®‰å…¨çš„ã€å·²æ‰¹å‡†ã€å·²å®šä¹‰çš„è¾“å…¥ï¼Œå¹¶ä¸”åœ¨ä½¿ç”¨ç”¨æˆ·çš„è¾“å…¥æ—¶ï¼Œä»…å°†å®ƒä»¬ä½œä¸ºå‚æ•°ã€‚</p>
<h3 id="gormé…ç½®2">GORMé…ç½®ã€2ã€‘</h3>
<p>GORM æä¾›çš„é…ç½®å¯ä»¥åœ¨åˆå§‹åŒ–æ—¶ä½¿ç”¨</p>
<pre><code class="language-go">type Config struct {
  SkipDefaultTransaction   bool
  NamingStrategy           schema.Namer
  Logger                   logger.Interface
  NowFunc                  func() time.Time
  DryRun                   bool
  PrepareStmt              bool
  DisableNestedTransaction bool
  AllowGlobalUpdate        bool
  DisableAutomaticPing     bool
  DisableForeignKeyConstraintWhenMigrating bool
}
</code></pre>
<h4 id="è·³è¿‡é»˜è®¤äº‹åŠ¡">è·³è¿‡é»˜è®¤äº‹åŠ¡</h4>
<p>ä¸ºäº†ç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼ŒGORM ä¼šåœ¨äº‹åŠ¡é‡Œæ‰§è¡Œå†™å…¥æ“ä½œï¼ˆåˆ›å»ºã€æ›´æ–°ã€åˆ é™¤ï¼‰ã€‚å¦‚æœæ²¡æœ‰è¿™æ–¹é¢çš„è¦æ±‚ï¼Œæ‚¨å¯ä»¥åœ¨åˆå§‹åŒ–æ—¶ç¦ç”¨å®ƒã€‚</p>
<pre><code class="language-go">db, err := gorm.Open(sqlite.Open(&quot;gorm.db&quot;), &amp;gorm.Config{
  SkipDefaultTransaction: true,
})
</code></pre>
<h4 id="å‘½åç­–ç•¥">å‘½åç­–ç•¥</h4>
<p>GORM å…è®¸ç”¨æˆ·é€šè¿‡è¦†ç›–é»˜è®¤çš„<code>NamingStrategy</code>æ¥æ›´æ”¹å‘½åçº¦å®šï¼Œè¿™éœ€è¦å®ç°æ¥å£ <code>Namer</code></p>
<pre><code class="language-go">type Namer interface {
    TableName(table string) string
    SchemaName(table string) string
    ColumnName(table, column string) string
    JoinTableName(table string) string
    RelationshipFKName(Relationship) string
    CheckerName(table, column string) string
    IndexName(table, column string) string
}
</code></pre>
<p>é»˜è®¤ NamingStrategy ä¹Ÿæä¾›äº†å‡ ä¸ªé€‰é¡¹ï¼Œå¦‚ï¼š</p>
<pre><code class="language-go">db, err := gorm.Open(sqlite.Open(&quot;gorm.db&quot;), &amp;gorm.Config{
  NamingStrategy: schema.NamingStrategy{
    TablePrefix: &quot;t_&quot;,   // table name prefix, table for `User` would be `t_users`
    SingularTable: true, // use singular table name, table for `User` would be `user` with this option enabled
    NoLowerCase: true, // skip the snake_casing of names
    NameReplacer: strings.NewReplacer(&quot;CID&quot;, &quot;Cid&quot;), // use name replacer to change struct/field name before convert it to db name
  },
})
</code></pre>
<h4 id="logger">Logger</h4>
<p>å…è®¸é€šè¿‡è¦†ç›–æ­¤é€‰é¡¹æ›´æ”¹ GORM çš„é»˜è®¤ loggerï¼Œå‚è€ƒ <a href="#logger1">Logger</a> è·å–è¯¦æƒ…</p>
<h4 id="owfunc">owFunc</h4>
<p>æ›´æ”¹åˆ›å»ºæ—¶é—´ä½¿ç”¨çš„å‡½æ•°</p>
<pre><code class="language-go">db, err := gorm.Open(sqlite.Open(&quot;gorm.db&quot;), &amp;gorm.Config{
  NowFunc: func() time.Time {
    return time.Now().Local()
  },
})
</code></pre>
<h4 id="dryruné…ç½®">DryRuné…ç½®</h4>
<p>ç”Ÿæˆ SQL ä½†ä¸æ‰§è¡Œï¼Œå¯ä»¥ç”¨äºå‡†å¤‡æˆ–æµ‹è¯•ç”Ÿæˆçš„ SQLï¼Œå‚è€ƒ <a href="#session2">ä¼šè¯</a> è·å–è¯¦æƒ…</p>
<pre><code class="language-go">db, err := gorm.Open(sqlite.Open(&quot;gorm.db&quot;), &amp;gorm.Config{
  DryRun: false,
})
</code></pre>
<h4 id="preparestmt">PrepareStmt</h4>
<p>PreparedStmt åœ¨æ‰§è¡Œä»»ä½• SQL æ—¶éƒ½ä¼šåˆ›å»ºä¸€ä¸ª prepared statement å¹¶å°†å…¶ç¼“å­˜ï¼Œä»¥æé«˜åç»­çš„æ•ˆç‡ï¼Œå‚è€ƒ <a href="#session2">ä¼šè¯</a> è·å–è¯¦æƒ…</p>
<pre><code class="language-go">db, err := gorm.Open(sqlite.Open(&quot;gorm.db&quot;), &amp;gorm.Config{
  PrepareStmt: false,
})
</code></pre>
<h4 id="ç¦ç”¨åµŒå¥—äº‹åŠ¡é…ç½®">ç¦ç”¨åµŒå¥—äº‹åŠ¡é…ç½®</h4>
<p>åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ä½¿ç”¨ <code>Transaction</code> æ–¹æ³•ï¼ŒGORM ä¼šä½¿ç”¨ <code>SavePoint(savedPointName)</code>ï¼Œ<code>RollbackTo(savedPointName)</code> ä¸ºä½ æä¾›åµŒå¥—äº‹åŠ¡æ”¯æŒï¼Œä½ å¯ä»¥é€šè¿‡ <code>DisableNestedTransaction</code> é€‰é¡¹å…³é—­å®ƒï¼ŒæŸ¥çœ‹ <a href="#session2">Session</a> è·å–è¯¦æƒ…</p>
<h4 id="allowglobalupdateé…ç½®">AllowGlobalUpdateé…ç½®</h4>
<p>å¯ç”¨å…¨å±€ update/deleteï¼ŒæŸ¥çœ‹ <a href="#session2">Session</a> è·å–è¯¦æƒ…</p>
<h4 id="disableautomaticping">DisableAutomaticPing</h4>
<p>åœ¨å®Œæˆåˆå§‹åŒ–åï¼ŒGORM ä¼šè‡ªåŠ¨ ping æ•°æ®åº“ä»¥æ£€æŸ¥æ•°æ®åº“çš„å¯ç”¨æ€§ï¼Œè‹¥è¦ç¦ç”¨è¯¥ç‰¹æ€§ï¼Œå¯å°†å…¶è®¾ç½®ä¸º true</p>
<pre><code class="language-go">db, err := gorm.Open(sqlite.Open(&quot;gorm.db&quot;), &amp;gorm.Config{
  DisableAutomaticPing: true,
})
</code></pre>
<h4 id="disableforeignkeyconstraintwhenmigrating">DisableForeignKeyConstraintWhenMigrating</h4>
<p>åœ¨ <code>AutoMigrate</code> æˆ– <code>CreateTable</code> æ—¶ï¼ŒGORM ä¼šè‡ªåŠ¨åˆ›å»ºå¤–é”®çº¦æŸï¼Œè‹¥è¦ç¦ç”¨è¯¥ç‰¹æ€§ï¼Œå¯å°†å…¶è®¾ç½®ä¸º trueï¼Œå‚è€ƒ <a href="#%E8%BF%81%E7%A7%BB2">è¿ç§»</a> è·å–è¯¦æƒ…ã€‚</p>
<pre><code class="language-go">db, err := gorm.Open(sqlite.Open(&quot;gorm.db&quot;), &amp;gorm.Config{
  DisableForeignKeyConstraintWhenMigrating: true,
})
</code></pre>

          <div class="toc-container"><ul class="markdownIt-TOC">
<li><a href="#gorm%E7%AC%94%E8%AE%B0">GORMç¬”è®°</a>
<ul>
<li><a href="#%E5%85%A5%E9%97%A8">å…¥é—¨</a>
<ul>
<li><a href="#gorm%E5%AE%89%E8%A3%851">GORMå®‰è£…ã€1ã€‘</a></li>
<li><a href="#%E8%BF%9E%E6%8E%A5%E6%95%B0%E6%8D%AE%E5%BA%931">è¿æ¥æ•°æ®åº“ã€1ã€‘</a></li>
<li><a href="#%E8%87%AA%E5%8A%A8%E8%BF%81%E7%A7%BB1">è‡ªåŠ¨è¿ç§»ã€1ã€‘</a></li>
<li><a href="#%E5%A3%B0%E6%98%8E%E6%A8%A1%E5%9E%8B">å£°æ˜æ¨¡å‹</a>
<ul>
<li><a href="#%E6%A8%A1%E5%9E%8B%E5%AE%9A%E4%B9%891">æ¨¡å‹å®šä¹‰ã€1ã€‘</a></li>
<li><a href="#%E9%AB%98%E7%BA%A7%E9%80%89%E9%A1%B9%E5%B5%8C%E5%85%A5%E7%BB%93%E6%9E%84%E4%BD%931-%E5%AD%97%E6%AE%B5%E6%A0%87%E7%AD%BE3">é«˜çº§é€‰é¡¹ã€åµŒå…¥ç»“æ„ä½“:1 å­—æ®µæ ‡ç­¾ï¼š3ã€‘</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#crud-%E6%8E%A5%E5%8F%A33">CRUD æ¥å£ã€3ã€‘</a>
<ul>
<li><a href="#%E5%88%9B%E5%BB%BA">åˆ›å»º</a>
<ul>
<li><a href="#%E5%88%9B%E5%BB%BA%E8%AE%B0%E5%BD%95">åˆ›å»ºè®°å½•</a></li>
<li><a href="#%E6%A0%B9%E6%8D%AE-map-%E5%88%9B%E5%BB%BA">æ ¹æ® Map åˆ›å»º</a></li>
<li><a href="#%E6%8C%87%E5%AE%9A%E5%AD%97%E6%AE%B5%E5%88%9B%E5%BB%BA%E8%AE%B0%E5%BD%95">æŒ‡å®šå­—æ®µåˆ›å»ºè®°å½•</a></li>
<li><a href="#%E5%88%9B%E5%BB%BA%E8%B7%B3%E8%BF%87%E9%92%A9%E5%AD%90">åˆ›å»º&amp;è·³è¿‡é’©å­</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8-sql-%E8%A1%A8%E8%BE%BE%E5%BC%8F-context-valuer-%E5%88%9B%E5%BB%BA%E8%AE%B0%E5%BD%95">ä½¿ç”¨ SQL è¡¨è¾¾å¼ã€Context Valuer åˆ›å»ºè®°å½•</a></li>
<li><a href="#upsert">Upsert</a></li>
<li><a href="#%E5%88%9B%E5%BB%BA%E9%AB%98%E7%BA%A7%E9%80%89%E9%A1%B9">åˆ›å»ºé«˜çº§é€‰é¡¹</a></li>
</ul>
</li>
<li><a href="#%E6%9F%A5%E8%AF%A2">æŸ¥è¯¢</a>
<ul>
<li><a href="#%E6%A3%80%E7%B4%A2%E5%8D%95%E4%B8%AA%E5%AF%B9%E8%B1%A1">æ£€ç´¢å•ä¸ªå¯¹è±¡</a></li>
<li><a href="#%E6%9F%A5%E6%89%BE%E5%A4%B1%E8%B4%A5%E6%A3%80%E6%9F%A5">æŸ¥æ‰¾å¤±è´¥æ£€æŸ¥</a></li>
<li><a href="#%E6%A0%B9%E6%8D%AE%E4%B8%BB%E9%94%AE%E6%9F%A5%E8%AF%A2">æ ¹æ®ä¸»é”®æŸ¥è¯¢</a></li>
<li><a href="#%E6%A0%B9%E6%8D%AE%E6%9D%A1%E4%BB%B6%E6%9F%A5%E8%AF%A2">æ ¹æ®æ¡ä»¶æŸ¥è¯¢</a></li>
<li><a href="#%E9%80%89%E6%8B%A9%E7%89%B9%E5%AE%9A%E5%AD%97%E6%AE%B5">é€‰æ‹©ç‰¹å®šå­—æ®µ</a></li>
<li><a href="#%E6%8E%92%E5%BA%8F">æ’åº</a></li>
<li><a href="#limit-offset">Limit &amp; Offset</a></li>
<li><a href="#group-by-having">Group By &amp; Having</a></li>
<li><a href="#distinct">Distinct</a></li>
<li><a href="#joins">Joins</a></li>
<li><a href="#scan">Scan</a></li>
</ul>
</li>
<li><a href="#%E9%AB%98%E7%BA%A7%E6%9F%A5%E8%AF%A2">é«˜çº§æŸ¥è¯¢</a>
<ul>
<li><a href="#%E6%99%BA%E8%83%BD%E9%80%89%E6%8B%A9%E5%AD%97%E6%AE%B5">æ™ºèƒ½é€‰æ‹©å­—æ®µ</a></li>
<li><a href="#%E9%94%81-2">é” ã€2ã€‘</a></li>
<li><a href="#%E5%AD%90%E6%9F%A5%E8%AF%A2">å­æŸ¥è¯¢</a></li>
<li><a href="#group-%E6%9D%A1%E4%BB%B6">Group æ¡ä»¶</a></li>
<li><a href="#%E5%B8%A6%E5%A4%9A%E4%B8%AA%E5%88%97%E7%9A%84in">å¸¦å¤šä¸ªåˆ—çš„In</a></li>
<li><a href="#%E5%91%BD%E5%90%8D%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3">å‘½åå‚æ•°è¯¦è§£</a></li>
<li><a href="#find-%E8%87%B3-map">Find è‡³ map</a></li>
<li><a href="#firstorinit">FirstOrInit</a></li>
<li><a href="#firstorcreate">FirstOrCreate</a></li>
<li><a href="#%E4%BC%98%E5%8C%96%E5%99%A8-%E7%B4%A2%E5%BC%95%E6%8F%90%E7%A4%BA4">ä¼˜åŒ–å™¨ã€ç´¢å¼•æç¤ºã€4ã€‘</a></li>
<li><a href="#%E8%BF%AD%E4%BB%A3">è¿­ä»£</a></li>
<li><a href="#findinbatches">FindInBatches</a></li>
<li><a href="#%E6%9F%A5%E8%AF%A2%E9%92%A9%E5%AD%90">æŸ¥è¯¢é’©å­</a></li>
<li><a href="#pluck%E6%96%B9%E6%B3%953">Pluckæ–¹æ³•ã€3ã€‘</a></li>
<li><a href="#scope%E6%96%B9%E6%B3%95">Scopeæ–¹æ³•</a></li>
<li><a href="#count">Count</a></li>
</ul>
</li>
<li><a href="#%E6%9B%B4%E6%96%B0">æ›´æ–°</a>
<ul>
<li><a href="#%E4%BF%9D%E5%AD%98%E6%89%80%E6%9C%89%E5%AD%97%E6%AE%B5">ä¿å­˜æ‰€æœ‰å­—æ®µ</a></li>
<li><a href="#%E6%9B%B4%E6%96%B0%E5%8D%95%E4%B8%AA%E5%88%97">æ›´æ–°å•ä¸ªåˆ—</a></li>
<li><a href="#%E6%9B%B4%E6%96%B0%E5%A4%9A%E5%88%97">æ›´æ–°å¤šåˆ—</a></li>
<li><a href="#%E6%9B%B4%E6%96%B0%E9%80%89%E5%AE%9A%E5%AD%97%E6%AE%B5">æ›´æ–°é€‰å®šå­—æ®µ</a></li>
<li><a href="#%E6%9B%B4%E6%96%B0hook">æ›´æ–°Hook</a></li>
<li><a href="#%E6%89%B9%E9%87%8F%E6%9B%B4%E6%96%B0">æ‰¹é‡æ›´æ–°</a></li>
<li><a href="#%E6%9B%B4%E6%96%B0%E9%AB%98%E7%BA%A7%E9%80%89%E9%A1%B9">æ›´æ–°é«˜çº§é€‰é¡¹</a></li>
</ul>
</li>
<li><a href="#%E5%88%A0%E9%99%A4">åˆ é™¤</a>
<ul>
<li><a href="#%E9%92%A9%E5%AD%90%E5%87%BD%E6%95%B0">é’©å­å‡½æ•°</a></li>
<li><a href="#%E6%89%B9%E9%87%8F%E5%88%A0%E9%99%A4">æ‰¹é‡åˆ é™¤</a></li>
<li><a href="#%E8%BD%AF%E5%88%A0%E9%99%A4">è½¯åˆ é™¤</a></li>
</ul>
</li>
<li><a href="#%E5%8E%9F%E7%94%9Fsql%E5%92%8Csql%E7%94%9F%E6%88%90%E5%99%A8">åŸç”ŸSQLå’ŒSQLç”Ÿæˆå™¨</a>
<ul>
<li><a href="#%E5%8E%9F%E7%94%9F-sql">åŸç”Ÿ SQL</a></li>
<li><a href="#%E5%91%BD%E5%90%8D%E5%8F%82%E6%95%B0%E7%AE%80%E4%BB%8B">å‘½åå‚æ•°ç®€ä»‹</a></li>
<li><a href="#dryrun-%E6%A8%A1%E5%BC%8F">DryRun æ¨¡å¼</a></li>
<li><a href="#tosql">ToSQL</a></li>
<li><a href="#row-rows">Row &amp; Rows</a></li>
<li><a href="#%E5%B0%86-sqlrows-%E6%89%AB%E6%8F%8F%E8%87%B3-model">å°† sql.Rows æ‰«æè‡³ model</a></li>
<li><a href="#%E8%BF%9E%E6%8E%A5">è¿æ¥</a></li>
<li><a href="#%E9%AB%98%E7%BA%A7">é«˜çº§</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E5%85%B3%E8%81%94">å…³è”</a>
<ul>
<li><a href="#belongs-to">Belongs To</a></li>
<li><a href="#has-one">Has One</a>
<ul>
<li><a href="#%E5%A3%B0%E6%98%8E%E6%A3%80%E7%B4%A2-has-one">å£°æ˜&amp;æ£€ç´¢ Has One</a></li>
<li><a href="#%E8%87%AA%E5%BC%95%E7%94%A8-has-one">è‡ªå¼•ç”¨ Has One</a></li>
</ul>
</li>
<li><a href="#has-many">Has Many</a>
<ul>
<li><a href="#%E5%A3%B0%E6%98%8E%E6%A3%80%E7%B4%A2-has-many">å£°æ˜&amp;æ£€ç´¢ Has Many</a></li>
<li><a href="#%E8%87%AA%E5%BC%95%E7%94%A8-has-many">è‡ªå¼•ç”¨ Has Many</a></li>
</ul>
</li>
<li><a href="#many-to-many">Many To Many</a>
<ul>
<li><a href="#%E5%8F%8D%E5%90%91%E5%BC%95%E7%94%A8-many-to-many">åå‘å¼•ç”¨-Many To Many</a></li>
<li><a href="#%E8%87%AA%E5%BC%95%E7%94%A8-many2many">è‡ªå¼•ç”¨ Many2Many</a></li>
<li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%BF%9E%E6%8E%A5%E8%A1%A8">è‡ªå®šä¹‰è¿æ¥è¡¨</a></li>
<li><a href="#%E5%A4%8D%E5%90%88%E5%A4%96%E9%94%AE">å¤åˆå¤–é”®</a></li>
</ul>
</li>
<li><a href="#polymorphism">Polymorphism</a></li>
<li><a href="#%E5%A4%96%E9%94%AE%E7%BA%A6%E6%9D%9F">å¤–é”®çº¦æŸ</a></li>
<li><a href="#%E5%85%B3%E8%81%94%E6%A8%A1%E5%BC%8F">å…³è”æ¨¡å¼</a>
<ul>
<li><a href="#%E8%87%AA%E5%8A%A8%E5%88%9B%E5%BB%BA-%E6%9B%B4%E6%96%B0">è‡ªåŠ¨åˆ›å»ºã€æ›´æ–°</a></li>
<li><a href="#%E8%B7%B3%E8%BF%87%E8%87%AA%E5%8A%A8%E5%88%9B%E5%BB%BA-%E6%9B%B4%E6%96%B0">è·³è¿‡è‡ªåŠ¨åˆ›å»ºã€æ›´æ–°</a></li>
<li><a href="#selectomit-%E5%85%B3%E8%81%94%E5%AD%97%E6%AE%B5">Select/Omit å…³è”å­—æ®µ</a></li>
<li><a href="#%E5%88%A0%E9%99%A4%E5%85%B3%E8%81%94">åˆ é™¤å…³è”</a></li>
<li><a href="#%E5%85%B3%E8%81%94%E6%A8%A1%E5%BC%8F%E7%9B%B8%E5%85%B3">å…³è”æ¨¡å¼ç›¸å…³</a></li>
<li><a href="#%E5%88%A0%E9%99%A4%E5%85%B3%E8%81%94%E8%AE%B0%E5%BD%95">åˆ é™¤å…³è”è®°å½•</a></li>
<li><a href="#%E5%85%B3%E8%81%94%E6%A0%87%E7%AD%BEassociation-tags">å…³è”æ ‡ç­¾ï¼ˆAssociation Tagsï¼‰</a></li>
</ul>
</li>
<li><a href="#%E9%A2%84%E5%8A%A0%E8%BD%BD3">é¢„åŠ è½½ã€3ã€‘</a>
<ul>
<li><a href="#%E9%A2%84%E5%8A%A0%E8%BD%BD%E7%A4%BA%E4%BE%8B">é¢„åŠ è½½ç¤ºä¾‹</a></li>
<li><a href="#joins-%E9%A2%84%E5%8A%A0%E8%BD%BD">Joins é¢„åŠ è½½</a></li>
<li><a href="#%E9%A2%84%E5%8A%A0%E8%BD%BD%E5%85%A8%E9%83%A8">é¢„åŠ è½½å…¨éƒ¨</a></li>
<li><a href="#%E6%9D%A1%E4%BB%B6%E9%A2%84%E5%8A%A0%E8%BD%BD">æ¡ä»¶é¢„åŠ è½½</a></li>
<li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E9%A2%84%E5%8A%A0%E8%BD%BD-sql">è‡ªå®šä¹‰é¢„åŠ è½½ SQL</a></li>
<li><a href="#%E5%B5%8C%E5%A5%97%E9%A2%84%E5%8A%A0%E8%BD%BD">åµŒå¥—é¢„åŠ è½½</a></li>
<li><a href="#%E5%B5%8C%E5%85%A5%E5%BC%8F%E9%A2%84%E5%8A%A0%E8%BD%BD">åµŒå…¥å¼é¢„åŠ è½½</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E6%95%99%E7%A8%8B">æ•™ç¨‹</a>
<ul>
<li><a href="#%E4%B8%8A%E4%B8%8B%E6%96%872">ä¸Šä¸‹æ–‡ã€2ã€‘</a>
<ul>
<li><a href="#%E5%8D%95%E4%BC%9A%E8%AF%9D%E6%A8%A1%E5%BC%8F">å•ä¼šè¯æ¨¡å¼</a></li>
<li><a href="#%E8%BF%9E%E7%BB%AD%E4%BC%9A%E8%AF%9D%E6%A8%A1%E5%BC%8F">è¿ç»­ä¼šè¯æ¨¡å¼</a></li>
<li><a href="#%E4%B8%8A%E4%B8%8B%E6%96%87%E8%B6%85%E6%97%B6">ä¸Šä¸‹æ–‡è¶…æ—¶</a></li>
<li><a href="#hookscallbacks-%E4%B8%AD%E7%9A%84-context">Hooks/Callbacks ä¸­çš„ Context</a></li>
<li><a href="#%E4%B8%8Echi%E4%B8%AD%E9%97%B4%E4%BB%B6%E9%9B%86%E6%88%90">ä¸Chiä¸­é—´ä»¶é›†æˆ</a></li>
<li><a href="#logger%E9%9B%86%E6%88%90">Loggeré›†æˆ</a></li>
</ul>
</li>
<li><a href="#%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%862">é”™è¯¯å¤„ç†ã€2ã€‘</a>
<ul>
<li><a href="#%E5%9F%BA%E6%9C%AC%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">åŸºæœ¬é”™è¯¯å¤„ç†</a></li>
<li><a href="#errrecordnotfound">ErrRecordNotFound</a></li>
<li><a href="#%E5%A4%84%E7%90%86%E9%94%99%E8%AF%AF%E4%BB%A3%E7%A0%81">å¤„ç†é”™è¯¯ä»£ç </a></li>
<li><a href="#%E6%96%B9%E8%A8%80%E8%BD%AC%E6%8D%A2%E9%94%99%E8%AF%AF">æ–¹è¨€è½¬æ¢é”™è¯¯</a></li>
<li><a href="#errors">Errors</a></li>
</ul>
</li>
<li><a href="#%E9%93%BE%E5%BC%8F%E6%93%8D%E4%BD%9C1">é“¾å¼æ“ä½œã€1ã€‘</a>
<ul>
<li><a href="#%E6%96%B9%E6%B3%95%E7%B1%BB%E5%88%AB">æ–¹æ³•ç±»åˆ«</a></li>
<li><a href="#%E5%8F%AF%E9%87%8D%E7%94%A8%E6%80%A7%E5%92%8C%E5%AE%89%E5%85%A8%E6%80%A7">å¯é‡ç”¨æ€§å’Œå®‰å…¨æ€§</a></li>
<li><a href="#examples-for-clarity">Examples for Clarity</a></li>
</ul>
</li>
<li><a href="#session2">Sessionã€2ã€‘</a>
<ul>
<li><a href="#dryrun">DryRun</a></li>
<li><a href="#%E9%A2%84%E7%BC%96%E8%AF%91">é¢„ç¼–è¯‘</a></li>
<li><a href="#newdb">NewDB</a></li>
<li><a href="#%E5%88%9D%E5%A7%8B%E5%8C%96">åˆå§‹åŒ–</a></li>
<li><a href="#%E8%B7%B3%E8%BF%87%E9%92%A9%E5%AD%90">è·³è¿‡é’©å­</a></li>
<li><a href="#%E7%A6%81%E7%94%A8%E5%B5%8C%E5%A5%97%E4%BA%8B%E5%8A%A1">ç¦ç”¨åµŒå¥—äº‹åŠ¡</a></li>
<li><a href="#allowglobalupdate">AllowGlobalUpdate</a></li>
<li><a href="#fullsaveassociations">FullSaveAssociations</a></li>
<li><a href="#context">Context</a></li>
<li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89-logger">è‡ªå®šä¹‰ Logger</a></li>
<li><a href="#nowfunc">NowFunc</a></li>
<li><a href="#%E8%B0%83%E8%AF%95">è°ƒè¯•</a></li>
<li><a href="#%E6%9F%A5%E8%AF%A2%E5%AD%97%E6%AE%B5">æŸ¥è¯¢å­—æ®µ</a></li>
<li><a href="#createbatchsize">CreateBatchSize</a></li>
</ul>
</li>
<li><a href="#%E9%92%A9%E5%AD%902">é’©å­ã€2ã€‘</a>
<ul>
<li><a href="#%E5%AF%B9%E8%B1%A1%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F">å¯¹è±¡ç”Ÿå‘½å‘¨æœŸ</a></li>
<li><a href="#hook">Hook</a></li>
<li><a href="#%E4%BF%AE%E6%94%B9%E5%BD%93%E5%89%8D%E6%93%8D%E4%BD%9C">ä¿®æ”¹å½“å‰æ“ä½œ</a></li>
</ul>
</li>
<li><a href="#%E4%BA%8B%E5%8A%A13">äº‹åŠ¡ã€3ã€‘</a>
<ul>
<li><a href="#%E7%A6%81%E7%94%A8%E9%BB%98%E8%AE%A4%E4%BA%8B%E5%8A%A1">ç¦ç”¨é»˜è®¤äº‹åŠ¡</a></li>
<li><a href="#%E4%BA%8B%E5%8A%A1%E7%A4%BA%E4%BE%8B">äº‹åŠ¡ç¤ºä¾‹</a></li>
<li><a href="#%E6%89%8B%E5%8A%A8%E4%BA%8B%E5%8A%A1">æ‰‹åŠ¨äº‹åŠ¡</a></li>
</ul>
</li>
<li><a href="#%E8%BF%81%E7%A7%BB2">è¿ç§»ã€2ã€‘</a>
<ul>
<li><a href="#automigrate">AutoMigrate</a></li>
<li><a href="#migrator-%E6%8E%A5%E5%8F%A3">Migrator æ¥å£</a></li>
<li><a href="#%E7%BA%A6%E6%9D%9F">çº¦æŸ</a></li>
<li><a href="#atlas-integration">Atlas Integration</a></li>
<li><a href="#other-migration-tools">Other Migration Tools</a></li>
</ul>
</li>
<li><a href="#logger1">Loggerã€1ã€‘</a>
<ul>
<li><a href="#%E6%97%A5%E5%BF%97">æ—¥å¿—</a></li>
<li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89logger">è‡ªå®šä¹‰Logger</a></li>
</ul>
</li>
<li><a href="#%E6%80%A7%E8%83%BD2">æ€§èƒ½ã€2ã€‘</a>
<ul>
<li><a href="#%E6%80%A7%E8%83%BD-%E7%A6%81%E7%94%A8%E9%BB%98%E8%AE%A4%E4%BA%8B%E5%8A%A1">æ€§èƒ½-ç¦ç”¨é»˜è®¤äº‹åŠ¡</a></li>
<li><a href="#%E7%BC%93%E5%AD%98%E9%A2%84%E7%BC%96%E8%AF%91%E8%AF%AD%E5%8F%A5">ç¼“å­˜é¢„ç¼–è¯‘è¯­å¥</a></li>
<li><a href="#%E9%80%89%E6%8B%A9%E5%AD%97%E6%AE%B5">é€‰æ‹©å­—æ®µ</a></li>
<li><a href="#%E8%BF%AD%E4%BB%A3-findinbatches">è¿­ä»£ã€FindInBatches</a></li>
<li><a href="#index-hints">Index Hints</a></li>
<li><a href="#%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB">è¯»å†™åˆ†ç¦»</a></li>
</ul>
</li>
<li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B4">è‡ªå®šä¹‰æ•°æ®ç±»å‹ã€4ã€‘</a>
<ul>
<li><a href="#%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%AE%9A%E4%B9%89%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B">å®ç°è‡ªå®šä¹‰æ•°æ®ç±»å‹</a></li>
<li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E9%9B%86%E5%90%88">è‡ªå®šä¹‰æ•°æ®ç±»å‹é›†åˆ</a></li>
</ul>
</li>
<li><a href="#scope3">Scopeã€3ã€‘</a>
<ul>
<li><a href="#scope%E6%9F%A5%E8%AF%A2">ScopeæŸ¥è¯¢</a></li>
<li><a href="#scope%E5%8A%A8%E6%80%81%E8%A1%A8">scopeåŠ¨æ€è¡¨</a></li>
<li><a href="#scope%E6%9B%B4%E6%96%B0">scopeæ›´æ–°</a></li>
</ul>
</li>
<li><a href="#%E7%BA%A6%E5%AE%9A">çº¦å®š</a>
<ul>
<li><a href="#%E4%BD%BF%E7%94%A8-id-%E4%BD%9C%E4%B8%BA%E4%B8%BB%E9%94%AE">ä½¿ç”¨ ID ä½œä¸ºä¸»é”®</a></li>
<li><a href="#%E5%A4%8D%E6%95%B0%E8%A1%A8%E5%90%8D">å¤æ•°è¡¨å</a></li>
<li><a href="#%E5%88%97%E5%90%8D">åˆ—å</a></li>
<li><a href="#%E6%97%B6%E9%97%B4%E6%88%B3%E8%BF%BD%E8%B8%AA">æ—¶é—´æˆ³è¿½è¸ª</a></li>
</ul>
</li>
<li><a href="#%E8%AE%BE%E7%BD%AE">è®¾ç½®</a></li>
</ul>
</li>
<li><a href="#%E9%AB%98%E7%BA%A7%E4%B8%BB%E9%A2%98">é«˜çº§ä¸»é¢˜</a>
<ul>
<li><a href="#database-resolver">Database Resolver</a></li>
<li><a href="#sharding">Sharding</a></li>
<li><a href="#serializer4">Serializerã€4ã€‘</a>
<ul>
<li><a href="#%E6%B3%A8%E5%86%8C%E5%BA%8F%E5%88%97%E5%8C%96%E5%99%A8">æ³¨å†Œåºåˆ—åŒ–å™¨</a></li>
<li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BA%8F%E5%88%97%E5%8C%96%E5%99%A8%E7%B1%BB%E5%9E%8B">è‡ªå®šä¹‰åºåˆ—åŒ–å™¨ç±»å‹</a></li>
</ul>
</li>
<li><a href="#%E7%B4%A2%E5%BC%951">ç´¢å¼•ã€1ã€‘</a>
<ul>
<li><a href="#%E7%B4%A2%E5%BC%95%E6%A0%87%E7%AD%BE">ç´¢å¼•æ ‡ç­¾</a></li>
<li><a href="#%E5%A4%8D%E5%90%88%E7%B4%A2%E5%BC%95">å¤åˆç´¢å¼•</a></li>
<li><a href="#%E5%A4%9A%E7%B4%A2%E5%BC%95">å¤šç´¢å¼•</a></li>
</ul>
</li>
<li><a href="#%E7%BA%A6%E6%9D%9F1">çº¦æŸã€1ã€‘</a>
<ul>
<li><a href="#%E6%A3%80%E6%9F%A5%E7%BA%A6%E6%9D%9F">æ£€æŸ¥çº¦æŸ</a></li>
<li><a href="#%E7%B4%A2%E5%BC%95-%E7%BA%A6%E6%9D%9F">ç´¢å¼• çº¦æŸ</a></li>
<li><a href="#%E5%A4%96%E9%94%AE-%E7%BA%A6%E6%9D%9F">å¤–é”® çº¦æŸ</a></li>
</ul>
</li>
<li><a href="#%E5%A4%8D%E5%90%88%E4%B8%BB%E9%94%AE1">å¤åˆä¸»é”®ã€1ã€‘</a></li>
<li><a href="#%E5%AE%89%E5%85%A8">å®‰å…¨</a></li>
<li><a href="#gorm%E9%85%8D%E7%BD%AE2">GORMé…ç½®ã€2ã€‘</a>
<ul>
<li><a href="#%E8%B7%B3%E8%BF%87%E9%BB%98%E8%AE%A4%E4%BA%8B%E5%8A%A1">è·³è¿‡é»˜è®¤äº‹åŠ¡</a></li>
<li><a href="#%E5%91%BD%E5%90%8D%E7%AD%96%E7%95%A5">å‘½åç­–ç•¥</a></li>
<li><a href="#logger">Logger</a></li>
<li><a href="#owfunc">owFunc</a></li>
<li><a href="#dryrun%E9%85%8D%E7%BD%AE">DryRuné…ç½®</a></li>
<li><a href="#preparestmt">PrepareStmt</a></li>
<li><a href="#%E7%A6%81%E7%94%A8%E5%B5%8C%E5%A5%97%E4%BA%8B%E5%8A%A1%E9%85%8D%E7%BD%AE">ç¦ç”¨åµŒå¥—äº‹åŠ¡é…ç½®</a></li>
<li><a href="#allowglobalupdate%E9%85%8D%E7%BD%AE">AllowGlobalUpdateé…ç½®</a></li>
<li><a href="#disableautomaticping">DisableAutomaticPing</a></li>
<li><a href="#disableforeignkeyconstraintwhenmigrating">DisableForeignKeyConstraintWhenMigrating</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
          
          <div class="comment" style="text-align: center;">
            

            
            
            
            <!-- <script src='https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js'></script> -->
<script src='//unpkg.com/@waline/client@v2/dist/waline.js'></script>
<link href='//unpkg.com/@waline/client@v2/dist/waline.css' rel='stylesheet' />

<!-- <style>
	div#vcomments{
		width:100%;
		max-width: 1000px;
		padding: 2.5%
	}
</style> -->

<!--  -->

	<div id="wcomments"></div>

<script>
	// new Valine({
	Waline.init({
		el: '#wcomments',
		serverURL: 'personal-blog-comments.vercel.app',
		login: 'enable',
		wordLimit: 300,
		pageSize: 10,
		reaction: true,
		
	});
</script>

            
          </div>
        </div>
      </div>
  </article>
  <!-- Footer -->
  <footer>
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
          <ul class="list-inline text-center">
            
            
            <li class="list-inline-item">
              <a href="https://github.com/Jinvic" target="_blank">
                <span class="fa-stack fa-lg">
                  <i class="fas fa-circle fa-stack-2x"></i>
                  <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
            
              
            
              
            
              
            
              
            
              
            
              
            
              
              <!-- <li class="list-inline-item">
              <a href="https://jinvic.github.io/atom.xml" target="_blank">
                <span class="fa-stack fa-lg">
                  <i class="fas fa-circle fa-stack-2x"></i>
                  <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
                </span>
              </a>
              </li> -->
          </ul>
          <p class="copyright text-muted">Copyright &copy;<span>Jinvic&#39;s Blog</span><br><a href="https://github.com/getgridea/gridea" class="Themeinfo">Powered by Gridea</a></p>
        </div>
      </div>
    </div>
   </footer>
  <!-- Bootstrap core JavaScript -->
  <script src="https://cdn.bootcss.com/twitter-bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>
  <!-- <script src="https://jinvic.github.io/media/scripts/bootstrap.bundle.min.js"></script> -->
  <!-- Bootstrap core JavaScript -->
  <script src="https://cdn.jsdelivr.net/gh/Alanrk/clean-cdn@1.0/scripts/clean-blog.min.js"></script>
  <!-- <script src="https://jinvic.github.io/media/scripts/clean-blog.min.js"></script> -->
  <script src="//instant.page/3.0.0" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>
  <style type="text/css">a.back_to_top{text-decoration:none;position:fixed;bottom:40px;right:30px;background:#f0f0f0;height:40px;width:40px;border-radius:50%;line-height:36px;font-size:18px;text-align:center;transition-duration:.5s;transition-propety:background-color;display:none}a.back_to_top span{color:#888}a.back_to_top:hover{cursor:pointer;background:#dfdfdf}a.back_to_top:hover span{color:#555}@media print,screen and(max-width:580px){.back_to_top{display:none!important}}</style>
<a id="back_to_top" href="#" class="back_to_top">
  <span>â–²</span></a>
<script>$(document).ready((function(_this) {
    return function() {
      var bt;
      bt = $('#back_to_top');
      if ($(document).width() > 480) {
        $(window).scroll(function() {
          var st;
          st = $(window).scrollTop();
          if (st > 30) {
            return bt.css('display', 'block')
          } else {
            return bt.css('display', 'none')
          }
        });
        return bt.click(function() {
          $('body,html').animate({
            scrollTop: 0
          },
          800);
          return false
        })
      }
    }
  })(this));</script>
  
  <div id="landlord-parent">
    <div id="landlord">
        <div class="message" style="opacity:0"></div>
        <canvas id="live2d" width="200" height="300" class="live2d"></canvas>
    </div>
</div>

<script type="text/javascript">
    if (/(iPhone|iPad|iPod|iOS|Android)/i.test(navigator.userAgent)) {
        //ç§»åŠ¨ç«¯
        console.log("------ ç§»åŠ¨ç«¯");
    } else {
        console.log("------ PCç«¯ " + navigator.userAgent);

        addScript("https://cdn.jsdelivr.net/gh/850552586/ericamcdn@0.1/js/live2d.js", () => {
            // åŠ è½½å®Œæˆåå†loadlive2d
            loadlive2d("live2d", "https://jinvic.github.io/media/live2d/assets/koharu.model.json");
        });

        var home_Path = "https://jinvic.github.io/";
        addScript("https://jinvic.github.io/media/live2d/js/message.js", () => { });
    }

    // æ’å…¥jsæ–‡ä»¶ï¼Œå®Œæˆåcallback
    function addScript(jsfile, callback) {
        var landlord_parent = document.getElementById("landlord-parent");
        var script = document.createElement("script");
        script.type = "text/javascript";
        script.src = jsfile;
        landlord_parent.appendChild(script);
        script.onload = script.onreadystatechange = function () {
            if (!this.readyState || this.readyState === "loaded" || this.readyState === "complete") {
                script.onload = script.onreadystatechange = null;
                if (callback && typeof callback == "function") {
                    callback(); //window[callback]();å¦‚æœä¼ é€’å­—ç¬¦ä¸²è¿‡æ¥ è°ƒç”¨window['å‡½æ•°å']() è°ƒç”¨æ–¹æ³•
                }
            }
        };
    }
</script>
  
  <script src="https://jinvic.github.io/media/scripts/tocScript.js"></script>
</body>

</html>